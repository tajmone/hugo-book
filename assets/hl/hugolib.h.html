<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>.\hugolib.h</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">!</span>
<span class="hl slc">!           Hugo Library v3.1.03.2 by Kent Tessman (c) 1995-2006</span>
<span class="hl slc">!                     for use with the Hugo Compiler</span>
<span class="hl slc">!</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl ppc">#ifclear _HUGOLIB_H</span>
<span class="hl ppc">#set _HUGOLIB_H</span>

<span class="hl kwa">constant</span> BANNER <span class="hl str">&quot;Hugo v3.1 / Library 31032&quot;</span>
<span class="hl kwa">constant</span> HUGO_VERSION   <span class="hl str">&quot;v3.1&quot;</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! RESERVED PROPERTIES:</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl com">!\ The first 6 are pre-defined by the compiler:</span>
<span class="hl com"></span>
<span class="hl com">property name                           ! property 0:  basic object name</span>
<span class="hl com">property before $additive $complex      ! pre-verb routines</span>
<span class="hl com">property after  $additive $complex      ! post-verb routines</span>
<span class="hl com">property noun                           ! noun(s) for referring to object</span>
<span class="hl com">property adjective                      ! adjective(s) describing object</span>
<span class="hl com">property article                        ! &quot;a&quot;, &quot;an&quot;, &quot;some&quot;, etc.</span>
<span class="hl com">\!</span>

<span class="hl kwa">property</span> nouns <span class="hl kwa">alias</span> <span class="hl kwb">noun</span>               <span class="hl slc">!</span>
<span class="hl kwa">property</span> adjectives <span class="hl kwa">alias</span> <span class="hl kwb">adjective</span>     <span class="hl slc">!</span>
<span class="hl kwa">property</span> preposition                    <span class="hl slc">! &quot;in&quot;, &quot;inside&quot;, &quot;outside of&quot;, etc.</span>
<span class="hl kwa">property</span> prep <span class="hl kwa">alias</span> preposition         <span class="hl slc">!</span>
<span class="hl kwa">property</span> pronoun <span class="hl str">&quot;it&quot;</span>                   <span class="hl slc">! &quot;he&quot;, &quot;him&quot;, &quot;his&quot;, &quot;himself&quot;</span>
<span class="hl kwa">property</span> pronouns <span class="hl kwa">alias</span> pronoun         <span class="hl slc">!   (or equivalent)</span>
<span class="hl kwa">property</span> react_before                   <span class="hl slc">! to allow reaction by an object that</span>
<span class="hl kwa">property</span> react_after                    <span class="hl slc">!   is not directly involved</span>
<span class="hl kwa">property</span> short_desc                     <span class="hl slc">! basic &quot;X is here&quot; description</span>
<span class="hl kwa">property</span> initial_desc                   <span class="hl slc">! same as above, before obj. is moved</span>
<span class="hl kwa">property</span> long_desc                      <span class="hl slc">! detailed description</span>
<span class="hl kwa">property</span> found_in                       <span class="hl slc">! in case of multiple parents</span>
<span class="hl kwa">property</span> type                           <span class="hl slc">! to identify the type of object</span>
<span class="hl kwa">property</span> size <span class="hl num">10</span>                        <span class="hl slc">! for holding/inventory purposes</span>
<span class="hl kwa">property</span> capacity                       <span class="hl slc">!  &quot;          &quot;            &quot;</span>
<span class="hl kwa">property</span> holding                        <span class="hl slc">!  &quot;          &quot;            &quot;</span>
<span class="hl kwa">property</span> reach                          <span class="hl slc">! for limiting accessible objects</span>
<span class="hl kwa">property</span> list_contents                  <span class="hl slc">! to override normal listing routine</span>
<span class="hl kwa">property</span> in_scope                       <span class="hl slc">! actor(s) which can access an object</span>
<span class="hl kwa">property</span> parse_rank                     <span class="hl slc">! for matching similarly named objects</span>
<span class="hl kwa">property</span> exclude_from_all               <span class="hl slc">! i.e., exclude from multi-obj. verbs</span>
<span class="hl kwa">property</span> door_to                        <span class="hl slc">! for handling &quot;Enter &lt;object&gt;&quot;</span>

<span class="hl slc">! The following are used only for room objects:</span>
<span class="hl kwa">property</span> n_to                           <span class="hl slc">!</span>
<span class="hl kwa">property</span> ne_to                          <span class="hl slc">!</span>
<span class="hl kwa">property</span> e_to                           <span class="hl slc">!</span>
<span class="hl kwa">property</span> se_to                          <span class="hl slc">!</span>
<span class="hl kwa">property</span> s_to                           <span class="hl slc">! If the player can move from one</span>
<span class="hl kwa">property</span> sw_to                          <span class="hl slc">! room to another in direction X,</span>
<span class="hl kwa">property</span> w_to                           <span class="hl slc">! X_to holds the object number of the</span>
<span class="hl kwa">property</span> nw_to                          <span class="hl slc">! second room.</span>
<span class="hl kwa">property</span> u_to                           <span class="hl slc">!</span>
<span class="hl kwa">property</span> d_to                           <span class="hl slc">!</span>
<span class="hl kwa">property</span> in_to                          <span class="hl slc">!</span>
<span class="hl kwa">property</span> out_to                         <span class="hl slc">!</span>
<span class="hl kwa">property</span> cant_go                        <span class="hl slc">! message if a move is invalid</span>
<span class="hl kwa">property</span> extra_scenery                  <span class="hl slc">! unimportant words/objects in desc.</span>
<span class="hl kwa">property</span> each_turn                      <span class="hl slc">! a routine called each turn</span>

<span class="hl slc">! The following are used only for non-room objects:</span>
<span class="hl kwa">property</span> key_object <span class="hl kwa">alias</span> ne_to         <span class="hl slc">! if lockable, what is the key?</span>
<span class="hl kwa">property</span> when_open <span class="hl kwa">alias</span> e_to           <span class="hl slc">! desc. for openable objects</span>
<span class="hl kwa">property</span> when_closed <span class="hl kwa">alias</span> se_to        <span class="hl slc">!   &quot;    &quot;     &quot;        &quot;</span>
<span class="hl kwa">property</span> ignore_response <span class="hl kwa">alias</span> s_to     <span class="hl slc">! for unfriendly characters</span>
<span class="hl kwa">property</span> order_response <span class="hl kwa">alias</span> sw_to     <span class="hl slc">! for giving orders to characters</span>
<span class="hl kwa">property</span> contains_desc <span class="hl kwa">alias</span> w_to       <span class="hl slc">! instead of &quot;X contains...&quot;, etc.</span>
<span class="hl kwa">property</span> inv_desc <span class="hl kwa">alias</span> nw_to           <span class="hl slc">! for inventory listing only</span>
<span class="hl kwa">property</span> desc_detail <span class="hl kwa">alias</span> u_to         <span class="hl slc">! parenthetical detail (ObjectIs)</span>

<span class="hl kwa">property</span> misc                           <span class="hl slc">! miscellaneous use</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! RESERVED ATTRIBUTES:</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">attribute</span> known                         <span class="hl slc">! set once an object is known about</span>
<span class="hl kwa">attribute</span> moved                         <span class="hl slc">!  &quot;  once an object is moved</span>
<span class="hl kwa">attribute</span> visited <span class="hl kwa">alias</span> moved           <span class="hl slc">!  &quot;  once a room is visited</span>
<span class="hl kwa">attribute</span> static                        <span class="hl slc">!  &quot;  when object cannot be taken</span>
<span class="hl kwa">attribute</span> plural                        <span class="hl slc">!  &quot;  for plural objects</span>
<span class="hl kwa">attribute</span> living                        <span class="hl slc">!  &quot;  if object is a character</span>
<span class="hl kwa">attribute</span> female                        <span class="hl slc">!  &quot;  if character is female</span>
<span class="hl kwa">attribute</span> openable                      <span class="hl slc">!  &quot;  if object can be opened</span>
<span class="hl kwa">attribute</span> open                          <span class="hl slc">!  &quot;  if object is open</span>
<span class="hl kwa">attribute</span> lockable                      <span class="hl slc">!  &quot;  if object can be locked</span>
<span class="hl kwa">attribute</span> locked                        <span class="hl slc">!  &quot;  if object is locked</span>
<span class="hl kwa">attribute</span> unfriendly                    <span class="hl slc">! for characters</span>
<span class="hl kwa">attribute</span> light                         <span class="hl slc">! set if an object is/provides light</span>
<span class="hl kwa">attribute</span> readable                      <span class="hl slc">!  &quot;  if object can be read</span>
<span class="hl kwa">attribute</span> switchable                    <span class="hl slc">!  &quot;  if object can be turned on/off</span>
<span class="hl kwa">attribute</span> switchedon                    <span class="hl slc">!  &quot;  if object is on</span>
<span class="hl kwa">attribute</span> active <span class="hl kwa">alias</span> switchedon       <span class="hl slc">! generally for fuses/daemons</span>
<span class="hl kwa">attribute</span> clothing                      <span class="hl slc">! set if object can be worn</span>
<span class="hl kwa">attribute</span> worn                          <span class="hl slc">!  &quot;  if object is being worn</span>
<span class="hl kwa">attribute</span> mobile <span class="hl kwa">alias</span> worn             <span class="hl slc">!  &quot;  if object may be moved around</span>
<span class="hl kwa">attribute</span> enterable                     <span class="hl slc">!  &quot;  if object may be entered</span>
<span class="hl kwa">attribute</span> container                     <span class="hl slc">!  &quot;  if things can be placed IN obj.</span>
<span class="hl kwa">attribute</span> platform                      <span class="hl slc">!  &quot;  if things can be placed ON obj.</span>
                                        <span class="hl slc">!     (&quot;container&quot; and &quot;platform&quot; are</span>
                                        <span class="hl slc">!      mutually exclusive)</span>
<span class="hl kwa">attribute</span> hidden                        <span class="hl slc">!  &quot;  if object isn&#39;t listed</span>
<span class="hl kwa">attribute</span> quiet                         <span class="hl slc">!  &quot;  if container/platform is quiet</span>
                                        <span class="hl slc">!     (contents not initially listed)</span>
<span class="hl kwa">attribute</span> transparent                   <span class="hl slc">!  &quot;  if object is not opaque</span>

<span class="hl kwa">attribute</span> workflag                      <span class="hl slc">! for library use</span>
<span class="hl kwa">attribute</span> already_listed <span class="hl kwa">alias</span> workflag

<span class="hl kwa">attribute</span> special                       <span class="hl slc">! for miscellaneous use</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! RESERVED GLOBALS:</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl com">!\ The first 12 are pre-defined by the compiler:</span>
<span class="hl com"></span>
<span class="hl com">global object                           ! direct object of a verb action</span>
<span class="hl com">global xobject                          ! indirect object</span>
<span class="hl com">global self                             ! self-referential object</span>
<span class="hl com">global words                            ! total number of words</span>
<span class="hl com">global player                           ! the player object</span>
<span class="hl com">global actor                            ! player, or a char. (for scripts)</span>
<span class="hl com">global location                         ! location of the player object</span>
<span class="hl com">global verbroutine                      ! the verb routine</span>
<span class="hl com">global endflag                          ! if non-false, run EndGame</span>
<span class="hl com">global prompt                           ! for input line</span>
<span class="hl com">global objects                          ! total number of objects</span>
<span class="hl com">global system_status                    ! after certain operations</span>
<span class="hl com">\!</span>

<span class="hl kwa">global</span> player_person <span class="hl opt">=</span> <span class="hl num">2</span>                <span class="hl slc">! 1=first, 2=second, 3=third</span>

<span class="hl kwa">global</span> MAX_SCORE                        <span class="hl slc">! total possible score</span>
<span class="hl kwa">global</span> FORMAT                           <span class="hl slc">! contains bitmap of format masks</span>
<span class="hl kwa">global</span> DEFAULT_FONT                     <span class="hl slc">! 0=monospaced normal text</span>
<span class="hl kwa">global</span> STATUSTYPE                       <span class="hl slc">! 0=none, 1=score/turns, 2=time</span>
<span class="hl kwa">global</span> UNDO_OFF                         <span class="hl slc">! overrides undo when true</span>

<span class="hl kwa">global</span> counter                          <span class="hl slc">! elapsed turns (or time, as desired)</span>
<span class="hl kwa">global</span> score                            <span class="hl slc">! accumulated score</span>
<span class="hl kwa">global</span> verbosity                        <span class="hl slc">! for room descriptions</span>
<span class="hl kwa">global</span> list_nest                        <span class="hl slc">! used by ListObjects</span>
<span class="hl kwa">global</span> light_source                     <span class="hl slc">! in location</span>
<span class="hl kwa">global</span> event_flag                       <span class="hl slc">! set when something happens</span>
<span class="hl kwa">global</span> speaking                         <span class="hl slc">! if the player is talking to a char.</span>
<span class="hl kwa">global</span> old_location                     <span class="hl slc">! whenever location changes</span>
<span class="hl kwa">global</span> last_object                      <span class="hl slc">! set by Perform to object global</span>
<span class="hl kwa">global</span> obstacle                         <span class="hl slc">! if something is stopping the player</span>
<span class="hl kwa">global</span> list_count                       <span class="hl slc">! number of unlisted objects</span>
<span class="hl kwa">global</span> need_newline                     <span class="hl slc">! true when newline should be printed</span>
<span class="hl kwa">global</span> override_indent                  <span class="hl slc">! true if no indent should be printed</span>
<span class="hl kwa">global</span> customerror_flag                 <span class="hl slc">! true after CustomError is called</span>

<span class="hl kwa">array</span> parser_data[<span class="hl num">5</span>]
<span class="hl slc">! parser_data elements:</span>
<span class="hl kwa">constant</span> PARSER_STATUS       <span class="hl num">0</span>          <span class="hl slc">! PARSER_STATUS mask</span>
<span class="hl kwa">constant</span> LAST_PARSER_STATUS  <span class="hl num">1</span>
<span class="hl kwa">constant</span> BEST_PARSE_RANK     <span class="hl num">2</span>          <span class="hl slc">! for matching similarly named objects</span>
<span class="hl kwa">constant</span> PARSE_RANK_TESTS    <span class="hl num">3</span>          <span class="hl slc">! counter</span>
<span class="hl kwa">constant</span> LAST_SINGLE_OBJECT  <span class="hl num">4</span>          <span class="hl slc">! for next-turn disambiguation</span>
<span class="hl kwa">constant</span> VERB_IS_XVERB       <span class="hl num">5</span>          <span class="hl slc">! for this call to Perform()</span>

<span class="hl ppc">#ifclear NO_SCRIPTS</span>
<span class="hl kwa">constant</span> MAX_SCRIPTS      <span class="hl num">16</span>            <span class="hl slc">!</span>
<span class="hl kwa">constant</span> MAX_SCRIPT_STEPS <span class="hl num">32</span>            <span class="hl slc">!</span>
<span class="hl kwa">global</span> number_scripts                   <span class="hl slc">! for object scripts</span>
<span class="hl kwa">array</span> scriptdata[<span class="hl num">48</span>]                    <span class="hl slc">!</span>
<span class="hl kwa">array</span> setscript[<span class="hl num">1024</span>]                   <span class="hl slc">!</span>
<span class="hl ppc">#endif</span>

<span class="hl kwa">global</span> MAX_RANK                         <span class="hl slc">! allow for up to 10 levels of</span>
<span class="hl kwa">array</span> ranking[<span class="hl num">10</span>]                       <span class="hl slc">! player ranking (as a default)</span>

<span class="hl kwa">global</span> it_obj                           <span class="hl slc">!</span>
<span class="hl kwa">global</span> them_obj                         <span class="hl slc">!</span>
<span class="hl kwa">global</span> him_obj                          <span class="hl slc">! to reference objects via pronouns</span>
<span class="hl kwa">global</span> her_obj                          <span class="hl slc">!</span>
<span class="hl kwa">array</span> replace_pronoun[<span class="hl num">4</span>]                <span class="hl slc">!</span>

<span class="hl kwa">constant</span> MAX_WORDS <span class="hl num">32</span>                   <span class="hl slc">! in a parsed input line</span>
<span class="hl kwa">array</span> oldword[MAX_WORDS]                <span class="hl slc">! for &quot;again&quot; command</span>

<span class="hl kwa">global</span> general                          <span class="hl slc">! for general use</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! COLOR CONSTANTS AND GLOBALS</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">enumerate</span>                               <span class="hl slc">! colors 0 to 17</span>
{
        BLACK, BLUE, GREEN, CYAN, RED, MAGENTA, BROWN, WHITE,
        DARK_GRAY, LIGHT_BLUE, LIGHT_GREEN, LIGHT_CYAN,
        LIGHT_RED, LIGHT_MAGENTA, YELLOW, BRIGHT_WHITE,
        DEF_FOREGROUND, DEF_BACKGROUND,
        DEF_SL_FOREGROUND, DEF_SL_BACKGROUND,
        MATCH_FOREGROUND
}

<span class="hl kwa">global</span> TEXTCOLOR        <span class="hl opt">=</span> DEF_FOREGROUND        <span class="hl slc">! normal text color</span>
<span class="hl kwa">global</span> BGCOLOR          <span class="hl opt">=</span> DEF_BACKGROUND        <span class="hl slc">! normal background color</span>
<span class="hl kwa">global</span> SL_TEXTCOLOR     <span class="hl opt">=</span> DEF_SL_FOREGROUND     <span class="hl slc">! statusline text color</span>
<span class="hl kwa">global</span> SL_BGCOLOR       <span class="hl opt">=</span> DEF_SL_BACKGROUND     <span class="hl slc">! statusline background color</span>
<span class="hl kwa">global</span> INPUTCOLOR       <span class="hl opt">=</span> MATCH_FOREGROUND      <span class="hl slc">! input color</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! PARSER STATUS</span>
<span class="hl slc">!</span>
<span class="hl slc">! For parser_data[PARSER_STATUS].  Mask must be reset in Parse, as well as</span>
<span class="hl slc">! after Perform and ParseError.</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl kwa">enumerate</span> <span class="hl kwa">step</span> <span class="hl opt">*</span><span class="hl num">2</span>
{
        PARSER_RESET,           <span class="hl slc">! 0, for reset</span>
        PARSER_ACTIVE <span class="hl opt">=</span> <span class="hl num">1</span>,
        PRONOUNS_SET,           <span class="hl slc">! if &quot;it&quot;, etc. are used</span>
        FINDOBJECT_KNOWN,       <span class="hl slc">! if FindObject() encounters a &#39;known&#39; object</span>
        FINDOBJECT_NONLIVING,   <span class="hl slc">! if a nonliving object is encountered</span>
        PERFORM_QUEUE           <span class="hl slc">! one of multiple calls to Perform()</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! PRINTING FORMAT MASKS</span>
<span class="hl slc">!</span>
<span class="hl slc">! The following are bitmasks added/subtracted from the FORMAT global</span>
<span class="hl slc">! to affect text/list output.  Combine formats using &#39;+&#39; or &#39;|&#39; as in:</span>
<span class="hl slc">!</span>
<span class="hl slc">!       FORMAT = LIST_F | GROUPPLURALS_F | ...</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">enumerate</span> <span class="hl kwa">start</span> <span class="hl opt">=</span> <span class="hl num">1</span>, <span class="hl kwa">step</span> <span class="hl opt">*</span><span class="hl num">2</span>
{
        LIST_F                  <span class="hl slc">! print itemized lists, not sentences</span>
        NORECURSE_F             <span class="hl slc">! do not recurse object contents</span>
        NOINDENT_F              <span class="hl slc">! do not indent listings</span>
        DESCFORM_F              <span class="hl slc">! alternate room desc. formatting</span>
        GROUPPLURALS_F          <span class="hl slc">! list plurals together where possible</span>
        NOPARENTHESES_F         <span class="hl slc">! ignore printing by ObjectIs</span>

<span class="hl slc">! For internal (library) use:</span>

        INVENTORY_F             <span class="hl slc">! list as player inventory</span>
        FIRSTCAPITAL_F          <span class="hl slc">! capitalize first article</span>
        ISORARE_F               <span class="hl slc">! print &quot;is&quot; or &quot;are&quot; at the start</span>
        ISORAREHERE_F           <span class="hl slc">! print &quot;is here&quot; or &quot;are here&quot; last</span>
        USECHARNAMES_F          <span class="hl slc">! before listing contents</span>
        TEMPLIST_F              <span class="hl slc">! used if LIST_F must be overridden</span>
}

<span class="hl kwa">global</span> INVENTORY_MASK <span class="hl opt">=</span> <span class="hl num">0</span>       <span class="hl slc">! may be set by DoInventory</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! FONT STYLE BITMASKS</span>
<span class="hl slc">!</span>
<span class="hl slc">! Used with the Font routine to set or change the font style.  Combine</span>
<span class="hl slc">! settings using &#39;+&#39; or &#39;|&#39;, as in:</span>
<span class="hl slc">!</span>
<span class="hl slc">!       Font(BOLD_ON | ITALIC_OFF | ...)</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">enumerate</span> <span class="hl kwa">start</span> <span class="hl opt">=</span> <span class="hl num">1</span>, <span class="hl kwa">step</span> <span class="hl opt">*</span><span class="hl num">2</span>
{
        BOLD_ON, BOLD_OFF,
        ITALIC_ON, ITALIC_OFF,
        UNDERLINE_ON, UNDERLINE_OFF,

        PROP_ON, PROP_OFF               <span class="hl slc">! proportional printing</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ADDITIONAL CONSTANTS (AND GLOBALS)</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">constant</span> UP_ARROW       <span class="hl num">11</span>              <span class="hl slc">! special keystrokes</span>
<span class="hl kwa">constant</span> DOWN_ARROW     <span class="hl num">10</span>
<span class="hl kwa">constant</span> LEFT_ARROW      <span class="hl num">8</span>
<span class="hl kwa">constant</span> RIGHT_ARROW    <span class="hl num">21</span>
<span class="hl kwa">constant</span> ESCAPE_KEY     <span class="hl num">27</span>
<span class="hl kwa">constant</span> ENTER_KEY      <span class="hl num">13</span>
<span class="hl kwa">constant</span> MOUSE_CLICK     <span class="hl num">1</span>

<span class="hl kwa">constant</span> AND_WORD       <span class="hl str">&quot;and&quot;</span>           <span class="hl slc">! for language translation</span>
<span class="hl kwa">constant</span> ARE_WORD       <span class="hl str">&quot;are&quot;</span>
<span class="hl kwa">constant</span> HERE_WORD      <span class="hl str">&quot;here&quot;</span>
<span class="hl kwa">constant</span> IN_WORD        <span class="hl str">&quot;in&quot;</span>
<span class="hl kwa">constant</span> IS_WORD        <span class="hl str">&quot;is&quot;</span>
<span class="hl kwa">constant</span> ON_WORD        <span class="hl str">&quot;on&quot;</span>

<span class="hl kwa">constant</span> FILE_CHECK     <span class="hl num">4660</span>            <span class="hl slc">! for readfile/writefile blocks</span>

<span class="hl ppc">#if undefined INDENT_SIZE</span>
<span class="hl kwa">constant</span> INDENT_SIZE <span class="hl num">2</span>                  <span class="hl slc">! for paragraph formatting</span>
<span class="hl ppc">#endif</span>
<span class="hl ppc">#if undefined AFTER_PERIOD</span>
<span class="hl kwa">constant</span> AFTER_PERIOD  <span class="hl str">&quot;  &quot;</span>             <span class="hl slc">! double-space after period</span>
<span class="hl ppc">#endif</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! SYNONYMS, COMPOUNDS, AND REMOVALS</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">synonym</span> <span class="hl str">&quot;and&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~and&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;except&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~except&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;but&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~except&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;all&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~all&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;everything&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~all&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;any&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~any&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;either&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~any&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;oops&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~oops&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;o&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;~oops&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;mine&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;my&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;myself&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;me&quot;</span>
<span class="hl ppc">#ifset NO_OBJLIB</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;herself&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;her&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;himself&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;him&quot;</span>
<span class="hl kwa">synonym</span> <span class="hl str">&quot;themselves&quot;</span> <span class="hl kwa">for</span> <span class="hl str">&quot;them&quot;</span>
<span class="hl ppc">#endif</span>

<span class="hl kwa">compound</span> <span class="hl str">&quot;mr&quot;</span>, <span class="hl str">&quot;.&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;mrs&quot;</span>, <span class="hl str">&quot;.&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;dr&quot;</span>, <span class="hl str">&quot;.&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;st&quot;</span>, <span class="hl str">&quot;.&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;off&quot;</span>, <span class="hl str">&quot;of&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;out&quot;</span>, <span class="hl str">&quot;of&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;on&quot;</span>, <span class="hl str">&quot;to&quot;</span>
<span class="hl kwa">compound</span> <span class="hl str">&quot;in&quot;</span>, <span class="hl str">&quot;to&quot;</span>

<span class="hl kwa">removal</span> <span class="hl str">&quot;a&quot;</span>, <span class="hl str">&quot;an&quot;</span>, <span class="hl str">&quot;the&quot;</span>, <span class="hl str">&quot;some&quot;</span>, <span class="hl str">&quot;of&quot;</span>


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl kwb">object</span> nothing <span class="hl str">&quot;nothing&quot;</span>                <span class="hl slc">! OBJECT 0:  the great granddaddy</span>
{}

<span class="hl kwa">enumerate</span> <span class="hl kwa">start</span> <span class="hl opt">=</span> <span class="hl num">1</span>, <span class="hl kwa">step</span> <span class="hl num">1</span>
{
        screenwidth, screenheight,      <span class="hl slc">! built-in display object read-only</span>
        linelength, windowlines,        <span class="hl slc">! properties</span>
        cursor_column, cursor_row,
        hasgraphics, title_caption,
        hasvideo, needs_repaint,
        pointer_x, pointer_y
}

<span class="hl kwa">property</span> statusline_height <span class="hl kwa">alias</span> n_to   <span class="hl slc">! library-specific display object</span>
                                        <span class="hl slc">! properties</span>

<span class="hl kwb">object</span> display
{
        statusline_height <span class="hl num">1</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! EndGame(end_type)</span>
<span class="hl slc">! called by the engine via EndGame(end_type) when endflag is not false</span>
<span class="hl slc">! (endflag is cleared previous to calling); return false to terminate</span>
<span class="hl slc">!</span>
<span class="hl slc">! Default responses (in PrintEndGame):  1 = win, 2 = die, 0 = no response</span>

<span class="hl kwa">routine</span> EndGame(end_type)
{
        PrintStatusLine                 <span class="hl slc">! update one last time</span>
        PrintEndGame(end_type)          <span class="hl slc">! print appropriate ending message</span>

<span class="hl ppc">#ifclear NO_VERBS</span>
        <span class="hl kwa">local</span> r

:AskAgain

        Message(<span class="hl opt">&amp;</span>EndGame, <span class="hl num">1</span>)    <span class="hl slc">! ask to RESTART, RESTORE, (UNDO), or QUIT</span>

        r <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>

        <span class="hl kwa">while</span> <span class="hl kwc">true</span>
        {
                GetInput
                <span class="hl kwa">select</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>]
                        <span class="hl kwa">case</span> <span class="hl str">&quot;restart&quot;</span>, <span class="hl str">&quot;r&quot;</span>
                        {
                                <span class="hl kwa">if</span> <span class="hl kwa">restart</span>
                                {
                                        r <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                        PrintStatusline
                                }
<span class="hl ppc">#ifclear NO_XVERBS</span>
                                <span class="hl kwa">else</span>
                                        Message(<span class="hl opt">&amp;</span>DoRestart, <span class="hl num">2</span>)   <span class="hl slc">! failed</span>
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">break</span>
                        }
                        <span class="hl kwa">case</span> <span class="hl str">&quot;restore&quot;</span>, <span class="hl str">&quot;e&quot;</span>
                        {
<span class="hl ppc">#ifclear NO_XVERBS</span>
                                r <span class="hl opt">=</span> Perform(<span class="hl opt">&amp;</span>DoRestore)
<span class="hl ppc">#else</span>
                                <span class="hl kwa">if</span> <span class="hl kwa">restore</span>
                                {
                                        r <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                        PrintStatusline
                                        DescribePlace(<span class="hl kwb">location</span>)
                                }
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">break</span>
                        }
<span class="hl ppc">#ifclear NO_UNDO</span>
                        <span class="hl kwa">case</span> <span class="hl str">&quot;undo&quot;</span>, <span class="hl str">&quot;u&quot;</span>
                        {
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> UNDO_OFF
                                {
                                        <span class="hl kwa">if</span> <span class="hl kwa">undo</span>
                                        {
                                                r <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                                PrintStatusLine
                                                DescribePlace(<span class="hl kwb">location</span>)
                                        }
<span class="hl ppc">#ifclear NO_XVERBS</span>
                                        <span class="hl kwa">else</span>
                                                Message(<span class="hl opt">&amp;</span>DoUndo, <span class="hl num">1</span>)  <span class="hl slc">! failed</span>
                                }
                                <span class="hl kwa">else</span>
                                        Message(<span class="hl opt">&amp;</span>DoUndo, <span class="hl num">1</span>)
<span class="hl ppc">#else</span>
                                }
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">break</span>
                        }
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">case</span> <span class="hl str">&quot;quit&quot;</span>, <span class="hl str">&quot;q&quot;</span>
                        {
                                r <span class="hl opt">=</span> <span class="hl num">0</span>
                                <span class="hl kwa">break</span>
                        }

                Message(<span class="hl opt">&amp;</span>EndGame, <span class="hl num">2</span>)    <span class="hl slc">! ask again (more succinctly)</span>
        }

        <span class="hl kwa">if</span> r <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>:  <span class="hl kwa">jump</span> AskAgain

        <span class="hl kwa">return</span> r

<span class="hl ppc">#else</span>   <span class="hl slc">! i.e., #elseif set NO_VERBS</span>
<span class="hl ppc"></span>
        <span class="hl kwa">return</span> <span class="hl num">0</span>;
<span class="hl ppc">#endif</span>
}

<span class="hl kwa">routine</span> PrintEndGame(end_type)
{
        Font(BOLD_ON)
        <span class="hl kwa">select</span> end_type
                <span class="hl kwa">case</span> <span class="hl num">1</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">*** YOU&#39;VE WON THE GAME! ***&quot;</span>
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                {
                        <span class="hl kwa">if</span> player_person <span class="hl opt">=</span> <span class="hl num">2</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">*** YOU HAVE DIED ***&quot;</span>
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">*** &quot;</span>; CThe(<span class="hl kwb">player</span>); \
                                        MatchPlural(<span class="hl kwb">player</span>, <span class="hl str">&quot;has&quot;</span>, <span class="hl str">&quot;have&quot;</span>); \
                                        <span class="hl str">&quot; died! ***&quot;</span>
                }

        Font(BOLD_OFF)
        PrintScore(<span class="hl kwc">true</span>)
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl kwa">routine</span> PrintScore(end_of_game)
{
        <span class="hl kwa">if</span> STATUSTYPE <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> MAX_SCORE
        {
                <span class="hl kwa">if</span> end_of_game:  <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;You &quot;</span>;
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> end_of_game
                        <span class="hl kwa">print</span> <span class="hl str">&quot;have &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;scored a total of &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl kwa">number</span> score; <span class="hl str">&quot; out of &quot;</span>; <span class="hl kwa">number</span> MAX_SCORE;
                <span class="hl kwa">if</span> ranking[<span class="hl num">0</span>] <span class="hl opt">~=</span> <span class="hl str">&quot;&quot;</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;, giving you the rank of &quot;</span>;

                        <span class="hl slc">! A complicated formula, since only</span>
                        <span class="hl slc">! integer division is allowed:</span>
                        <span class="hl slc">!</span>
                        <span class="hl kwa">print</span> ranking[(score<span class="hl opt">*</span><span class="hl num">100</span>)<span class="hl opt">/</span>MAX_SCORE<span class="hl opt">*</span>MAX_RANK<span class="hl opt">/</span><span class="hl num">100</span>]
                }
                <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Parse is called by the engine without parameters after input but before</span>
<span class="hl slc">! any grammar matching; returning true signals the engine to reparse the</span>
<span class="hl slc">! existing input (in case it has been changed)</span>
<span class="hl slc">!</span>
<span class="hl slc">! The engine parser is responsible for splitting the input line into the</span>
<span class="hl slc">! word[] array, removing removals, replacing synonyms, and combining</span>
<span class="hl slc">! compounds.</span>
<span class="hl slc">!</span>
<span class="hl slc">! This Parse routine is then called to take care of:</span>
<span class="hl slc">!       - picking out extra_scenery words</span>
<span class="hl slc">!       - checking for an &quot;again&quot; command</span>
<span class="hl slc">!       - rewording imperatives to &quot;&lt;Name&gt;, &lt;command&gt;&quot;</span>
<span class="hl slc">!       - renaming pronouns to objects</span>
<span class="hl slc">!       - changing &quot;then &lt;do something else&gt;&quot; into a new command</span>
<span class="hl slc">!</span>
<span class="hl slc">! Control then returns to the engine for grammar matching and, if that is</span>
<span class="hl slc">! successful, calling of the matched verb routine.</span>

<span class="hl slc">! NOTE:  There are some snags with the object-based pronoun replacement</span>
<span class="hl slc">! system (such as, for example, requiring a specific object in grammar)</span>
<span class="hl slc">! so OLD_STYLE_PRONOUNS are still being used.</span>
<span class="hl ppc">#set OLD_STYLE_PRONOUNS</span>

<span class="hl ppc">#ifclear OLD_STYLE_PRONOUNS</span>
<span class="hl slc">! If OLD_STYLE_PRONOUNS is set, the Parse routine will actually change</span>
<span class="hl slc">! the input line by inserting the object name.  This is a different</span>
<span class="hl slc">! approach using actual stand-in objects.</span>
<span class="hl kwb">object</span> it_object <span class="hl str">&quot;it&quot;</span>
{
        <span class="hl kwa">is</span> known, hidden
        nouns <span class="hl str">&quot;it&quot;</span>
        misc { <span class="hl kwa">return</span> it_obj }
        parse_rank <span class="hl num">1000</span>
        found_in
        {
                <span class="hl kwa">local</span> obj
                obj <span class="hl opt">=</span> <span class="hl kwb">self</span>.misc
                <span class="hl kwa">if</span> FindObject(obj, <span class="hl kwb">location</span>)
                        <span class="hl kwa">return</span> <span class="hl kwa">parent</span>(obj)
                <span class="hl kwa">else</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
        }
}

it_object him_object <span class="hl str">&quot;him&quot;</span>
{
        nouns <span class="hl str">&quot;him&quot;</span>
        misc { <span class="hl kwa">return</span> him_obj }
}

it_object her_object <span class="hl str">&quot;her&quot;</span>
{
        nouns <span class="hl str">&quot;her&quot;</span>
        misc { <span class="hl kwa">return</span> her_obj }
}

it_object them_object <span class="hl str">&quot;them&quot;</span>
{
        nouns <span class="hl str">&quot;them&quot;</span>
        misc { <span class="hl kwa">return</span> them_obj }
}
<span class="hl ppc">#endif</span>  <span class="hl slc">! OLD_STYLE_PRONOUNS</span>
<span class="hl ppc"></span>
<span class="hl kwa">routine</span> Parse
{
        <span class="hl kwa">local</span> a
        <span class="hl kwa">local</span> reparse
        <span class="hl kwa">local</span> temp_verb, temp_obj, temp_xobj

        ResetParse

        list_nest <span class="hl opt">=</span> <span class="hl num">0</span>
        event_flag <span class="hl opt">=</span> <span class="hl num">0</span>

        <span class="hl kwa">if</span> nothing <span class="hl opt">~=</span> <span class="hl num">0</span>                   <span class="hl slc">! best place to check this</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;[WARNING:  Objects/classes defined before library]&quot;</span>

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = 0]&quot;</span>
        }
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifclear OLD_STYLE_PRONOUNS</span>
        <span class="hl slc">! Only need to set up all attributes once, so that a given</span>
        <span class="hl slc">! pronoun will satisfy any grammatical attribute requirements</span>
        <span class="hl kwa">if</span> it_object <span class="hl kwa">is</span> <span class="hl kwa">not</span> <span class="hl num">127</span>
        {
                <span class="hl kwa">local</span> i
                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">0</span>; i<span class="hl opt">&lt;</span><span class="hl num">128</span>; i<span class="hl opt">++</span>)
                {
                        it_object <span class="hl kwa">is</span> i
                        him_object <span class="hl kwa">is</span> i
                        her_object <span class="hl kwa">is</span> i
                        them_object <span class="hl kwa">is</span> i
                }
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;~oops&quot;</span>
                <span class="hl kwa">return</span>

        <span class="hl slc">! Allow the player object to override the parsing cycle completely</span>
        temp_verb <span class="hl opt">=</span> <span class="hl kwb">verbroutine</span>
        temp_obj <span class="hl opt">=</span> <span class="hl kwb">object</span>
        temp_xobj <span class="hl opt">=</span> <span class="hl kwb">xobject</span>
        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>PreParse
        <span class="hl kwb">object</span> <span class="hl opt">=</span> nothing
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> nothing
        <span class="hl kwa">if</span> <span class="hl kwb">player</span>.<span class="hl kwb">before</span>
        {
                <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> temp_verb
                <span class="hl kwb">object</span> <span class="hl opt">=</span> temp_obj
                <span class="hl kwb">xobject</span> <span class="hl opt">=</span> temp_xobj
                parser_data[PARSER_STATUS] <span class="hl opt">=</span> <span class="hl num">0</span>
                parser_data[LAST_PARSER_STATUS] <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
        }
        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> temp_verb
        <span class="hl kwb">object</span> <span class="hl opt">=</span> temp_obj
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> temp_xobj

<span class="hl slc">! The following, devised by Jim Newland, checks to see if the player</span>
<span class="hl slc">! input refers to an unnecessary item of scenery (for example) which is</span>
<span class="hl slc">! nonetheless mentioned in the location description.</span>

        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">2</span>; a<span class="hl opt">&lt;=</span><span class="hl kwb">words</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[a]<span class="hl opt">~=</span><span class="hl str">&quot;&quot;</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[a]<span class="hl opt">~=</span><span class="hl str">&quot;then&quot;</span>; a<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> Inlist(<span class="hl kwb">location</span>, extra_scenery, <span class="hl kwa">word</span>[a])
                {
                        Message(<span class="hl opt">&amp;</span>Parse, <span class="hl num">1</span>)
                        <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>            <span class="hl slc">! force ParseError(0)</span>
                        <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                        customerror_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                }
        }

        <span class="hl kwa">if</span> PreParse:  reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>            <span class="hl slc">! easily replaceable routine</span>

        <span class="hl slc">! Last player-specified object</span>
        <span class="hl kwa">if</span> <span class="hl kwb">object</span> <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl kwa">and</span> <span class="hl kwb">object</span> <span class="hl opt">&lt;</span> <span class="hl kwb">objects</span> <span class="hl kwa">and</span> last_object <span class="hl opt">~=</span> <span class="hl opt">-</span><span class="hl num">1</span>
                AssignPronoun(<span class="hl kwb">object</span>)
        parser_data[LAST_PARSER_STATUS] <span class="hl opt">=</span> <span class="hl num">0</span>

        <span class="hl slc">! Must do this after AssignPronoun, and reset it to 0</span>
        <span class="hl slc">! after both of Perform and ParseError:</span>
        parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_ACTIVE

<span class="hl ppc">#ifclear OLD_STYLE_PRONOUNS</span>
        <span class="hl kwa">move</span> it_object <span class="hl kwa">to</span> <span class="hl kwa">parent</span>(it_obj)
        <span class="hl kwa">move</span> him_object <span class="hl kwa">to</span> <span class="hl kwa">parent</span>(him_obj)
        <span class="hl kwa">move</span> her_object <span class="hl kwa">to</span> <span class="hl kwa">parent</span>(her_obj)
        <span class="hl kwa">move</span> them_object <span class="hl kwa">to</span> <span class="hl kwa">parent</span>(them_obj)
<span class="hl ppc">#endif</span>

        <span class="hl slc">! To repeat last command</span>
        <span class="hl kwa">if</span> (<span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;again&quot;</span> <span class="hl kwa">or</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;g&quot;</span>) <span class="hl kwa">and</span> <span class="hl kwa">word</span>[<span class="hl num">2</span>] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
        {
                <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>oldword[<span class="hl num">0</span>]; a<span class="hl opt">++</span>)
                        <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> oldword[a]
                <span class="hl kwb">words</span> <span class="hl opt">=</span> oldword[<span class="hl num">0</span>]
                reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>
                <span class="hl kwa">jump</span> LeaveParse
        }

        <span class="hl kwa">local</span> count
<span class="hl ppc">#ifset OLD_STYLE_PRONOUNS</span>
        <span class="hl kwa">local</span> n, number_pronouns
<span class="hl ppc">#endif</span>

        <span class="hl kwa">for</span> (count<span class="hl opt">=</span><span class="hl num">2</span>; count<span class="hl opt">&lt;=</span><span class="hl kwb">words</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[count]<span class="hl opt">~=</span><span class="hl str">&quot;&quot;</span>; count<span class="hl opt">++</span>)
        {
                <span class="hl kwa">select</span> <span class="hl kwa">word</span>[count]

<span class="hl ppc">#ifset OLD_STYLE_PRONOUNS</span>
                        <span class="hl slc">! Rename pronouns to appropriate objects</span>
                        <span class="hl kwa">case</span> <span class="hl str">&quot;it&quot;</span>, <span class="hl str">&quot;them&quot;</span>, <span class="hl str">&quot;him&quot;</span>, <span class="hl str">&quot;her&quot;</span>
                        {
                                <span class="hl kwa">select</span> <span class="hl kwa">word</span>[count]
                                        <span class="hl kwa">case</span> <span class="hl str">&quot;it&quot;</span>:      a <span class="hl opt">=</span> it_obj
                                        <span class="hl kwa">case</span> <span class="hl str">&quot;them&quot;</span>:    a <span class="hl opt">=</span> them_obj
                                        <span class="hl kwa">case</span> <span class="hl str">&quot;him&quot;</span>:     a <span class="hl opt">=</span> him_obj
                                        <span class="hl kwa">case</span> <span class="hl str">&quot;her&quot;</span>:     a <span class="hl opt">=</span> her_obj

                                <span class="hl kwa">if</span> a <span class="hl opt">=</span> nothing
                                {
                                        <span class="hl slc">! &quot;...be a little more specific&quot;</span>
                                        ParseError(<span class="hl num">13</span>)
                                        <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                                        customerror_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                        <span class="hl kwa">return</span>
                                }
                                <span class="hl slc">! Avoid, e.g., &quot;put it it something&quot;</span>
                                <span class="hl kwa">elseif</span> <span class="hl kwa">word</span>[count] <span class="hl opt">~=</span> <span class="hl kwa">word</span>[count<span class="hl opt">+</span><span class="hl num">1</span>]
                                {
                                        <span class="hl slc">! For her_obj, we can run into trouble, since</span>
                                        <span class="hl slc">! it&#39;s both possessive and a pronoun, so only</span>
                                        <span class="hl slc">! replace &quot;her&quot; where it&#39;s the last word:</span>
                                        <span class="hl kwa">if</span> a <span class="hl opt">~=</span> her_obj <span class="hl kwa">or</span>
                                                (a <span class="hl opt">=</span> her_obj <span class="hl kwa">and</span> (count <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl kwa">or</span> count <span class="hl opt">=</span> <span class="hl kwb">words</span>))
                                        {
                                                n <span class="hl opt">=</span> SetObjWord(count, a)
                                                replace_pronoun[number_pronouns] <span class="hl opt">=</span> a
                                                number_pronouns<span class="hl opt">++</span>
                                                <span class="hl kwa">if</span> n <span class="hl opt">&gt;</span> <span class="hl num">1</span>
                                                        count <span class="hl opt">=</span> count <span class="hl opt">+</span> (n <span class="hl opt">-</span> <span class="hl num">1</span>)
                                                parser_data[PARSER_STATUS] <span class="hl opt">|=</span> PRONOUNS_SET
                                                reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                        }
                                }
                        }
<span class="hl ppc">#endif</span>

                        <span class="hl slc">! Allow for &quot;then...&quot; and &quot;and then...&quot;</span>
                        <span class="hl kwa">case</span> <span class="hl str">&quot;then&quot;</span>
                        {
                                <span class="hl slc">! end of this command</span>
                                <span class="hl kwa">word</span>[count] <span class="hl opt">=</span> <span class="hl str">&quot;.&quot;</span>
                                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[count<span class="hl opt">-</span><span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;~and&quot;</span>
                                        DeleteWord(count<span class="hl opt">-</span><span class="hl num">1</span>)
                                reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                <span class="hl kwa">break</span>
                        }
        }

<span class="hl ppc">#ifset OLD_STYLE_PRONOUNS</span>
        <span class="hl kwa">if</span> number_pronouns <span class="hl opt">=</span> <span class="hl num">2</span> <span class="hl kwa">and</span> replace_pronoun[<span class="hl num">0</span>] <span class="hl opt">=</span> replace_pronoun[<span class="hl num">1</span>]
                number_pronouns<span class="hl opt">--</span>

        <span class="hl kwa">if</span> number_pronouns <span class="hl opt">&gt;</span> <span class="hl num">0</span>
        {
                PrintReplacedPronouns(number_pronouns)
        }
<span class="hl ppc">#endif</span>

<span class="hl slc">! Reword imperatives given as &quot;Tell Bob to do something&quot; as &quot;Bob, do</span>
<span class="hl slc">! something&quot; so that the engine automatically reroutes them to SpeakTo</span>

        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;tell&quot;</span>, <span class="hl str">&quot;order&quot;</span>, <span class="hl str">&quot;instruct&quot;</span>, <span class="hl str">&quot;ask&quot;</span>, <span class="hl str">&quot;command&quot;</span>
        {
                <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span><span class="hl kwb">words</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[a]<span class="hl opt">~=</span><span class="hl str">&quot;&quot;</span>; a<span class="hl opt">++</span>)
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> <span class="hl str">&quot;to&quot;</span>
                        {
                                <span class="hl slc">!DeleteWord(a)   ! &quot;to&quot;</span>
                                <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> <span class="hl str">&quot;~and&quot;</span>
                                DeleteWord(<span class="hl num">1</span>)   <span class="hl slc">! &quot;tell&quot;, &quot;order&quot;, etc.</span>
                                reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                <span class="hl kwa">break</span>
                        }
                }
        }

<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>
        <span class="hl kwa">if</span> ParsePluralObjects:  reparse <span class="hl opt">=</span> <span class="hl kwc">true</span>
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset USE_CHECKHELD</span>
        ParseCheckHeld
<span class="hl ppc">#endif</span>

        <span class="hl slc">! Store current command for future reference</span>
        <span class="hl kwa">local</span> ow
        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span><span class="hl kwb">words</span> <span class="hl kwa">and</span> a<span class="hl opt">&lt;</span>MAX_WORDS; a<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> <span class="hl str">&quot;g&quot;</span>, <span class="hl str">&quot;again&quot;</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[a<span class="hl opt">+</span><span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                                a<span class="hl opt">++</span>
                }
                <span class="hl kwa">else</span>
                        oldword[<span class="hl opt">++</span>ow] <span class="hl opt">=</span> <span class="hl kwa">word</span>[a]
        }
        oldword[a] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
        oldword[<span class="hl num">0</span>] <span class="hl opt">=</span> ow

:LeaveParse

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
        {
                Font(BOLD_ON)
                <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span><span class="hl kwb">words</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[a]<span class="hl opt">~=</span><span class="hl str">&quot;&quot;</span>; a<span class="hl opt">++</span>)
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[&quot;</span>; <span class="hl kwa">word</span>[a]; <span class="hl str">&quot;] &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                <span class="hl kwa">if</span> <span class="hl kwb">parse$</span> <span class="hl opt">~=</span> <span class="hl str">&quot;&quot;</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[parse$ =</span> <span class="hl esc">\&quot;</span><span class="hl str">&quot;</span>; <span class="hl kwb">parse$</span>; <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">]&quot;</span>
                Font(BOLD_OFF)
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">return</span> reparse
}

<span class="hl kwa">routine</span> ResetParse
{
        customerror_flag <span class="hl opt">=</span> <span class="hl kwc">false</span>
        parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> <span class="hl num">0</span>  <span class="hl slc">! reset each parser cycle</span>
        parser_data[PARSE_RANK_TESTS] <span class="hl opt">=</span> <span class="hl num">0</span>
        parser_data[VERB_IS_XVERB] <span class="hl opt">=</span> <span class="hl num">0</span>
}

<span class="hl kwa">routine</span> PreParse                        <span class="hl slc">! to be replaced if needed</span>
{}

<span class="hl kwa">routine</span> CurrentCommandWords
{
        <span class="hl kwa">if</span> <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">return</span> <span class="hl num">0</span>

        <span class="hl kwa">local</span> i
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;</span><span class="hl kwb">words</span>; i<span class="hl opt">++</span>)         <span class="hl slc">! not &lt;=, because of the i++</span>
        {
                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[i] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                        <span class="hl kwa">break</span>
        }
        <span class="hl kwa">return</span> i
}

<span class="hl kwa">routine</span> SetObjWord(a, obj)      <span class="hl slc">! inserts unique name of &lt;obj&gt; at word &lt;a&gt;</span>
{
        <span class="hl kwa">local</span> i, n

        <span class="hl kwa">if</span> obj.<span class="hl ppc">#adjectives</span>              <span class="hl slc">! Allowing multiple adjectives...</span>
<span class="hl ppc"></span>        {
                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#adjectives; i++)</span>
                {
                        <span class="hl kwa">if</span> obj.<span class="hl kwb">adjective</span> <span class="hl ppc">#i</span>
                        {
                                <span class="hl kwa">if</span> <span class="hl opt">++</span>n <span class="hl opt">&gt;</span> <span class="hl num">1</span>:  InsertWord(a)
                                <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> obj.<span class="hl kwb">adjective</span> <span class="hl ppc">#i</span>
                                a<span class="hl opt">++</span>
                        }
                        <span class="hl kwa">if</span> i <span class="hl opt">=</span> <span class="hl num">15</span>: <span class="hl kwa">break</span>        <span class="hl slc">! match MAX_MOBJ in heparse.c</span>
                }
        }

        <span class="hl kwa">if</span> obj.<span class="hl ppc">#nouns</span>                    <span class="hl slc">! ...and 1 noun (obj.noun #1)</span>
<span class="hl ppc"></span>        {
                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#nouns; i++)</span>
                {
                        <span class="hl kwa">if</span> obj.<span class="hl kwb">noun</span> <span class="hl ppc">#i</span>
                        {
                                <span class="hl kwa">if</span> n:  InsertWord(a)
                                <span class="hl kwa">word</span>[a] <span class="hl opt">=</span> obj.<span class="hl kwb">noun</span> <span class="hl ppc">#i</span>
                                <span class="hl kwa">break</span>
                                <span class="hl slc">! Never executed:</span>
                                <span class="hl slc">!a++ : n++</span>
                        }
                }
        }

        <span class="hl kwa">return</span> n
}

<span class="hl kwa">routine</span> InsertWord(p, n)                <span class="hl slc">! inserts &lt;n&gt; words at position &lt;p&gt;</span>
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> n <span class="hl opt">=</span> <span class="hl num">0</span>:  n <span class="hl opt">=</span> <span class="hl num">1</span>

        <span class="hl kwa">if</span> <span class="hl kwb">words</span><span class="hl opt">+</span>n <span class="hl opt">&gt;=</span> MAX_WORDS:  <span class="hl kwa">return</span>

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl kwb">words</span><span class="hl opt">+</span>n; i<span class="hl opt">&gt;</span>p; i<span class="hl opt">--</span>)
                <span class="hl kwa">word</span>[i] <span class="hl opt">=</span> <span class="hl kwa">word</span>[i<span class="hl opt">-</span>n]
        <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl kwb">words</span> <span class="hl opt">+</span> n

        <span class="hl kwa">return</span> n
}

<span class="hl kwa">routine</span> DeleteWord(p, n)                <span class="hl slc">! deletes &lt;n&gt; words at position &lt;p&gt;</span>
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> n <span class="hl opt">=</span> <span class="hl num">0</span>:  n <span class="hl opt">=</span> <span class="hl num">1</span>

        <span class="hl kwa">if</span> (<span class="hl kwb">words</span> <span class="hl opt">&lt;</span> n) <span class="hl kwa">or</span> (p <span class="hl opt">+</span> n <span class="hl opt">&gt;=</span> MAX_WORDS):  <span class="hl kwa">return</span>

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span>p; i<span class="hl opt">&lt;=</span><span class="hl kwb">words</span><span class="hl opt">-</span>n; i<span class="hl opt">++</span>)
                <span class="hl kwa">word</span>[i] <span class="hl opt">=</span> <span class="hl kwa">word</span>[i<span class="hl opt">+</span>n]
        <span class="hl kwa">word</span>[<span class="hl kwb">words</span>] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
        <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl kwb">words</span> <span class="hl opt">-</span> n

        <span class="hl kwa">return</span> n
}

<span class="hl kwa">routine</span> VerbWord(which)                 <span class="hl slc">! returns word used as verb</span>
{                                       <span class="hl slc">! in a typed command</span>
        <span class="hl kwa">select</span> <span class="hl kwb">verbroutine</span>
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoLook
        {
                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;x&quot;</span>
                        <span class="hl kwa">return</span> <span class="hl str">&quot;examine&quot;</span>
        }
        <span class="hl kwa">case</span> <span class="hl kwa">else</span>
                <span class="hl kwa">return</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>]
}

<span class="hl kwa">routine</span> ObjWord(wd, obj)                <span class="hl slc">! returns adjective or noun if &lt;wd&gt;</span>
{                                       <span class="hl slc">! is either for &lt;obj&gt;</span>
        <span class="hl kwa">if</span> InList(obj, <span class="hl kwb">noun</span>, wd)
                <span class="hl kwa">return</span> <span class="hl kwb">noun</span>

        <span class="hl kwa">if</span> InList(obj, <span class="hl kwb">adjective</span>, wd)
                <span class="hl kwa">return</span> <span class="hl kwb">adjective</span>

        <span class="hl kwa">return</span> <span class="hl kwc">false</span>                    <span class="hl slc">! didn&#39;t match either</span>
}

<span class="hl kwa">routine</span> PrintReplacedPronouns(number_pronouns)
{
        <span class="hl kwa">local</span> count

        Message(<span class="hl opt">&amp;</span>Parse, <span class="hl num">2</span>)      <span class="hl slc">! &quot;Assuming you mean...&quot;</span>
        <span class="hl kwa">for</span> (count <span class="hl opt">=</span> <span class="hl num">0</span>; count <span class="hl opt">&lt;</span> number_pronouns; count<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> count <span class="hl opt">&gt;</span> <span class="hl num">0</span>
                {
                        <span class="hl kwa">if</span> number_pronouns <span class="hl opt">&gt;</span> <span class="hl num">2</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;,&quot;</span>;
                        <span class="hl kwa">if</span> count <span class="hl opt">=</span> number_pronouns <span class="hl opt">-</span> <span class="hl num">1</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD;
                }
                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;

                <span class="hl kwa">if</span> replace_pronoun[count].<span class="hl kwb">name</span> <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                        The(nothing)
                <span class="hl kwa">else</span>
                        The(replace_pronoun[count])
        }
        <span class="hl kwa">if</span> number_pronouns <span class="hl opt">&gt;</span> <span class="hl num">1</span>
                Message(<span class="hl opt">&amp;</span>Parse, <span class="hl num">3</span>)      <span class="hl slc">! &quot;, respectively&quot;</span>
        <span class="hl kwa">print</span> <span class="hl str">&quot;)&quot;</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ParseError(errornumber, object)</span>
<span class="hl slc">! prints an appropriate error message; if called by the engine, signals the</span>
<span class="hl slc">! engine to produce the default message by returning false</span>
<span class="hl slc">!</span>
<span class="hl slc">! (Note:  If &lt;errornumber&gt; is equal to or greater than 100, CustomError</span>
<span class="hl slc">! is called instead.  Replace CustomError for cases where custom error</span>
<span class="hl slc">! messages are desired for user parsing routines.  Do not call CustomError</span>
<span class="hl slc">! directly.  NewParseError can be replaced to modify only some</span>
<span class="hl slc">! messages.)</span>

<span class="hl kwa">routine</span> ParseError(errornumber, obj)
{
        <span class="hl kwa">local</span> r
        r <span class="hl opt">=</span> NewParseError(errornumber, obj)
        <span class="hl kwa">if</span> r
        {
                parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET
                <span class="hl kwa">return</span> r
        }

        <span class="hl kwa">if</span> errornumber <span class="hl opt">&gt;=</span> <span class="hl num">100</span>
        {
                CustomError(errornumber, obj)
                <span class="hl kwa">word</span>[<span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>            <span class="hl slc">! force ParseError(0)</span>
                <span class="hl kwb">words</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                customerror_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">if</span> customerror_flag
        {
                customerror_flag <span class="hl opt">=</span> <span class="hl num">0</span>    <span class="hl slc">! CustomError already printed error</span>
                parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
        {
                Font(BOLD_ON)
                <span class="hl kwa">print</span> <span class="hl str">&quot;[ParseError(&quot;</span>; <span class="hl kwa">number</span> errornumber; <span class="hl str">&quot;, &quot;</span>; obj.<span class="hl kwb">name</span>; \
                        <span class="hl str">&quot; (&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;)]&quot;</span>
                Font(BOLD_OFF)
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">select</span> errornumber

                <span class="hl kwa">case</span> <span class="hl num">1</span>
                        <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); \
                                <span class="hl slc">! &quot; can&#39;t use the word \&quot;&quot;; \</span>
                                MatchPlural(<span class="hl kwb">player</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                <span class="hl str">&quot; need to use the word</span> <span class="hl esc">\&quot;</span><span class="hl str">&quot;</span>; \
                                <span class="hl kwb">parse$</span>; <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">.&quot;</span>

                <span class="hl kwa">case</span> <span class="hl num">3</span>
                        <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); <span class="hl str">&quot; can&#39;t &quot;</span>; <span class="hl kwb">parse$</span>; <span class="hl str">&quot; multiple</span>
<span class="hl str">                                objects like that.&quot;</span>

                <span class="hl kwa">case</span> <span class="hl num">5</span>
                {
                        <span class="hl kwa">if</span> VerbWord <span class="hl opt">=</span> <span class="hl str">&quot;give&quot;</span>, <span class="hl str">&quot;offer&quot;</span>, <span class="hl str">&quot;hand&quot;</span>, <span class="hl str">&quot;show&quot;</span>
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;Not sure what you&#39;re referring to--try</span> <span class="hl esc">\&quot;</span><span class="hl str">&quot;</span>; \
                                        VerbWord; <span class="hl str">&quot; (something)</span> <span class="hl esc">\I</span><span class="hl str">to</span><span class="hl esc">\i</span> <span class="hl str">(someone)</span><span class="hl esc">\&quot;</span><span class="hl str">.&quot;</span>
                        }
                        <span class="hl kwa">else</span>
                        {
<span class="hl com">!\</span>
<span class="hl com">                                print CThe(player); \</span>
<span class="hl com">                                        MatchPlural(player, &quot;hasn&#39;t&quot;, &quot;haven&#39;t&quot;);</span>
<span class="hl com">                                        print &quot; seen any&quot;;</span>
<span class="hl com">#ifset OLD_STYLE_PRONOUNS</span>
<span class="hl com">                                        ! If we built an object phrase using</span>
<span class="hl com">                                        ! OLD_STYLE_PRONOUNS, avoid printing a</span>
<span class="hl com">                                        ! potential nonsense name:</span>
<span class="hl com">                                        if parser_data[PARSER_STATUS] &amp; PRONOUNS_SET</span>
<span class="hl com">                                                print &quot;thing like that&quot;;</span>
<span class="hl com">                                        else</span>
<span class="hl com">#endif</span>
<span class="hl com">                                                print &quot; \&quot;&quot;; parse$; &quot;\&quot;&quot;;</span>
<span class="hl com">                                        print &quot;, nor&quot;; IsorAre(player, true); &quot; &quot;; The(player); \</span>
<span class="hl com">                                        &quot; likely to, even if such a thing exists.&quot;</span>
<span class="hl com">\!</span>
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); \
                                        MatchPlural(<span class="hl kwb">player</span>, <span class="hl str">&quot;hasn&#39;t&quot;</span>, <span class="hl str">&quot;haven&#39;t&quot;</span>);
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; encountered any&quot;</span>;
<span class="hl ppc">#ifset OLD_STYLE_PRONOUNS</span>
                                <span class="hl kwa">if</span> parser_data[PARSER_STATUS] <span class="hl opt">&amp;</span> PRONOUNS_SET
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;thing like that&quot;</span>;
                                <span class="hl kwa">else</span>
<span class="hl ppc">#endif</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span> <span class="hl esc">\&quot;</span><span class="hl str">&quot;</span>; <span class="hl kwb">parse$</span>; <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;  (If you&#39;re sure you need to refer to that, try</span>
<span class="hl str">                                        putting it another way.)&quot;</span>
                        }
                }
                <span class="hl kwa">case</span> <span class="hl num">6</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;That doesn&#39;t make any sense.&quot;</span>

                <span class="hl kwa">case</span> <span class="hl num">9</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Nothing to &quot;</span>;
                        <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span>
                                <span class="hl kwa">print</span> <span class="hl kwb">parse$</span>; <span class="hl str">&quot;.&quot;</span>
                        <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;do.&quot;</span>
                }

                <span class="hl kwa">case</span> <span class="hl num">10</span>
                {
                        <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); \
                          MatchPlural(<span class="hl kwb">player</span>, <span class="hl str">&quot;hasn&#39;t&quot;</span>, <span class="hl str">&quot;haven&#39;t&quot;</span>);
                        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>obj.long_desc
                                <span class="hl str">&quot; seen &quot;</span>;
                        <span class="hl kwa">else</span>
                                <span class="hl str">&quot; encountered &quot;</span>;
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> living <span class="hl kwa">and</span> <span class="hl kwa">not</span> (parser_data[PARSER_STATUS] <span class="hl opt">&amp;</span> FINDOBJECT_NONLIVING)
                                <span class="hl kwa">print</span> <span class="hl str">&quot;anybody&quot;</span>;
                        <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;anything&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot; like that&quot;</span>;
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;]&quot;</span>;
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>
                }

                <span class="hl kwa">case</span> <span class="hl num">11</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ParseError_ObjectIsKnown(obj)
                        {
                                ParseError(<span class="hl num">10</span>, obj)
                        }
                        <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> living
                        {
<span class="hl com">!\</span>
<span class="hl com">                                print CThe(obj); \</span>
<span class="hl com">                                        MatchPlural(obj, &quot;isn&#39;t&quot;, &quot;aren&#39;t&quot;); &quot; here.&quot;</span>
<span class="hl com">\!</span>
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); \
                                        MatchPlural(<span class="hl kwb">actor</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                        <span class="hl str">&quot; see&quot;</span>;
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> plural
                                        <span class="hl str">&quot; them&quot;</span>;
                                <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> female
                                        <span class="hl str">&quot; her&quot;</span>;
                                <span class="hl kwa">else</span>
                                        <span class="hl str">&quot; him&quot;</span>;
<span class="hl ppc">#ifset DEBUG</span>
                                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;]&quot;</span>;
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>
                        }
                        <span class="hl kwa">else</span>
                        {
<span class="hl ppc">#ifset USE_CHECKHELD</span>
                                <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoDrop_CheckHeld, <span class="hl opt">&amp;</span>DoPutIn_CheckHeld,
                                        <span class="hl opt">&amp;</span>DoPutonGround_CheckHeld
                                {
                                        ParseError(<span class="hl num">15</span>, obj)
                                }
                                <span class="hl kwa">else</span>
                                {
<span class="hl ppc">#endif</span>
                                        <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); \
                                                MatchPlural(<span class="hl kwb">actor</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                                <span class="hl str">&quot; see that&quot;</span>; <span class="hl slc">! MatchPlural(obj, &quot;that&quot;, &quot;those&quot;);</span>
<span class="hl ppc">#ifset DEBUG</span>
                                        <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;]&quot;</span>;
<span class="hl ppc">#endif</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>
<span class="hl ppc">#ifset USE_CHECKHELD</span>
                                }
<span class="hl ppc">#endif</span>
                        }
                }

                <span class="hl kwa">case</span> <span class="hl num">12</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ParseError_ObjectIsKnown(obj)
                        {
                                ParseError(<span class="hl num">10</span>, obj)
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); \
                                        <span class="hl str">&quot; can&#39;t do that with &quot;</span>; TheOrThat(obj) ; <span class="hl str">&quot;.&quot;</span>
                        }
                }
                <span class="hl kwa">case</span> <span class="hl num">13</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;You&#39;ll have to be a little more specific.&quot;</span>

                <span class="hl kwa">case</span> <span class="hl num">14</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ParseError_ObjectIsKnown(obj)
                        {
                                ParseError(<span class="hl num">10</span>, obj)
                        }
                        <span class="hl kwa">elseif</span> <span class="hl kwb">xobject</span> <span class="hl kwa">is</span> living
                        {
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">xobject</span>); \
                                        MatchPlural(<span class="hl kwb">xobject</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                        <span class="hl str">&quot; have &quot;</span>; TheOrThat(obj); <span class="hl str">&quot;.&quot;</span>
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); \
                                        MatchPlural(<span class="hl kwb">actor</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                        <span class="hl str">&quot; see &quot;</span>; TheOrThat(obj); <span class="hl str">&quot; there.&quot;</span>
                        }
                }

                <span class="hl kwa">case</span> <span class="hl num">15</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ParseError_ObjectIsKnown(obj)
                        {
                                ParseError(<span class="hl num">10</span>, obj)
                        }
                        <span class="hl kwa">elseif</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span>
                        {
                                ParseError(<span class="hl num">12</span>, obj)
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">print</span> CThe(<span class="hl kwb">actor</span>); IsorAre(<span class="hl kwb">actor</span>); <span class="hl str">&quot; not</span>
<span class="hl str">                                        holding&quot;</span>; MatchPlural(obj, <span class="hl str">&quot;that&quot;</span>, <span class="hl str">&quot;those&quot;</span>); <span class="hl str">&quot;.&quot;</span>
                        }
                }

                <span class="hl kwa">case</span> <span class="hl kwa">else</span>
                {
                        parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET
                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>            <span class="hl slc">! print the default message</span>
                }

        parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET
        <span class="hl kwa">return</span> <span class="hl kwc">true</span>                             <span class="hl slc">! message already printed</span>
}

<span class="hl kwa">routine</span> ParseError_ObjectIsKnown(obj)
{
        <span class="hl kwa">if</span> ObjectIsKnown(obj)
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        <span class="hl kwa">if</span> parser_data[PARSER_STATUS] <span class="hl opt">&amp;</span> FINDOBJECT_KNOWN  <span class="hl slc">! and not xobject</span>
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
}

<span class="hl kwa">routine</span> TheOrThat(obj)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> known
                <span class="hl kwa">print</span> The(obj);
        <span class="hl kwa">else</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;that&quot;</span>;
}

<span class="hl kwa">routine</span> NewParseError(errornumber, obj) <span class="hl slc">! to be replaced for custom error</span>
{}                                      <span class="hl slc">! messages for library parsing</span>

<span class="hl kwa">routine</span> CustomError(errornumber, obj)   <span class="hl slc">! to be replaced for custom error</span>
{}                                      <span class="hl slc">! messages for user parsing routines</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! SpeakTo is called by the engine when a command is addressed to a</span>
<span class="hl slc">! character object via:  SpeakTo(character)</span>
<span class="hl slc">!</span>
<span class="hl slc">! For example, the input line</span>
<span class="hl slc">!</span>
<span class="hl slc">!   &lt;character&gt;, get the &lt;object&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! will call SpeakTo(&lt;character&gt;), with the global object containing &lt;object&gt;,</span>
<span class="hl slc">! and the verbroutine global set to &amp;DoGet</span>

<span class="hl kwa">routine</span> SpeakTo(char)
{
<span class="hl ppc">#ifset USE_CHECKHELD</span>
        <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoDrop_CheckHeld
                <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoDrop
        <span class="hl kwa">elseif</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoPutIn_CheckHeld
                <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoPutIn
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset VERBSTUBS</span>
        <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoHelpChar <span class="hl kwa">and</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
        {
                <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoHelp
                <span class="hl kwb">object</span> <span class="hl opt">=</span> nothing
        }
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset USE_CHECKHELD</span>
        ResetCheckHeld
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[Speakto(&quot;</span>; char.<span class="hl kwb">name</span>;
                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> char; <span class="hl str">&quot;]&quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;) verbroutine=&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">verbroutine</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;, object=&quot;</span>; <span class="hl kwb">object</span>.<span class="hl kwb">name</span>;
                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">object</span>; <span class="hl str">&quot;]&quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;, xobject=&quot;</span>; <span class="hl kwb">xobject</span>.<span class="hl kwb">name</span>;
                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM)
                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">xobject</span>; <span class="hl str">&quot;]&quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
        }
<span class="hl ppc">#endif</span>

        speaking <span class="hl opt">=</span> <span class="hl num">0</span>

        <span class="hl kwa">if</span> char <span class="hl kwa">is</span> <span class="hl kwa">not</span> living
        {
                ParseError(<span class="hl num">6</span>)
                <span class="hl kwa">return</span>
        }

        AssignPronoun(char)

        <span class="hl slc">! Handle player/typist-related ParseError messages:</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> FindObject(char, <span class="hl kwb">location</span>)
        {
                <span class="hl kwb">actor</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
                ParseError(<span class="hl num">11</span>, char)
                <span class="hl kwa">return</span>
        }
        <span class="hl kwa">elseif</span> char <span class="hl opt">=</span> <span class="hl kwb">player</span>
        {
                <span class="hl kwb">actor</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
                Message(<span class="hl opt">&amp;</span>Speakto, <span class="hl num">1</span>)    <span class="hl slc">! &quot;Stop talking to yourself...&quot;</span>
                <span class="hl kwa">return</span>
        }
        <span class="hl kwa">elseif</span> <span class="hl kwa">not</span> ObjectisKnown(<span class="hl kwb">object</span>) <span class="hl kwa">and</span> <span class="hl kwa">not</span> FindObject(<span class="hl kwb">object</span>, <span class="hl kwb">location</span>)
        {
                <span class="hl kwb">actor</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
                ParseError(<span class="hl num">10</span>, <span class="hl kwb">object</span>)
                <span class="hl kwa">return</span>
        }

        <span class="hl kwa">if</span> char <span class="hl kwa">is</span> unfriendly
                <span class="hl kwa">jump</span> IgnorePlayer

        speaking <span class="hl opt">=</span> char

        <span class="hl slc">! In the event of:  &gt;CHARACTER, GO NORTH.  GET THE THING.  GO WEST., etc.</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> FindObject(char, <span class="hl kwb">location</span>)
        {
                <span class="hl kwa">run</span> char.order_response
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }

        <span class="hl kwa">select</span> <span class="hl kwb">verbroutine</span>
                <span class="hl kwa">case</span> <span class="hl num">0</span>                  <span class="hl slc">! Just the character name is given,</span>
                                        <span class="hl slc">! so just &quot;X is listening.&quot;</span>
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> char.order_response
                                Message(<span class="hl opt">&amp;</span>Speakto, <span class="hl num">2</span>, char)
                }

<span class="hl ppc">#ifclear NO_VERBS</span>
                <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoHello           <span class="hl slc">! Note the ampersands (&#39;&amp;&#39;)--or else</span>
                {                       <span class="hl slc">! the routines themselves would run</span>
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> char.order_response
                        {
                                <span class="hl kwa">if</span> char <span class="hl kwa">is</span> <span class="hl kwa">not</span> unfriendly
                                        <span class="hl slc">! &quot;X nods hello.&quot;</span>
                                        Message(<span class="hl opt">&amp;</span>Speakto, <span class="hl num">3</span>, char)
                                <span class="hl kwa">else</span>
                                {
                                        <span class="hl kwa">jump</span> IgnorePlayer
                                }
                        }
                }

                <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoAskQuestion
                        <span class="hl kwa">return</span> Perform(<span class="hl opt">&amp;</span>DoAsk, char, <span class="hl kwb">object</span>)

                <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoTalk
                {
                        <span class="hl kwa">if</span> <span class="hl kwb">xobject</span>
                                ParseError(<span class="hl num">6</span>)
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">return</span> Perform(<span class="hl opt">&amp;</span>DoAsk, char, <span class="hl kwb">object</span>)
                }

                <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoTell
                {
                        <span class="hl kwa">if</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
                                <span class="hl kwa">return</span> Perform(<span class="hl opt">&amp;</span>DoAsk, char, <span class="hl kwb">xobject</span>)
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">jump</span> TryResponse
                }
<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_VERBS</span>
<span class="hl ppc"></span>
                <span class="hl kwa">case</span> <span class="hl kwa">else</span>
                {

<span class="hl slc">! If the character can respond to a request, this should be dealt with by</span>
<span class="hl slc">! an order_response property routine; order_response--if it exists--should</span>
<span class="hl slc">! return false if there is no response for the given verbroutine</span>

:TryResponse

                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> char.order_response
                                <span class="hl kwa">jump</span> IgnorePlayer
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                }
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>

:IgnorePlayer

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> char.ignore_response
                Message(<span class="hl opt">&amp;</span>Speakto, <span class="hl num">4</span>, char)      <span class="hl slc">! &quot;X ignores you.&quot;</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Perform(&amp;action, object, xobject)</span>
<span class="hl slc">! calls the verbroutine given by &lt;action&gt;, with globals object and xobject</span>
<span class="hl slc">! as given; returns value returned by &lt;action&gt; (or &lt;object&gt;.before)</span>
<span class="hl slc">!</span>
<span class="hl slc">! NOTE:  Ensure that the &lt;action&gt; is an address (preceded by &amp;), not a</span>
<span class="hl slc">! standard routine call.</span>
<span class="hl slc">!</span>
<span class="hl slc">! (The &lt;queue&gt; argument is used by the library when calling Perform</span>
<span class="hl slc">! for each object in a set of multiple objects.)</span>
<span class="hl slc">!</span>
<span class="hl slc">! (&lt;isxverb&gt; is true when the action being called is as a result of</span>
<span class="hl slc">! an xverb grammar line.)</span>

<span class="hl kwa">routine</span> Perform(action, obj, xobj, queue, isxverb)
{
        <span class="hl kwa">local</span> r
        <span class="hl kwa">local</span> objtemp, xobjtemp, verbtemp, actortemp
<span class="hl ppc">#ifclear NO_XVERBS</span>
        <span class="hl kwa">local</span> restoring
        <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoRestore:  restoring <span class="hl opt">=</span> <span class="hl kwc">true</span>
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[Perform(&quot;</span>; <span class="hl kwa">number</span> action; <span class="hl str">&quot;, &quot;</span>; obj.<span class="hl kwb">name</span>;
                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM) <span class="hl kwa">or</span> queue <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;]&quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>; xobj.<span class="hl kwb">name</span>;
                <span class="hl kwa">if</span> (debug_flags <span class="hl opt">&amp;</span> D_OBJNUM) <span class="hl kwa">or</span> queue <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> xobj; <span class="hl str">&quot;]&quot;</span>;
                <span class="hl kwa">if</span> queue
                        <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>; <span class="hl kwa">number</span> queue;
                <span class="hl kwa">print</span> <span class="hl str">&quot;)]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> queue
                parser_data[PARSER_STATUS] <span class="hl opt">|=</span> PERFORM_QUEUE

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> queue <span class="hl kwa">and</span> <span class="hl kwb">object</span>
                parser_data[LAST_SINGLE_OBJECT] <span class="hl opt">=</span> <span class="hl kwb">object</span>
        <span class="hl kwa">else</span>
                parser_data[LAST_SINGLE_OBJECT] <span class="hl opt">=</span> <span class="hl num">0</span>

        parser_data[VERB_IS_XVERB] <span class="hl opt">=</span> isxverb

        objtemp <span class="hl opt">=</span> <span class="hl kwb">object</span>
        xobjtemp <span class="hl opt">=</span> <span class="hl kwb">xobject</span>
        verbtemp <span class="hl opt">=</span> <span class="hl kwb">verbroutine</span>
        actortemp <span class="hl opt">=</span> <span class="hl kwb">actor</span>

        <span class="hl kwb">object</span> <span class="hl opt">=</span> obj
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> xobj
        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> action
        <span class="hl kwb">actor</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>

<span class="hl ppc">#ifclear OLD_STYLE_PRONOUNS</span>
        <span class="hl kwa">local</span> number_pronouns <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">if</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> it_object:          <span class="hl kwb">object</span> <span class="hl opt">=</span> it_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> him_object:     <span class="hl kwb">object</span> <span class="hl opt">=</span> him_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> her_object:     <span class="hl kwb">object</span> <span class="hl opt">=</span> her_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">object</span> <span class="hl opt">=</span> them_object:    <span class="hl kwb">object</span> <span class="hl opt">=</span> them_obj
        <span class="hl kwa">if</span> <span class="hl kwb">object</span> <span class="hl opt">~=</span> obj
        {
                replace_pronoun[number_pronouns] <span class="hl opt">=</span> <span class="hl kwb">object</span>
                number_pronouns<span class="hl opt">++</span>
        }
        <span class="hl kwa">if</span> <span class="hl kwb">xobject</span> <span class="hl opt">=</span> it_object:         <span class="hl kwb">xobject</span> <span class="hl opt">=</span> it_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">xobject</span> <span class="hl opt">=</span> him_object:    <span class="hl kwb">xobject</span> <span class="hl opt">=</span> him_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">xobject</span> <span class="hl opt">=</span> her_object:    <span class="hl kwb">xobject</span> <span class="hl opt">=</span> her_obj
        <span class="hl kwa">elseif</span> <span class="hl kwb">xobject</span> <span class="hl opt">=</span> them_object:   <span class="hl kwb">xobject</span> <span class="hl opt">=</span> them_obj
        <span class="hl kwa">if</span> <span class="hl kwb">xobject</span> <span class="hl opt">~=</span> xobj
        {
                replace_pronoun[number_pronouns] <span class="hl opt">=</span> <span class="hl kwb">xobject</span>
                number_pronouns<span class="hl opt">++</span>
        }
        <span class="hl kwa">if</span> number_pronouns
        {
                parser_data[PARSER_STATUS] <span class="hl opt">|=</span> PRONOUNS_SET
                PrintReplacedPronouns(number_pronouns)
        }
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifclear NO_OBJLIB</span>
        SetupDirectionObjects
<span class="hl ppc">#endif</span>

        <span class="hl slc">! Itemize each object in a list of multiple objects</span>
        <span class="hl kwa">if</span> queue <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl kwa">and</span> <span class="hl kwb">object</span> <span class="hl opt">&gt;</span> display
        {
<span class="hl ppc">#ifset USE_CHECKHELD</span>
                <span class="hl slc">! Check if an ImplicitTakeForDrop was just done, meaning we</span>
                <span class="hl slc">! need a newline before printing the next &quot;object:&quot;</span>
                <span class="hl kwa">if</span> checkheld <span class="hl kwa">is</span> workflag
                        <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                checkheld <span class="hl kwa">is</span> <span class="hl kwa">not</span> workflag
<span class="hl ppc">#endif</span>
                <span class="hl kwa">print</span> <span class="hl kwb">object</span>.<span class="hl kwb">name</span>; <span class="hl str">&quot;:  &quot;</span>;
        }

        r <span class="hl opt">=</span> BeforeRoutines(queue)
        <span class="hl kwa">if</span> r:  <span class="hl kwa">jump</span> DonePerform

        r <span class="hl opt">=</span> <span class="hl kwa">call</span> action                 <span class="hl slc">! object.after and xobject.after</span>
                                        <span class="hl slc">! run by verbroutine</span>
<span class="hl ppc">#ifclear NO_XVERBS</span>
        <span class="hl kwa">if</span> restoring
                <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoRestore
<span class="hl ppc">#endif</span>
        <span class="hl kwa">if</span> r
        {
                AfterRoutines
        }

:DonePerform

<span class="hl ppc">#ifset USE_CHECKHELD</span>
        ResetCheckHeld
<span class="hl ppc">#endif</span>

        last_object <span class="hl opt">=</span> <span class="hl kwb">object</span>

        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> verbtemp
        <span class="hl kwb">object</span> <span class="hl opt">=</span> objtemp
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> xobjtemp
        <span class="hl kwb">actor</span> <span class="hl opt">=</span> actortemp

        <span class="hl kwa">if</span> queue <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>
                last_object <span class="hl opt">=</span> <span class="hl opt">-</span><span class="hl num">1</span>
        parser_data[PARSER_STATUS] <span class="hl opt">=</span> PARSER_RESET

        <span class="hl kwa">return</span> r
}

<span class="hl ppc">#ifclear NO_OBJLIB</span>
<span class="hl kwa">routine</span> SetupDirectionObjects
{
        <span class="hl slc">! Chris Tate devised this method for setting the [x]object to a</span>
        <span class="hl slc">! direction if it hasn&#39;t yet been done:</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwb">object</span> <span class="hl kwa">or</span> <span class="hl kwa">not</span> <span class="hl kwb">xobject</span>
        {
                <span class="hl kwa">local</span> i, wordnum

                <span class="hl slc">! The last word in the command might be a direction, e.g. in the grammar for</span>
                <span class="hl slc">! &gt;PUSH OBJECT NORTH or &gt;OUT.  If we don&#39;t see an object or xobject we might</span>
                <span class="hl slc">! need to parse the last word as a direction and supply that.</span>
                wordnum <span class="hl opt">=</span> <span class="hl kwb">words</span>
                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span><span class="hl kwb">words</span>; i<span class="hl opt">++</span>)
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[i] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                        {
                                wordnum <span class="hl opt">=</span> i <span class="hl opt">-</span> <span class="hl num">1</span>
                                <span class="hl kwa">break</span>
                        }
                }

                <span class="hl kwa">for</span> i <span class="hl kwa">in</span> direction
                {
                        <span class="hl kwa">if</span> i.type <span class="hl opt">=</span> direction <span class="hl kwa">and</span> ObjWord(<span class="hl kwa">word</span>[wordnum], i)
                        {
                                <span class="hl slc">! The last word is a direction.  If there&#39;s no object we</span>
                                <span class="hl slc">! make that the direction object; otherwise we make it the</span>
                                <span class="hl slc">! xobject.</span>
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwb">object</span>
                                {
                                        AssignPronoun(i)
                                        <span class="hl kwb">object</span> <span class="hl opt">=</span> i
                                }
                                <span class="hl kwa">else</span>
                                        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> i
                                <span class="hl kwa">break</span>
                        }
                }
        }
}
<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_OBJLIB</span>
<span class="hl ppc"></span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! BeforeRoutines(queue)</span>
<span class="hl slc">!</span>
<span class="hl slc">! Runs all relevant routines that might precede a verbroutine, returning</span>
<span class="hl slc">! true if any of them returns true.</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">routine</span> BeforeRoutines(queue)
{
        <span class="hl kwa">local</span> r, i

        r <span class="hl opt">=</span> <span class="hl kwb">player</span>.react_before
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">player</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">player</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.react_before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">return</span> r
        }
        r <span class="hl opt">=</span> <span class="hl kwb">player</span>.<span class="hl kwb">before</span>
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">player</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">player</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">return</span> r
        }

        r <span class="hl opt">=</span> <span class="hl kwb">location</span>.react_before
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">location</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">location</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.react_before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">return</span> r
        }
        r <span class="hl opt">=</span> <span class="hl kwb">location</span>.<span class="hl kwb">before</span>
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">location</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">location</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">return</span> r
        }

        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">location</span>
        {
                r <span class="hl opt">=</span> i.react_before
                <span class="hl kwa">if</span> r
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; i.<span class="hl kwb">name</span>;
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> i; <span class="hl str">&quot;]&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.react_before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">return</span> r
                }
        }

        <span class="hl slc">! queue is -1 if the object was a number (i.e., a literal digit)</span>
        <span class="hl kwa">if</span> queue <span class="hl opt">~=</span> <span class="hl opt">-</span><span class="hl num">1</span> <span class="hl kwa">and</span> <span class="hl kwb">xobject</span> <span class="hl opt">&gt;</span> display
        {
                r <span class="hl opt">=</span> <span class="hl kwb">xobject</span>.<span class="hl kwb">before</span>
                <span class="hl kwa">if</span> r
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">xobject</span>.<span class="hl kwb">name</span>;
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">xobject</span>; <span class="hl str">&quot;]&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">return</span> r
                }
        }

        <span class="hl kwa">if</span> queue <span class="hl opt">~=</span> <span class="hl opt">-</span><span class="hl num">1</span> <span class="hl kwa">and</span> <span class="hl kwb">object</span> <span class="hl opt">&gt;</span> display
        {
                r <span class="hl opt">=</span> <span class="hl kwb">object</span>.<span class="hl kwb">before</span>
                <span class="hl kwa">if</span> r
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">object</span>.<span class="hl kwb">name</span>;
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">object</span>; <span class="hl str">&quot;]&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.before returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">return</span> r
                }
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! AfterRoutines</span>
<span class="hl slc">!</span>
<span class="hl slc">! Runs all relevant routines that might follow a verbroutine.  Note that</span>
<span class="hl slc">! object.after and xobject.after are not called here, nor is anything that</span>
<span class="hl slc">! should be explicitly called by a verbroutine depending on its (degree of)</span>
<span class="hl slc">! failure or success.</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl kwa">routine</span> AfterRoutines
{
        <span class="hl kwa">local</span> i, r

        r <span class="hl opt">=</span> <span class="hl kwb">player</span>.<span class="hl kwb">after</span>
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">player</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">player</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.after returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
        }

        r <span class="hl opt">=</span> <span class="hl kwb">player</span>.react_after
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">player</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">player</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.react_after returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
        }

        r <span class="hl opt">=</span> <span class="hl kwb">location</span>.<span class="hl kwb">after</span>
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">location</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">location</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.after returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
        }

        r <span class="hl opt">=</span> <span class="hl kwb">location</span>.react_after
        <span class="hl kwa">if</span> r
        {
<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; <span class="hl kwb">location</span>.<span class="hl kwb">name</span>;
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">location</span>; <span class="hl str">&quot;]&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;.react_after returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                }
<span class="hl ppc">#endif</span>
        }

        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> <span class="hl kwb">location</span>
        {
                r <span class="hl opt">=</span> i.react_after
                <span class="hl kwa">if</span> r
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">[&quot;</span>; i.<span class="hl kwb">name</span>;
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_OBJNUM
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> i; <span class="hl str">&quot;]&quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.react_after returned &quot;</span>; <span class="hl kwa">number</span> r; <span class="hl str">&quot;]</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                }
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! AnyVerb(obj)</span>
<span class="hl slc">! returns &lt;obj&gt; if the verbroutine global applies to a verb as opposed to</span>
<span class="hl slc">! an xverb; otherwise returns false</span>

<span class="hl kwa">routine</span> AnyVerb(obj)
{
<span class="hl ppc">#ifclear NO_XVERBS</span>
        <span class="hl kwa">if</span> parser_data[VERB_IS_XVERB]
                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
<span class="hl ppc">#endif</span>
        <span class="hl kwa">if</span> obj
                <span class="hl kwa">return</span> obj
        <span class="hl kwa">else</span>
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! VerbHeldMode(word)</span>
<span class="hl slc">! returns -1 if a verb requires an explicitly notheld object, 1 for an</span>
<span class="hl slc">! explicitly held object, or 0 for no explicit requirement.</span>

<span class="hl kwa">routine</span> VerbHeldMode(w)
{
        <span class="hl kwa">if</span> w <span class="hl opt">=</span> <span class="hl str">&quot;get&quot;</span>, <span class="hl str">&quot;take&quot;</span>, <span class="hl str">&quot;grab&quot;</span>, <span class="hl str">&quot;pick&quot;</span>, <span class="hl str">&quot;remove&quot;</span>
        {
                <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span>                       <span class="hl slc">! explicitly notheld</span>
        }
        <span class="hl kwa">elseif</span> w <span class="hl opt">=</span> <span class="hl str">&quot;drop&quot;</span>, <span class="hl str">&quot;put&quot;</span>, <span class="hl str">&quot;leave&quot;</span>, <span class="hl str">&quot;place&quot;</span>, <span class="hl str">&quot;throw&quot;</span>, <span class="hl str">&quot;insert&quot;</span>,
                <span class="hl str">&quot;give&quot;</span>, <span class="hl str">&quot;offer&quot;</span>
        {
                <span class="hl kwa">return</span> <span class="hl num">1</span>                        <span class="hl slc">! explicitly held</span>
        }
        <span class="hl kwa">return</span> <span class="hl num">0</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! InList(object, property, val)</span>
<span class="hl slc">! returns false if &lt;val&gt; is not contained in the list of values held in</span>
<span class="hl slc">! &lt;object&gt;.&lt;property&gt;; otherwise returns the number of the (first) property</span>
<span class="hl slc">! element equal to &lt;val&gt;</span>

<span class="hl kwa">routine</span> InList(obj, prop, val)
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#prop; i++)</span>
        {
                <span class="hl kwa">if</span> obj.prop <span class="hl ppc">#i = val:  return i</span>
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! IsPossibleXobject(obj)</span>
<span class="hl slc">! returns true if &lt;obj&gt; is potentially an xobject</span>

<span class="hl kwa">routine</span> IsPossibleXobject(obj)
{
        <span class="hl kwa">local</span> i
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;</span><span class="hl kwb">words</span>; i<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[i] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                {
                        i<span class="hl opt">--</span>
                        <span class="hl kwa">break</span>
                }
        }
        <span class="hl kwa">if</span> ObjWord(<span class="hl kwa">word</span>[i], obj)
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! FindObject(object, object location)</span>
<span class="hl slc">! returns false if &lt;object&gt; is unavailable in &lt;object location&gt;; returns</span>
<span class="hl slc">! 2 if &lt;object&gt; is visible but not physically accessible</span>

<span class="hl kwa">routine</span> FindObject(obj, objloc, recurse)
{
        <span class="hl kwa">local</span> a, p
        <span class="hl kwa">local</span> this_parse_rank
        <span class="hl kwa">local</span> found_result <span class="hl opt">=</span> <span class="hl kwc">true</span>

        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> nothing <span class="hl kwa">or</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span>
        {
                <span class="hl kwa">if</span> obj <span class="hl opt">=</span> nothing <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[Resetting FindObject]&quot;</span>
                        }
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = 0]&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> <span class="hl num">0</span>
                        parser_data[PARSE_RANK_TESTS] <span class="hl opt">=</span> <span class="hl num">0</span>
                        parser_data[PARSER_STATUS] <span class="hl opt">&amp;=</span> ~FINDOBJECT_KNOWN
                        parser_data[PARSER_STATUS] <span class="hl opt">&amp;=</span> ~FINDOBJECT_NONLIVING
                }
                <span class="hl kwa">elseif</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span>
                {
                        this_parse_rank <span class="hl opt">=</span> obj.parse_rank
                        <span class="hl kwa">if</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                                parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> this_parse_rank
                }

                <span class="hl slc">! nothing and player are always available</span>
                obj <span class="hl kwa">is</span> known
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }

<span class="hl ppc">#ifclear NO_FUSES</span>
        <span class="hl kwa">if</span> obj.type <span class="hl opt">=</span> fuse <span class="hl kwa">or</span> obj.type <span class="hl opt">=</span> daemon
        {
                <span class="hl slc">! Optimize checking of simple fuses and daemons:</span>
                <span class="hl kwa">if</span> obj.<span class="hl ppc">#in_scope = 1 and not &amp;obj.in_scope and not obj.#found_in and not &amp;obj.found_in</span>
                {
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> active <span class="hl kwa">and</span> obj.in_scope <span class="hl opt">=</span> <span class="hl kwb">player</span>
                                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                }
        }
<span class="hl ppc">#endif</span>

        <span class="hl slc">! Do some parse_rank tweaking to rank lower objects which (probably) don&#39;t</span>
        <span class="hl slc">! apply to a particular command, like trying to open something that&#39;s</span>
        <span class="hl slc">! already open:</span>
        this_parse_rank <span class="hl opt">=</span> obj.parse_rank

        <span class="hl slc">! And be ready to prefer the last specifically referred to object in</span>
        <span class="hl slc">! the event of disambiguation</span>
        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> parser_data[LAST_SINGLE_OBJECT]
                this_parse_rank<span class="hl opt">++</span>

<span class="hl ppc">#ifclear NO_VERBS</span>
        <span class="hl kwa">select</span> <span class="hl kwb">verbroutine</span>
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoOpen
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> openable <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> open
                        this_parse_rank<span class="hl opt">--</span>
        }
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoClose
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> openable <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> open
                        this_parse_rank<span class="hl opt">--</span>
        }
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoSwitchOn
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> switchable <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> switchedon
                        this_parse_rank<span class="hl opt">--</span>
        }
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoSwitchOff
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> switchable <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> switchedon
                        this_parse_rank<span class="hl opt">--</span>
        }
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoWear
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> clothing <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> worn
                        this_parse_rank<span class="hl opt">--</span>
        }
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DoTakeOff
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> clothing <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> worn
                        this_parse_rank<span class="hl opt">--</span>
        }
<span class="hl ppc">#endif</span>  <span class="hl slc">! #ifclear NO_VERBS</span>
<span class="hl ppc"></span>
<span class="hl ppc">#ifset USE_CHECKHELD</span>
        <span class="hl kwa">if</span> checkheld <span class="hl kwa">is</span> active
        {
                <span class="hl kwa">if</span> checkheld <span class="hl kwa">is</span> plural          <span class="hl slc">! &gt;DROP ALL, etc. ...</span>
                {
                        <span class="hl kwa">if</span> (<span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoDrop_CheckHeld, <span class="hl opt">&amp;</span>DoPutonGround_CheckHeld) <span class="hl kwa">or</span>
                                (<span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoPutIn_CheckHeld <span class="hl kwa">and</span> <span class="hl kwb">xobject</span>)
                        {
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> checkheld_flag
                                {
<span class="hl ppc">#ifset DEBUG</span>
                                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT
                                        {
                                                <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                                        objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                                        <span class="hl str">&quot;false (not checkheld_flag)]&quot;</span>
                                        }
<span class="hl ppc">#endif</span>
                                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                                }
                        }
                }
                <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> checkheld_flag    <span class="hl slc">! ...or &gt;DROP OBJECT, etc.</span>
                {
                        <span class="hl kwa">if</span> (<span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoDrop_CheckHeld, <span class="hl opt">&amp;</span>DoPutonGround_CheckHeld) <span class="hl kwa">or</span>
                                (<span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoPutIn_CheckHeld <span class="hl kwa">and</span> <span class="hl kwb">xobject</span>)
                        {
                                this_parse_rank <span class="hl opt">+=</span> <span class="hl num">100</span>
                        }
                }
        }
<span class="hl ppc">#endif</span>  <span class="hl slc">! USE_CHECKHELD</span>
<span class="hl ppc"></span>
        <span class="hl slc">! The objloc argument is equal to 0 if a) the grammar token is</span>
        <span class="hl slc">! &quot;anything&quot;, or b) the engine is re-testing object availability</span>
        <span class="hl slc">! given the setting of parser_data[BEST_PARSE_RANK] during the first</span>
        <span class="hl slc">! pass of object disambiguation.</span>

        <span class="hl kwa">if</span> objloc <span class="hl opt">=</span> <span class="hl num">0</span>
        {
<span class="hl ppc">#ifclear NO_VERBS</span>
                <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoGet <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                {
                        <span class="hl kwa">if</span> obj <span class="hl kwa">in</span> <span class="hl kwb">player</span>
                        {
<span class="hl ppc">#ifset DEBUG</span>
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                                objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                                <span class="hl str">&quot;false (object in player)]&quot;</span>
                                }
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                        }
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">if</span> <span class="hl kwb">location</span>
                {
                        <span class="hl kwa">if</span> FindObject(obj, <span class="hl kwb">location</span>, <span class="hl kwc">true</span>)
                                <span class="hl kwb">object</span> <span class="hl kwa">is</span> known
                }

                <span class="hl kwa">if</span> <span class="hl kwa">not</span> ObjectIsKnown(obj)
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                        objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                        <span class="hl str">&quot;false (object not &#39;known&#39;)]&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                }

                <span class="hl kwa">if</span> <span class="hl kwa">not</span> recurse
                {
                        <span class="hl kwa">if</span> parser_data[PARSE_RANK_TESTS]<span class="hl opt">++</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                        {
<span class="hl ppc">#ifset DEBUG</span>
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                                objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                                <span class="hl str">&quot;true]&quot;</span>
                                }
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK <span class="hl kwa">and</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = &quot;</span>; <span class="hl kwa">number</span> this_parse_rank; <span class="hl str">&quot;]&quot;</span>
                                }
<span class="hl ppc">#endif</span>
                                parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> this_parse_rank
                                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                        }

                        <span class="hl kwa">if</span> this_parse_rank <span class="hl opt">&lt;</span> parser_data[BEST_PARSE_RANK]
                        {
<span class="hl ppc">#ifset DEBUG</span>
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                                objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                                <span class="hl str">&quot;false (this_parse_rank = &quot;</span>; <span class="hl kwa">number</span> this_parse_rank; \
                                                <span class="hl str">&quot; &lt; parser_data[BEST_PARSE_RANK] = &quot;</span>; <span class="hl kwa">number</span> parser_data[BEST_PARSE_RANK]; <span class="hl str">&quot;)]&quot;</span>
                                }
<span class="hl ppc">#endif</span>
                                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                        }
                        <span class="hl kwa">else</span>
                        {
<span class="hl ppc">#ifset DEBUG</span>
                                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK <span class="hl kwa">and</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = &quot;</span>; <span class="hl kwa">number</span> this_parse_rank; <span class="hl str">&quot;]&quot;</span>
                                }
<span class="hl ppc">#endif</span>
                                parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> this_parse_rank
                        }
                }

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                <span class="hl str">&quot;true]&quot;</span>
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }

        <span class="hl kwa">if</span> <span class="hl kwa">word</span>[<span class="hl num">2</span>] <span class="hl opt">=</span> <span class="hl str">&quot;~all&quot;</span> <span class="hl kwa">or</span> <span class="hl kwa">word</span>[<span class="hl num">3</span>] <span class="hl opt">=</span> <span class="hl str">&quot;~all&quot;</span> <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
        {
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> IsPossibleXobject(obj) <span class="hl kwa">or</span> (<span class="hl kwb">xobject</span> <span class="hl kwa">and</span> <span class="hl kwb">xobject</span> <span class="hl opt">~=</span> obj)
                {
                        a <span class="hl opt">=</span> obj.exclude_from_all
                        <span class="hl kwa">if</span> a <span class="hl opt">&lt;</span> <span class="hl num">2</span>
                        {
                                <span class="hl kwa">if</span> a <span class="hl kwa">or</span> ExcludeFromAll(obj) <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                {
<span class="hl ppc">#ifset DEBUG</span>
                                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
                                        {
                                                <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                                        objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                                        <span class="hl str">&quot;false (excluded from</span> <span class="hl esc">\&quot;</span><span class="hl str">all</span><span class="hl esc">\&quot;</span><span class="hl str">)]&quot;</span>
                                        }
<span class="hl ppc">#endif</span>
                                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
                                }
                        }
                }
        }

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> living
                parser_data[PARSER_STATUS] <span class="hl opt">|=</span> FINDOBJECT_NONLIVING

        p <span class="hl opt">=</span> <span class="hl kwa">parent</span>(obj)

        <span class="hl slc">! If any object FindObject is attempting to disambiguate</span>
        <span class="hl slc">! is known, make a note of it (if during the parsing phase)</span>
        <span class="hl kwa">if</span> parser_data[PARSER_STATUS] <span class="hl opt">&amp;</span> PARSER_ACTIVE
        {
                <span class="hl kwa">if</span> ObjectisKnown(obj)
                        parser_data[PARSER_STATUS] <span class="hl opt">|=</span> FINDOBJECT_KNOWN
        }

        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> objloc <span class="hl kwa">or</span>
                (<span class="hl kwb">player</span> <span class="hl kwa">in</span> obj <span class="hl kwa">and</span> obj <span class="hl opt">~=</span> objloc <span class="hl kwa">and</span> (obj<span class="hl opt">~=</span><span class="hl kwb">location</span> <span class="hl kwa">or</span> <span class="hl kwa">not</span> recurse)) <span class="hl kwa">or</span>
                p <span class="hl opt">=</span> obj <span class="hl kwa">or</span> p <span class="hl opt">=</span> objloc <span class="hl kwa">or</span> p <span class="hl opt">=</span> <span class="hl kwb">player</span>
        {
                obj <span class="hl kwa">is</span> known
                <span class="hl kwa">jump</span> FindObjectFound
        }
        <span class="hl kwa">elseif</span> (p <span class="hl kwa">is</span> <span class="hl kwa">not</span> openable <span class="hl kwa">or</span> p <span class="hl kwa">is</span> platform) <span class="hl kwa">and</span> p <span class="hl kwa">is</span> <span class="hl kwa">not</span> quiet <span class="hl kwa">and</span>
                p <span class="hl opt">~=</span> nothing
        {
                <span class="hl kwa">if</span> FindObject(p, objloc, <span class="hl kwc">true</span>) <span class="hl kwa">and</span> ObjectisKnown(p)
                {
                        obj <span class="hl kwa">is</span> known
                        <span class="hl kwa">jump</span> FindObjectFound
                }
        }
        <span class="hl kwa">elseif</span> p <span class="hl kwa">is</span> openable <span class="hl kwa">and</span> p <span class="hl kwa">is</span> open <span class="hl kwa">and</span> p <span class="hl kwa">is</span> <span class="hl kwa">not</span> quiet <span class="hl kwa">and</span>
                p <span class="hl opt">~=</span> nothing
        {
                <span class="hl kwa">if</span> FindObject(p, objloc, <span class="hl kwc">true</span>) <span class="hl kwa">and</span> ObjectisKnown(p)
                {
                        obj <span class="hl kwa">is</span> known
                        <span class="hl kwa">jump</span> FindObjectFound
                }
        }
        <span class="hl kwa">elseif</span> (p <span class="hl kwa">is</span> openable, <span class="hl kwa">not</span> open, transparent, <span class="hl kwa">not</span> quiet) <span class="hl kwa">and</span>
                p <span class="hl opt">~=</span> nothing
        {
                <span class="hl kwa">if</span> FindObject(p, objloc, <span class="hl kwc">true</span>) <span class="hl kwa">and</span> ObjectisKnown(p)
                {
                        obj <span class="hl kwa">is</span> known
                        found_result <span class="hl opt">=</span> <span class="hl num">2</span>
                        <span class="hl kwa">jump</span> FindObjectFound
                }
        }

        <span class="hl kwa">if</span> obj.<span class="hl ppc">#found_in</span>
        {
                <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#found_in; a++)</span>
                {
                        <span class="hl kwa">if</span> obj.found_in <span class="hl ppc">#a and (obj.found_in #a = objloc or</span>
                                FindObject(obj.found_in <span class="hl ppc">#a, objloc, true))</span>
                        {
                                obj <span class="hl kwa">is</span> known
                                <span class="hl kwa">jump</span> FindObjectFound
                        }
                }
        }

        <span class="hl kwa">if</span> obj.<span class="hl ppc">#in_scope</span>
        {
                <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#in_scope; a++)</span>
                {
                        <span class="hl kwa">if</span> obj.in_scope <span class="hl ppc">#a</span>
                        {
                                <span class="hl kwa">if</span> obj.in_scope <span class="hl ppc">#a=objloc or obj.in_scope #a=actor</span>
                                {
                                        obj <span class="hl kwa">is</span> known
                                        <span class="hl kwa">jump</span> FindObjectFound
                                }
                                <span class="hl kwa">if</span> FindObject(obj.in_scope <span class="hl ppc">#a, objloc, true)</span>
                                {
                                        obj <span class="hl kwa">is</span> known
                                        <span class="hl kwa">jump</span> FindObjectFound
                                }
                        }
                }
        }

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
        {
                <span class="hl kwa">if</span> obj.type <span class="hl opt">~=</span> fuse <span class="hl kwa">and</span> obj.type <span class="hl opt">~=</span> daemon
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                                objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                                <span class="hl str">&quot;false]&quot;</span>
                }
        }
<span class="hl ppc">#endif</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>

:FindObjectFound
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> recurse
        {
                <span class="hl kwa">if</span> parser_data[PARSE_RANK_TESTS]<span class="hl opt">++</span> <span class="hl opt">=</span> <span class="hl num">0</span>
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK <span class="hl kwa">and</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = &quot;</span>; <span class="hl kwa">number</span> this_parse_rank; <span class="hl str">&quot;]&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> this_parse_rank
                }
                <span class="hl kwa">elseif</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                {
<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_PARSE_RANK <span class="hl kwa">and</span> this_parse_rank <span class="hl opt">&gt;</span> parser_data[BEST_PARSE_RANK]
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[parser_data[BEST_PARSE_RANK] = &quot;</span>; <span class="hl kwa">number</span> this_parse_rank; <span class="hl str">&quot;]&quot;</span>
                        }
<span class="hl ppc">#endif</span>
                        parser_data[BEST_PARSE_RANK] <span class="hl opt">=</span> this_parse_rank
                }
        }
<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FINDOBJECT <span class="hl kwa">and</span> <span class="hl kwa">not</span> recurse
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[FindObject(&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> obj; <span class="hl str">&quot;], &quot;</span>; \
                        objloc.<span class="hl kwb">name</span>; <span class="hl str">&quot; [&quot;</span>; <span class="hl kwa">number</span> objloc; <span class="hl str">&quot;]):  &quot;</span>; \
                        <span class="hl str">&quot;true]&quot;</span>
        }
<span class="hl ppc">#endif</span>
        <span class="hl kwa">return</span> found_result
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ObjectIsKnown(obj)</span>
<span class="hl slc">! If it is undesirable to use the rules for disqualifying hitherto unknown</span>
<span class="hl slc">! objects from player actions, replace ObjectisKnown with a routine that</span>
<span class="hl slc">! always returns a true value.</span>

<span class="hl kwa">routine</span> ObjectIsKnown(obj)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> known
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ExcludeFromAll(obj)</span>
<span class="hl slc">! If global decision rules are desired for &quot;all&quot; actions, replace</span>
<span class="hl slc">! ExcludeFromAll, returning true if &lt;obj&gt; is to be excluded.  Return 2 to</span>
<span class="hl slc">! force the INCLUSION of &lt;obj&gt;.</span>

<span class="hl kwa">routine</span> ExcludeFromAll(obj)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> hidden
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! PutInScope(object, actor)</span>
<span class="hl slc">! makes &lt;object&gt; accessible to &lt;actor&gt; (where &lt;actor&gt; is usually the player)</span>
<span class="hl slc">! provided that &lt;object&gt; has an in_scope property with an empty slot--i.e.</span>
<span class="hl slc">! one that equals 0; returns false if &lt;object&gt; cannot be placed in scope</span>
<span class="hl slc">! of &lt;actor&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! RemoveFromScope(object, actor)</span>
<span class="hl slc">! removes &lt;object&gt; from the scope of &lt;actor&gt;</span>

<span class="hl kwa">routine</span> PutInScope(obj, act)
{
        <span class="hl kwa">local</span> a

        <span class="hl kwa">if</span> act <span class="hl opt">=</span> <span class="hl num">0</span>:  act <span class="hl opt">=</span> <span class="hl kwb">player</span>
        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#in_scope; a++)</span>
        {
                <span class="hl kwa">if</span> obj.in_scope <span class="hl ppc">#a = 0</span>
                {
                        obj.in_scope <span class="hl ppc">#a = act</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                }
        }
}

<span class="hl kwa">routine</span> RemoveFromScope(obj, act)
{
        <span class="hl kwa">local</span> a

        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#in_scope; a++)</span>
        {
                <span class="hl kwa">if</span> obj.in_scope <span class="hl ppc">#a = act or act = 0</span>
                {
                        obj.in_scope <span class="hl ppc">#a = 0</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                }
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! AssignPronoun(object)</span>
<span class="hl slc">! sets the appropriate pronoun global to &lt;object&gt;</span>

<span class="hl kwa">routine</span> AssignPronoun(obj)
{
<span class="hl ppc">#ifclear OLD_STYLE_PRONOUNS</span>
        <span class="hl kwa">if</span> obj <span class="hl opt">&gt;=</span> it_object <span class="hl kwa">and</span> obj <span class="hl opt">&lt;=</span> them_object
                <span class="hl kwa">return</span>
<span class="hl ppc">#endif</span>
        <span class="hl kwa">if</span> parser_data[PARSER_STATUS] <span class="hl opt">&amp;</span> PRONOUNS_SET:  <span class="hl kwa">return</span>
        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span>:  <span class="hl kwa">return</span>

        <span class="hl slc">! No use if you can&#39;t refer to it</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> obj.<span class="hl ppc">#noun and not obj.#adjective</span>
                <span class="hl kwa">return</span>

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> living
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> plural
                        it_obj <span class="hl opt">=</span> obj
                <span class="hl kwa">else</span>
                        them_obj <span class="hl opt">=</span> obj
        }
        <span class="hl kwa">else</span>
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> plural
                        them_obj <span class="hl opt">=</span> obj
                <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> female
                        her_obj <span class="hl opt">=</span> obj
                <span class="hl kwa">else</span>
                        him_obj <span class="hl opt">=</span> obj
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! PrintStatusline</span>
<span class="hl slc">! prints an appropriate statusline as specified by global STATUSTYPE</span>

<span class="hl kwa">routine</span> PrintStatusline
{
        <span class="hl kwa">if</span> display.linelength <span class="hl opt">&lt;</span> <span class="hl num">80</span>
                display.statusline_height <span class="hl opt">=</span> <span class="hl num">2</span>
        <span class="hl kwa">else</span>
                display.statusline_height <span class="hl opt">=</span> <span class="hl num">1</span>

        Font(BOLD_OFF <span class="hl opt">|</span> ITALIC_OFF <span class="hl opt">|</span> UNDERLINE_OFF <span class="hl opt">|</span> PROP_OFF)
        <span class="hl kwa">window</span> display.statusline_height
        {
                <span class="hl kwa">color</span> SL_TEXTCOLOR, SL_BGCOLOR
                <span class="hl kwa">cls</span>
                <span class="hl kwa">locate</span> <span class="hl num">1</span>, <span class="hl num">1</span>
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwb">location</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\_</span><span class="hl str">&quot;</span>;
                <span class="hl kwa">elseif</span> <span class="hl kwa">not</span> light_source
                        <span class="hl kwa">print</span> <span class="hl str">&quot;In the dark&quot;</span>;
                <span class="hl kwa">else</span>
                {
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> DESCFORM_F:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\_</span><span class="hl str">&quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">capital</span> <span class="hl kwb">location</span>.<span class="hl kwb">name</span>;
                }

                <span class="hl kwa">if</span> display.statusline_height <span class="hl opt">=</span> <span class="hl num">1</span>
                        <span class="hl kwa">print</span> <span class="hl kwa">to</span> <span class="hl num">65</span>;
                <span class="hl kwa">else</span>
                {
                        <span class="hl kwa">locate</span> <span class="hl num">1</span>, <span class="hl num">2</span>
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> DESCFORM_F:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\_</span><span class="hl str">&quot;</span>;
                }

                <span class="hl kwa">if</span> STATUSTYPE <span class="hl opt">=</span> <span class="hl num">1</span>
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> score; <span class="hl str">&quot; / &quot;</span>; <span class="hl kwa">number</span> counter;
                <span class="hl kwa">elseif</span> STATUSTYPE <span class="hl opt">=</span> <span class="hl num">2</span>
                        <span class="hl kwa">print</span> HoursMinutes(counter);
        }
        <span class="hl kwa">color</span> TEXTCOLOR, BGCOLOR
        Font(DEFAULT_FONT)
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! HoursMinutes(val[, military])</span>
<span class="hl slc">! prints the time in 12-hour hh:mm format, as given by &lt;val&gt; minutes past</span>
<span class="hl slc">! midnight, or in 24-hour hh:mm military-time format if &lt;military&gt; is true</span>

<span class="hl kwa">routine</span> HoursMinutes(val, military)
{
        <span class="hl kwa">local</span> hours, minutes

        hours <span class="hl opt">=</span> val <span class="hl opt">/</span> <span class="hl num">60</span>
        minutes <span class="hl opt">=</span> val <span class="hl opt">-</span> hours <span class="hl opt">*</span> <span class="hl num">60</span>

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> military
        {
                <span class="hl kwa">if</span> hours <span class="hl opt">&gt;</span> <span class="hl num">12</span>:     hours <span class="hl opt">-=</span> <span class="hl num">12</span>
                <span class="hl kwa">elseif</span> hours <span class="hl opt">=</span> <span class="hl num">0</span>:  hours <span class="hl opt">=</span> <span class="hl num">12</span>
        }
        <span class="hl kwa">elseif</span> hours <span class="hl opt">&lt;</span> <span class="hl num">10</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;0&quot;</span>;

        <span class="hl kwa">print</span> <span class="hl kwa">number</span> hours; <span class="hl str">&quot;:&quot;</span>;
        <span class="hl kwa">if</span> minutes <span class="hl opt">&lt;</span> <span class="hl num">10</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;0&quot;</span>;
        <span class="hl kwa">print</span> <span class="hl kwa">number</span> minutes; <span class="hl str">&quot; &quot;</span>;

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> military
        {
                <span class="hl kwa">if</span> val <span class="hl opt">&gt;=</span> <span class="hl num">720</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;p.m.&quot;</span>;
                <span class="hl kwa">else</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;a.m.&quot;</span>;
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! The(object)                           ! prints &quot;the &lt;object&gt;&quot;</span>
<span class="hl slc">!</span>
<span class="hl slc">! When the player is in the first person, pass a second, non-false argument</span>
<span class="hl slc">! to generate &quot;me&quot; instead of &quot;I&quot;.</span>

<span class="hl kwa">routine</span> The(obj, a)
{
        AssignPronoun(obj)

        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span> <span class="hl kwa">and</span> player_person <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> a
        {
                <span class="hl kwa">print</span> <span class="hl kwb">player</span>.pronoun <span class="hl ppc">#2;</span>
                <span class="hl kwa">return</span>
        }

        <span class="hl kwa">if</span> obj.<span class="hl kwb">article</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;the &quot;</span>;
        <span class="hl kwa">print</span> obj.<span class="hl kwb">name</span>;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CThe(object)                          ! prints &quot;The &lt;object&gt;&quot;</span>

<span class="hl kwa">routine</span> CThe(obj)
{
        AssignPronoun(obj)

        <span class="hl kwa">if</span> obj.<span class="hl kwb">article</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;The &quot;</span>; obj.<span class="hl kwb">name</span>;
        <span class="hl kwa">else</span>
                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> obj.<span class="hl kwb">name</span>;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Art(object)</span>

<span class="hl kwa">routine</span> Art(obj, a)                     <span class="hl slc">! prints, for example, &quot;an &lt;object&gt;&quot;</span>
{
        AssignPronoun(obj)

        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span> <span class="hl kwa">and</span> player_person <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> a
        {
                <span class="hl kwa">print</span> <span class="hl kwb">player</span>.pronoun <span class="hl ppc">#2;</span>
                <span class="hl kwa">return</span>
        }

        <span class="hl kwa">if</span> obj.<span class="hl kwb">article</span>
                <span class="hl kwa">print</span> obj.<span class="hl kwb">article</span>; <span class="hl str">&quot; &quot;</span>;
        <span class="hl kwa">print</span> obj.<span class="hl kwb">name</span>;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CArt(object)                          ! prints, for example, &quot;An &lt;object&gt;&quot;</span>

<span class="hl kwa">routine</span> CArt(obj)
{
        AssignPronoun(obj)

        <span class="hl kwa">if</span> obj.<span class="hl kwb">article</span>
                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> obj.<span class="hl kwb">article</span>; <span class="hl str">&quot; &quot;</span>; obj.<span class="hl kwb">name</span>;
        <span class="hl kwa">else</span>
                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> obj.<span class="hl kwb">name</span>;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! IsorAre(object, [optional parameter])</span>
<span class="hl slc">! prints &quot;is&quot; or &quot;are&quot; (or &quot;&#39;s&quot; or &quot;&#39;re&quot;) to agree with &lt;object&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! IsorAre(object, true)</span>
<span class="hl slc">! forces use of &quot;is&quot; and &quot;are&quot; instead of &quot;&#39;s&quot; and &quot;&#39;re&quot;</span>

<span class="hl kwa">routine</span> IsorAre(obj, a)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> plural
        {
                <span class="hl slc">! Assuming a first-person player object is &#39;plural&#39;</span>
                <span class="hl kwa">if</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span> <span class="hl kwa">and</span> player_person <span class="hl opt">=</span> <span class="hl num">1</span>
                {
                        <span class="hl kwa">if</span> a:  <span class="hl kwa">print</span> <span class="hl str">&quot; am&quot;</span>;
                        <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;&#39;m&quot;</span>;
                }
                <span class="hl kwa">else</span>
                {
                        <span class="hl kwa">if</span> player_person <span class="hl opt">=</span> <span class="hl num">3</span>:  a <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        <span class="hl kwa">if</span> a:  <span class="hl kwa">print</span> <span class="hl str">&quot; are&quot;</span>;
                        <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;&#39;re&quot;</span>;
                }
        }
        <span class="hl kwa">else</span>
        {
                <span class="hl kwa">if</span> a:  <span class="hl kwa">print</span> <span class="hl str">&quot; is&quot;</span>;
                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;&#39;s&quot;</span>;
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! MatchSubject(object)</span>
<span class="hl slc">! conjugates a present-tense verb to agree with &lt;object&gt;</span>

<span class="hl kwa">routine</span> MatchSubject(obj)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> plural
                <span class="hl kwa">print</span> <span class="hl str">&quot;s&quot;</span>;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! MatchPlural(object, word1, word2)</span>
<span class="hl slc">! prints &lt;word1&gt; if &lt;object&gt; is singular or &lt;word2&gt; if &lt;object&gt; is plural</span>

<span class="hl kwa">routine</span> MatchPlural(obj, word1, word2)
{
        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> plural
                <span class="hl kwa">print</span> word1;
        <span class="hl kwa">else</span>
                <span class="hl kwa">print</span> word2;
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! NumberWord(number)</span>
<span class="hl slc">! prints a number in non-numerical word format, where &lt;number&gt; is between</span>
<span class="hl slc">! -32768 to 32767</span>
<span class="hl slc">!</span>
<span class="hl slc">! NumberWord(number, true)</span>
<span class="hl slc">! prints the word beginning with a capital letter if a second (true)</span>
<span class="hl slc">! argument is provided</span>

<span class="hl kwa">routine</span> NumberWord(n, cap)
{
        <span class="hl kwa">local</span> remaining, place, printed_tens

        <span class="hl kwa">if</span> n <span class="hl opt">=</span> <span class="hl num">0</span>
        {
                <span class="hl kwa">if</span> cap:  <span class="hl kwa">print</span> <span class="hl kwa">capital</span> DigitWord(n);
                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> DigitWord(n);
                <span class="hl kwa">return</span>
        }
        <span class="hl kwa">if</span> n <span class="hl opt">&lt;</span> <span class="hl num">0</span>
        {
                <span class="hl kwa">if</span> cap:  <span class="hl kwa">print</span> <span class="hl str">&quot;Minus &quot;</span>;
                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;minus &quot;</span>;
                n <span class="hl opt">=</span> <span class="hl opt">-</span>n
                cap <span class="hl opt">=</span> <span class="hl num">0</span>
        }

        place <span class="hl opt">=</span> <span class="hl num">1000</span>
        <span class="hl kwa">while</span> n
        {
                <span class="hl kwa">if</span> n <span class="hl opt">&gt;=</span> place
                {
                        <span class="hl kwa">if</span> remaining
                        {
                                <span class="hl kwa">if</span> place <span class="hl opt">=</span> <span class="hl num">100</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>;
                                <span class="hl kwa">elseif</span> place <span class="hl opt">=</span> <span class="hl num">10</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD; <span class="hl str">&quot; &quot;</span>;
                                <span class="hl kwa">elseif</span> place <span class="hl opt">=</span> <span class="hl num">1</span>
                                {
                                        <span class="hl kwa">if</span> printed_tens
                                                <span class="hl kwa">print</span> <span class="hl str">&quot;-&quot;</span>;
                                        <span class="hl kwa">else</span>
                                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD; <span class="hl str">&quot; &quot;</span>;
                                }
                        }

                        <span class="hl kwa">if</span> place <span class="hl opt">&gt;=</span> <span class="hl num">100</span>
                        {
                                <span class="hl kwa">if</span> cap:  NumberWord(n<span class="hl opt">/</span>place, <span class="hl kwc">true</span>)
                                <span class="hl kwa">else</span>:  NumberWord(n<span class="hl opt">/</span>place)
                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; DigitWord(place);
                                n <span class="hl opt">=</span> n<span class="hl opt">-</span>n<span class="hl opt">/</span>place<span class="hl opt">*</span>place
                        }
                        <span class="hl kwa">elseif</span> place <span class="hl opt">=</span> <span class="hl num">10</span> <span class="hl kwa">and</span> (n <span class="hl opt">&gt;=</span> <span class="hl num">20</span>)
                        {
                                <span class="hl kwa">if</span> cap:  <span class="hl kwa">print</span> <span class="hl kwa">capital</span> DigitWord(n<span class="hl opt">/</span><span class="hl num">10</span><span class="hl opt">*</span><span class="hl num">10</span>);
                                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> DigitWord(n<span class="hl opt">/</span><span class="hl num">10</span><span class="hl opt">*</span><span class="hl num">10</span>);
                                n <span class="hl opt">=</span> n<span class="hl opt">-</span>n<span class="hl opt">/</span>place<span class="hl opt">*</span>place
                                printed_tens <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">if</span> cap:  <span class="hl kwa">print</span> <span class="hl kwa">capital</span> DigitWord(n);
                                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> DigitWord(n);
                                n <span class="hl opt">=</span> <span class="hl num">0</span>
                        }
                        cap <span class="hl opt">=</span> <span class="hl num">0</span>
                        remaining <span class="hl opt">=</span> <span class="hl kwc">true</span>
                }
                place <span class="hl opt">=</span> place<span class="hl opt">/</span><span class="hl num">10</span>
        }
}

<span class="hl kwa">routine</span> DigitWord(n)
{
        <span class="hl kwa">select</span> n
        <span class="hl kwa">case</span> <span class="hl num">0</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;zero&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">1</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;one&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">2</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;two&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">3</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;three&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">4</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;four&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">5</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;five&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">6</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;six&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">7</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;seven&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">8</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;eight&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">9</span>:         <span class="hl kwa">return</span> <span class="hl str">&quot;nine&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">10</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;ten&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">11</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;eleven&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">12</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;twelve&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">13</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;thirteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">14</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;fourteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">15</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;fifteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">16</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;sixteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">17</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;seventeen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">18</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;eighteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">19</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;nineteen&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">20</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;twenty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">30</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;thirty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">40</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;forty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">50</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;fifty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">60</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;sixty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">70</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;seventy&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">80</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;eighty&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">90</span>:        <span class="hl kwa">return</span> <span class="hl str">&quot;ninety&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">100</span>:       <span class="hl kwa">return</span> <span class="hl str">&quot;hundred&quot;</span>
        <span class="hl kwa">case</span> <span class="hl num">1000</span>:      <span class="hl kwa">return</span> <span class="hl str">&quot;thousand&quot;</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! StringToNumber(word)</span>
<span class="hl slc">! returns the numerical value of a word such as &quot;100&quot;; note that it returns</span>
<span class="hl slc">! 0 for any non-number, not just &quot;0&quot;</span>

<span class="hl kwa">routine</span> StringToNumber(w)
{
        <span class="hl kwa">local</span> len, val, n, factor <span class="hl opt">=</span> <span class="hl num">1</span>
        len <span class="hl opt">=</span> <span class="hl kwa">string</span>(_temp_string, w, <span class="hl num">255</span>)

        <span class="hl kwa">local</span> i
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span>len<span class="hl opt">-</span><span class="hl num">1</span>; i<span class="hl opt">&gt;=</span><span class="hl num">0</span>; i<span class="hl opt">--</span>)
        {
                n <span class="hl opt">=</span> _temp_string[i]
                <span class="hl kwa">if</span> n <span class="hl opt">&gt;=</span> <span class="hl kwc">&#39;0&#39;</span> <span class="hl kwa">and</span> n <span class="hl opt">&lt;=</span> <span class="hl kwc">&#39;9&#39;</span>
                {
                        n <span class="hl opt">-=</span> <span class="hl kwc">&#39;0&#39;</span>
                        val <span class="hl opt">+=</span> (n<span class="hl opt">*</span>factor)
                }
                <span class="hl kwa">elseif</span> i <span class="hl opt">=</span> <span class="hl num">0</span> <span class="hl kwa">and</span> n <span class="hl opt">=</span> <span class="hl kwc">&#39;-&#39;</span>
                {
                        val <span class="hl opt">=</span> <span class="hl opt">-</span>val
                }
                <span class="hl kwa">else</span>
                        <span class="hl kwa">return</span> <span class="hl num">0</span>

                factor <span class="hl opt">*=</span> <span class="hl num">10</span>
        }
        <span class="hl kwa">return</span> val
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Indent</span>
<span class="hl slc">! indents only if the NOINDENT_F bit is not set in the FORMAT mask; returns</span>
<span class="hl slc">! the null word &quot;&quot; (0 or false); if &lt;newl&gt; is true, a newline is printed</span>
<span class="hl slc">! first (if appropriate)</span>

<span class="hl kwa">routine</span> Indent(newl)
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> override_indent <span class="hl kwa">or</span> display.cursor_column <span class="hl opt">&gt;</span> <span class="hl num">1</span>
                <span class="hl kwa">print</span> AFTER_PERIOD;
        <span class="hl kwa">elseif</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NOINDENT_F) <span class="hl kwa">and</span> INDENT_SIZE
        {
                <span class="hl slc">! See display.cursor_column &gt; 1, above</span>
                <span class="hl slc">!print newline</span>

                <span class="hl kwa">if</span> newl
                        <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\_</span><span class="hl str">&quot;</span>;
                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">2</span>; i<span class="hl opt">&lt;=</span>INDENT_SIZE; i<span class="hl opt">++</span>)
                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;
        }
        override_indent <span class="hl opt">=</span> <span class="hl kwc">false</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! DescribePlace(location, [optional parameter])</span>
<span class="hl slc">! prints the location name, followed by the location description, if</span>
<span class="hl slc">! required</span>
<span class="hl slc">!</span>
<span class="hl slc">! DescribePlace(location, true)</span>
<span class="hl slc">! forces a location description</span>

<span class="hl kwa">routine</span> Describeplace(place, long)
{
        <span class="hl kwa">local</span> obj, count, notlisted, tempformat

        parser_data[PARSER_STATUS] <span class="hl opt">&amp;=</span> ~PRONOUNS_SET

        <span class="hl slc">! Since, for example, a room description following entering via</span>
        <span class="hl slc">! DoGo does not trigger before/after properties tied to looking</span>
        <span class="hl slc">! around:</span>
        <span class="hl slc">!</span>
<span class="hl ppc">#ifclear NO_VERBS</span>
        <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">~=</span> <span class="hl opt">&amp;</span>DoLookAround
        {
                <span class="hl kwa">if</span> place <span class="hl kwa">is</span> <span class="hl kwa">not</span> visited <span class="hl kwa">and</span> verbosity <span class="hl opt">~=</span> <span class="hl num">1</span>
                        <span class="hl kwa">return</span> Perform(<span class="hl opt">&amp;</span>DoLookAround)
                <span class="hl kwa">elseif</span> long <span class="hl opt">=</span> <span class="hl kwc">true</span> <span class="hl kwa">or</span> verbosity <span class="hl opt">=</span> <span class="hl num">2</span>
                        <span class="hl kwa">return</span> Perform(<span class="hl opt">&amp;</span>DoLookAround)
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> light_source
        {
                Message(<span class="hl opt">&amp;</span>DescribePlace, <span class="hl num">1</span>)     <span class="hl slc">! &quot;It&#39;s too dark to see...&quot;</span>
                <span class="hl kwa">return</span>
        }

        place <span class="hl kwa">is</span> known

        <span class="hl slc">! Print the name of the location as a heading</span>
        Font(BOLD_ON)
        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>; <span class="hl kwa">capital</span> place.<span class="hl kwb">name</span>;

        <span class="hl slc">! Print &quot;, in &lt;something&gt;&quot; if necessary</span>
        <span class="hl kwa">if</span> <span class="hl kwb">location</span> <span class="hl opt">=</span> place <span class="hl kwa">and</span> <span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> place
        {
                <span class="hl kwa">if</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).prep
                        <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>; <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).prep; <span class="hl str">&quot; &quot;</span>;
                <span class="hl kwa">elseif</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>) <span class="hl kwa">is</span> platform
                        <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>; ON_WORD; <span class="hl str">&quot; &quot;</span>;
                <span class="hl kwa">else</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>; IN_WORD; <span class="hl str">&quot; &quot;</span>;
                <span class="hl kwa">print</span> Art(<span class="hl kwa">parent</span>(<span class="hl kwb">player</span>))
        }
        <span class="hl kwa">print</span> <span class="hl kwa">newline</span>

        Font(BOLD_OFF)
        override_indent <span class="hl opt">=</span> <span class="hl kwc">false</span>

        <span class="hl kwa">if</span> place <span class="hl kwa">is</span> <span class="hl kwa">not</span> visited <span class="hl kwa">and</span> verbosity <span class="hl opt">~=</span> <span class="hl num">1</span>
        {
                <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>place.initial_desc <span class="hl kwa">or</span> <span class="hl opt">&amp;</span>place.long_desc
                        Indent
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> place.initial_desc
                        <span class="hl kwa">run</span> place.long_desc
        }
        <span class="hl kwa">elseif</span> long <span class="hl opt">=</span> <span class="hl kwc">true</span> <span class="hl kwa">or</span> verbosity <span class="hl opt">=</span> <span class="hl num">2</span>
        {
                <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>place.long_desc
                        Indent
                <span class="hl kwa">run</span> place.long_desc
        }

        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>place.list_contents <span class="hl kwa">and</span> FORMAT <span class="hl opt">&amp;</span> DESCFORM_F
                <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>        <span class="hl slc">! for double-space-after-heading formatting</span>

        <span class="hl slc">! A location may contain an overriding listing routine, as may any</span>
        <span class="hl slc">! parent, in the list_contents property</span>
        <span class="hl slc">!</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> place.list_contents
        {
                list_nest <span class="hl opt">=</span> <span class="hl num">0</span>

                <span class="hl slc">! For double-space-after-heading formatting:</span>
                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> DESCFORM_F
                {
                        <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                        {
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden <span class="hl kwa">and</span>
                                        (<span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> obj <span class="hl kwa">or</span> <span class="hl kwa">children</span>(obj) <span class="hl opt">&gt;</span> <span class="hl num">1</span>)
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                                        <span class="hl kwa">break</span>
                                }
                        }
                }

                <span class="hl slc">! List contents of chair, vehicle, etc. player is in</span>
                <span class="hl kwa">if</span> <span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> <span class="hl kwb">location</span>
                {
                        list_nest <span class="hl opt">=</span> <span class="hl num">1</span>
                        WhatsIn(<span class="hl kwa">Parent</span>(<span class="hl kwb">player</span>))
                }

                <span class="hl slc">! List all characters, if any</span>
                count <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> hidden <span class="hl kwa">or</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> living <span class="hl kwa">or</span>
                                <span class="hl kwb">player</span> <span class="hl kwa">in</span> obj
                        {
                                obj <span class="hl kwa">is</span> already_listed
                        }
                        <span class="hl kwa">else</span>
                        {
                                obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                        }
                }
                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                        {
                                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                                ShortDescribe(obj)
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                                        count<span class="hl opt">++</span>
                        }
                }

                list_count <span class="hl opt">=</span> count
                count <span class="hl opt">=</span> <span class="hl num">0</span>

                <span class="hl kwa">if</span> list_count           <span class="hl slc">! if characters are to be listed</span>
                {
                        tempformat <span class="hl opt">=</span> FORMAT
                        FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> FIRSTCAPITAL_F <span class="hl opt">|</span> ISORAREHERE_F
                        FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> USECHARNAMES_F
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                        {
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">&amp;</span> ~LIST_F       <span class="hl slc">! clear it</span>
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> TEMPLIST_F
                        }
                        Indent
                        list_nest <span class="hl opt">=</span> <span class="hl num">0</span>
                        ListObjects(place)
                        FORMAT <span class="hl opt">=</span> tempformat
                }

                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
<span class="hl ppc">#ifset USE_ATTACHABLES</span>
                        <span class="hl slc">! Exclude all attachables for now (and characters)</span>

                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> living <span class="hl kwa">or</span> obj.type <span class="hl opt">=</span> attachable <span class="hl kwa">or</span>
                                <span class="hl kwb">player</span> <span class="hl kwa">in</span> obj
<span class="hl ppc">#else</span>
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> living <span class="hl kwa">or</span> <span class="hl kwb">player</span> <span class="hl kwa">in</span> obj
<span class="hl ppc">#endif</span>
                                obj <span class="hl kwa">is</span> already_listed
                        <span class="hl kwa">else</span>
                                obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                }

                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>
                        <span class="hl slc">! ...And don&#39;t list identical objects yet, either</span>

                        <span class="hl kwa">if</span> (obj.identical_to).type <span class="hl opt">=</span> identical_class
                        {
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                                        count<span class="hl opt">++</span>
                        }
                        <span class="hl kwa">elseif</span> <span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> obj
<span class="hl ppc">#else</span>
                        <span class="hl kwa">if</span> <span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> obj
<span class="hl ppc">#endif</span>
                        {
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed <span class="hl kwa">and</span>
                                        obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                                {
                                        ShortDescribe(obj)
                                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                                                notlisted<span class="hl opt">++</span>
                                }
                        }
                }

                <span class="hl kwa">if</span> notlisted <span class="hl kwa">or</span> count
                {
                        list_count <span class="hl opt">=</span> notlisted <span class="hl opt">+</span> count
                        tempformat <span class="hl opt">=</span> FORMAT
                        FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> FIRSTCAPITAL_F <span class="hl opt">|</span> ISORAREHERE_F
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                        {
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">&amp;</span> ~LIST_F       <span class="hl slc">! clear it</span>
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> TEMPLIST_F
                        }
                        Indent
                        list_nest <span class="hl opt">=</span> <span class="hl num">0</span>
                        ListObjects(place)
                        FORMAT <span class="hl opt">=</span> tempformat
                }

<span class="hl ppc">#ifclear NO_OBJLIB</span>
<span class="hl ppc">#ifset USE_ATTACHABLES</span>
                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
                        <span class="hl slc">! Print attachables last</span>
                        <span class="hl kwa">if</span> obj.type <span class="hl opt">=</span> attachable <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                        {
                                ShortDescribe(obj)
                                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                                        Message(<span class="hl opt">&amp;</span>DescribePlace, <span class="hl num">2</span>, obj)
                        }
                }
<span class="hl ppc">#endif</span>

                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                override_indent <span class="hl opt">=</span> <span class="hl kwc">false</span>

                <span class="hl slc">! Finally, list contents of scenery objects (unless we&#39;ve</span>
                <span class="hl slc">! already done so as the parent of the player)</span>
                <span class="hl slc">!</span>
                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> place
                {
                        <span class="hl kwa">if</span> obj.type <span class="hl opt">=</span> scenery
                        {
                                obj <span class="hl kwa">is</span> known
                                <span class="hl kwa">if</span> <span class="hl kwb">player</span> <span class="hl kwa">not</span> <span class="hl kwa">in</span> obj <span class="hl kwa">and</span>
                                        (obj <span class="hl kwa">is</span> open <span class="hl kwa">or</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> openable)
                                {
                                        list_nest <span class="hl opt">=</span> <span class="hl num">1</span>
                                        WhatsIn(obj)
                                }
                        }

                        <span class="hl slc">! For scenery-derived objects that may change the type</span>
                        <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> static, hidden
                                obj <span class="hl kwa">is</span> known
                }
<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_OBJLIB</span>
<span class="hl ppc"></span>
                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                need_newline <span class="hl opt">=</span> <span class="hl kwc">false</span>

        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ShortDescribe(object)</span>
<span class="hl slc">! prints the initial description of &lt;object&gt; if not moved (if it has one),</span>
<span class="hl slc">! or the when_open or when_closed message, if applicable, or the short</span>
<span class="hl slc">! description if moved (if it has one).</span>

<span class="hl kwa">routine</span> ShortDescribe(obj)
{
        obj <span class="hl kwa">is</span> known

        <span class="hl kwa">if</span> list_nest <span class="hl opt">=</span> <span class="hl num">1</span>
                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>

        AssignPronoun(obj)

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> moved <span class="hl kwa">and</span> <span class="hl opt">&amp;</span>obj.initial_desc
        {
                Indent
                <span class="hl kwa">run</span> obj.initial_desc
                <span class="hl kwa">jump</span> CheckContents
        }

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> openable
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> open
                {
                        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>obj.when_open
                        {
                                Indent
                                <span class="hl kwa">run</span> obj.when_open
                                <span class="hl kwa">jump</span> CheckContents
                        }
                }
                <span class="hl kwa">elseif</span> <span class="hl opt">&amp;</span>obj.when_closed
                {
                        Indent
                        <span class="hl kwa">run</span> obj.when_closed
                        <span class="hl kwa">jump</span> CheckContents
                }
        }

        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>obj.short_desc
                Indent

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> obj.short_desc
                <span class="hl kwa">return</span>

:CheckContents

        obj <span class="hl kwa">is</span> already_listed
        AssignPronoun(obj)

        list_count <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">if</span> <span class="hl kwa">children</span>(obj) <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl kwa">and</span> (obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> container <span class="hl kwa">or</span>
                (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> openable) <span class="hl kwa">or</span>
                (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> openable <span class="hl kwa">and</span>
                        (obj <span class="hl kwa">is</span> open <span class="hl kwa">or</span> obj <span class="hl kwa">is</span> transparent))) <span class="hl kwa">and</span>
                obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> quiet
        {
                list_nest <span class="hl opt">=</span> <span class="hl num">1</span>
                WhatsIn(obj)
        }

        <span class="hl slc">! If INDENT_SIZE is 0, formatting may be thrown off when listing</span>
        <span class="hl slc">! the contents of an object:</span>
        <span class="hl kwa">if</span> INDENT_SIZE <span class="hl opt">=</span> <span class="hl num">0</span>:  need_newline <span class="hl opt">=</span> <span class="hl kwc">true</span>

        <span class="hl kwa">if</span> need_newline:  <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! WhatsIn(object)</span>
<span class="hl slc">! lists the children of &lt;object&gt;, if any, in a relatively orderly manner</span>

<span class="hl kwa">routine</span> WhatsIn(obj)
{
        <span class="hl kwa">local</span> i, totallisted
        <span class="hl kwa">local</span> initial_list_nest

        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> NORECURSE_F
                <span class="hl kwa">return</span>

        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> obj
        {
                i <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                <span class="hl kwa">if</span> i <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                        totallisted<span class="hl opt">++</span>
        }

        <span class="hl kwa">if</span> totallisted <span class="hl opt">=</span> <span class="hl num">0</span>
                <span class="hl kwa">return</span>

        list_count <span class="hl opt">=</span> totallisted

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> container <span class="hl kwa">or</span> (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> platform) <span class="hl kwa">or</span>
                (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> (obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> openable <span class="hl kwa">or</span>
                        (obj <span class="hl kwa">is</span> openable <span class="hl kwa">and</span>
                                (obj <span class="hl kwa">is</span> open <span class="hl kwa">or</span> obj <span class="hl kwa">is</span> transparent)))) <span class="hl kwa">and</span>
                (obj <span class="hl opt">~=</span> <span class="hl kwb">player</span> <span class="hl kwa">or</span> FORMAT <span class="hl opt">&amp;</span> INVENTORY_F) <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> quiet
        {
                SpecialDesc(obj)

                <span class="hl slc">! If list_count is 0 now, but totallisted was not, something must have been</span>
                <span class="hl slc">! printed by SpecialDesc</span>

                <span class="hl kwa">if</span> list_count <span class="hl opt">=</span> <span class="hl num">0</span>
                {
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> INVENTORY_F <span class="hl kwa">and</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F) <span class="hl kwa">and</span>
                                list_nest <span class="hl opt">=</span> <span class="hl num">0</span>
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                        }
                        <span class="hl kwa">return</span> totallisted
                }

                <span class="hl kwa">if</span> obj.list_contents
                        <span class="hl kwa">return</span> totallisted

                initial_list_nest <span class="hl opt">=</span> list_nest

                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                {
                        <span class="hl kwa">if</span> list_nest
                        {
                                <span class="hl slc">! Indent the first time so that it lines up with</span>
                                <span class="hl slc">! paragraph indentation:</span>
                                i <span class="hl opt">=</span> list_nest
                                <span class="hl kwa">if</span> list_nest <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NOINDENT_F)
                                {
                                        Indent
                                        i<span class="hl opt">--</span>
                                }

                                <span class="hl kwa">print</span> <span class="hl kwa">to</span> (i <span class="hl opt">*</span> <span class="hl num">2</span>);       <span class="hl slc">! INDENT_SIZE);</span>
                        }
                }
                <span class="hl kwa">else</span>
                {
                        Indent
                }

                <span class="hl kwa">if</span> obj.contains_desc    <span class="hl slc">! custom heading</span>
                {
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                                <span class="hl kwa">print</span> <span class="hl str">&quot;:&quot;</span>
                }
                <span class="hl kwa">else</span>
                {
                        <span class="hl kwa">if</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span>
                        {
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F <span class="hl kwa">and</span> list_count <span class="hl opt">&lt;</span> totallisted
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>;

                                <span class="hl slc">! &quot;You are carrying...&quot;</span>
                                Message(<span class="hl opt">&amp;</span>WhatsIn, <span class="hl num">1</span>, totallisted)

                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;:&quot;</span>
                        }
                        <span class="hl kwa">elseif</span> obj <span class="hl kwa">is</span> living <span class="hl kwa">and</span> <span class="hl kwa">not</span> obj.prep
                        {
                                <span class="hl slc">! &quot;X has...&quot;</span>
                                Message(<span class="hl opt">&amp;</span>WhatsIn, <span class="hl num">2</span>, obj, totallisted)
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;:&quot;</span>
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">if</span> list_count <span class="hl opt">&lt;</span> totallisted
                                        <span class="hl slc">! &quot;Also sitting on/in...&quot;</span>
                                        Message(<span class="hl opt">&amp;</span>Whatsin, <span class="hl num">3</span>, obj)
                                <span class="hl kwa">else</span>
                                        <span class="hl slc">! &quot;Sitting on/in...&quot;</span>
                                        Message(<span class="hl opt">&amp;</span>Whatsin, <span class="hl num">4</span>, obj)
                                The(obj)
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> ISORARE_F
                        }
                }

                ListObjects(obj)

                list_nest <span class="hl opt">=</span> initial_list_nest
        }
        <span class="hl kwa">return</span> totallisted
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! SpecialDesc(object)</span>
<span class="hl slc">! checks the children of &lt;object&gt; and runs any applicable preliminary</span>
<span class="hl slc">! descriptions; returns the total number of remaining (i.e. non-listed)</span>
<span class="hl slc">! objects in the list_count global variable</span>

<span class="hl kwa">routine</span> SpecialDesc(obj)
{
        <span class="hl kwa">local</span> a, c, flag, printed_blankline

        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                <span class="hl kwa">return</span>

        list_count <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">for</span> a <span class="hl kwa">in</span> obj
        {
                <span class="hl kwa">if</span> a <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                {
                        c<span class="hl opt">++</span>
                        flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                }
                <span class="hl kwa">else</span>
                        flag <span class="hl opt">=</span> <span class="hl kwc">false</span>

                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> INVENTORY_F <span class="hl kwa">and</span> obj <span class="hl opt">=</span> <span class="hl kwb">player</span> <span class="hl kwa">and</span> flag
                {
                        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>a.inv_desc
                                Indent
                        <span class="hl kwa">if</span> a.inv_desc
                        {
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F:  <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                                AddSpecialDesc(a)
                        }
                }

                <span class="hl kwa">elseif</span> a <span class="hl kwa">is</span> <span class="hl kwa">not</span> moved <span class="hl kwa">and</span> flag
                {
                        <span class="hl kwa">if</span> <span class="hl opt">&amp;</span>a.initial_desc
                        {
                                <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                                override_indent <span class="hl opt">=</span> <span class="hl kwc">false</span>
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> INVENTORY_F <span class="hl kwa">and</span> FORMAT <span class="hl opt">&amp;</span> NOINDENT_F <span class="hl kwa">and</span> <span class="hl kwa">not</span> printed_blankline
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;&quot;</span>
                                printed_blankline <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                Indent
                        }
                        <span class="hl kwa">if</span> a.initial_desc
                                AddSpecialDesc(a)
                }
        }
        list_count <span class="hl opt">=</span> c <span class="hl opt">-</span> list_count
}

<span class="hl kwa">routine</span> AddSpecialDesc(a)
{
        a <span class="hl kwa">is</span> already_listed
        a <span class="hl kwa">is</span> known
        list_count<span class="hl opt">++</span>
        AssignPronoun(a)
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ListObjects(object)</span>
<span class="hl slc">! lists all the objects in &lt;object&gt;, providing that the list_count global</span>
<span class="hl slc">! contains the total number of objects to be listed.</span>

<span class="hl kwa">routine</span> ListObjects(thisobj)
{
        <span class="hl kwa">local</span> i, obj, count, pluralcount
        <span class="hl kwa">local</span> templist_count            <span class="hl slc">! temporary total of unlisted objs.</span>
        <span class="hl kwa">local</span> id_count                  <span class="hl slc">! for identical (or plural) objects</span>
<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>
        <span class="hl kwa">local</span> j, this_class
<span class="hl ppc">#endif</span>

        list_nest<span class="hl opt">++</span>
        <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> thisobj
        {
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> hidden
                {
                        obj <span class="hl kwa">is</span> already_listed
<span class="hl ppc">#ifclear NO_OBJLIB</span>
                        <span class="hl kwa">if</span> obj.type <span class="hl opt">=</span> scenery
                                obj <span class="hl kwa">is</span> known
<span class="hl ppc">#endif</span>
                }
                <span class="hl kwa">else</span>
                        obj <span class="hl kwa">is</span> known

<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>

                <span class="hl slc">! Need to count identical (and possibly plural) objects</span>
                <span class="hl slc">! for grouping in listing</span>

                <span class="hl kwa">if</span> obj.identical_to <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                {
                        this_class <span class="hl opt">=</span> obj.identical_to
                        <span class="hl kwa">if</span> this_class.type <span class="hl opt">=</span> identical_class <span class="hl kwa">or</span>
                                FORMAT <span class="hl opt">&amp;</span> GROUPPLURALS_F
                        {
                                id_count <span class="hl opt">=</span> <span class="hl num">1</span>
                                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>this_class.<span class="hl ppc">#plural_of; i++)</span>
                                {
                                        j <span class="hl opt">=</span> this_class.plural_of <span class="hl ppc">#i</span>
                                        <span class="hl kwa">if</span> j <span class="hl kwa">in</span> thisobj <span class="hl kwa">and</span> j<span class="hl opt">~=</span>obj <span class="hl kwa">and</span> j <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                                        {
                                                id_count<span class="hl opt">++</span>
                                                pluralcount<span class="hl opt">++</span>
                                                list_count<span class="hl opt">--</span>
                                                j <span class="hl kwa">is</span> already_listed
                                        }
                                }
                        }
                }
<span class="hl ppc">#endif</span>
                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed
                {
                        <span class="hl slc">! May have a leading &quot;is&quot; or &quot;are&quot; that needs to</span>
                        <span class="hl slc">! be printed at the head of the list</span>

                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> ISORARE_F
                        {
                                <span class="hl kwa">if</span> list_count <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> id_count <span class="hl opt">&lt;=</span> <span class="hl num">1</span> <span class="hl kwa">and</span>
                                        obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> plural
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; IS_WORD;
                                }
                                <span class="hl kwa">else</span>
                                {
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; ARE_WORD;
                                }
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;:&quot;</span>
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">&amp;</span> ~ISORARE_F    <span class="hl slc">! clear it</span>
                        }

                        need_newline <span class="hl opt">=</span> <span class="hl kwc">false</span>
                        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> plural
                                pluralcount<span class="hl opt">++</span>

                        AssignPronoun(obj)
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F)
                        {
                                <span class="hl kwa">if</span> list_count <span class="hl opt">&gt;</span> <span class="hl num">2</span> <span class="hl kwa">and</span> count
                                        <span class="hl kwa">print</span> <span class="hl str">&quot;,&quot;</span>;
                                <span class="hl kwa">if</span> list_count <span class="hl opt">&gt;</span> <span class="hl num">1</span> <span class="hl kwa">and</span> count <span class="hl opt">=</span> list_count <span class="hl opt">-</span> <span class="hl num">1</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD;
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> FIRSTCAPITAL_F)
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;
                        }
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">print</span> <span class="hl kwa">to</span> (list_nest <span class="hl opt">*</span> <span class="hl num">2</span>);       <span class="hl slc">! INDENT_SIZE);</span>
                        }

<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>

                        <span class="hl slc">! If a number of identical (or possibly plural)</span>
                        <span class="hl slc">! objects are grouped together, they are printed</span>
                        <span class="hl slc">! as a single entry in the list</span>
                        <span class="hl slc">!</span>
                        <span class="hl kwa">if</span> obj.identical_to <span class="hl kwa">and</span>
                                (this_class.type <span class="hl opt">=</span> identical_class <span class="hl kwa">or</span>
                                FORMAT <span class="hl opt">&amp;</span> GROUPPLURALS_F)
                        {
                                <span class="hl kwa">if</span> id_count <span class="hl opt">=</span> <span class="hl num">1</span>
                                {
                                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> FIRSTCAPITAL_F
                                                CArt(obj)
                                        <span class="hl kwa">else</span>
                                                Art(obj)
                                }
                                <span class="hl kwa">else</span>
                                {
                                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> FIRSTCAPITAL_F
                                                <span class="hl kwa">print</span> NumberWord(id_count, <span class="hl kwc">true</span>);
                                        <span class="hl kwa">else</span>
                                                <span class="hl kwa">print</span> NumberWord(id_count);
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; this_class.<span class="hl kwb">name</span>;

                                        <span class="hl kwa">if</span> this_class.type <span class="hl opt">=</span> plural_class
                                        {
                                                <span class="hl kwa">local</span> k

                                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                                                        <span class="hl kwa">print</span> <span class="hl str">&quot;:&quot;</span>;
                                                <span class="hl kwa">else</span>
                                                        <span class="hl kwa">print</span> <span class="hl str">&quot; (&quot;</span>;

                                                k <span class="hl opt">=</span> <span class="hl num">0</span>
                                                <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>this_class.<span class="hl ppc">#plural_of; i++)</span>
                                                {
                                                        j <span class="hl opt">=</span> this_class.plural_of <span class="hl ppc">#i</span>
                                                        <span class="hl kwa">if</span> <span class="hl kwa">parent</span>(j) <span class="hl opt">=</span> thisobj
                                                        {
                                                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F)
                                                                {
                                                                        <span class="hl kwa">if</span> id_count <span class="hl opt">&gt;</span> <span class="hl num">2</span> <span class="hl kwa">and</span> k
                                                                                <span class="hl kwa">print</span> <span class="hl str">&quot;,&quot;</span>;
                                                                        <span class="hl kwa">if</span> k <span class="hl opt">=</span> id_count <span class="hl opt">-</span> <span class="hl num">1</span>
                                                                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD;
                                                                        <span class="hl kwa">if</span> k
                                                                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;
                                                                }
                                                                <span class="hl kwa">else</span>
                                                                {
                                                                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>;
                                                                        <span class="hl kwa">print</span> <span class="hl kwa">to</span> ((list_nest<span class="hl opt">+</span><span class="hl num">1</span>) <span class="hl opt">*</span> <span class="hl num">2</span>);   <span class="hl slc">! INDENT_SIZE);</span>
                                                                }
                                                                Art(j)
                                                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NOPARENTHESES_F)
                                                                        ObjectIs(j)
                                                                k<span class="hl opt">++</span>
                                                        }
                                                }
                                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F):  <span class="hl kwa">print</span> <span class="hl str">&quot;)&quot;</span>;
                                        }
                                }
                        }
                        <span class="hl kwa">else</span>
                        {
<span class="hl ppc">#endif</span>
                                <span class="hl slc">! Regular old non-plural, non-identical</span>
                                <span class="hl slc">! objects get listed here:</span>

                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> FIRSTCAPITAL_F
                                        CArt(obj)
                                <span class="hl kwa">else</span>:  Art(obj)
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NOPARENTHESES_F)
                                        ObjectIs(obj)
<span class="hl ppc">#ifset USE_PLURAL_OBJECTS</span>
                        }
<span class="hl ppc">#endif</span>
                        FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">&amp;</span> ~FIRSTCAPITAL_F       <span class="hl slc">! clear it</span>

                        count<span class="hl opt">++</span>
                }

                <span class="hl slc">! For itemized listings, list the children of</span>
                <span class="hl slc">! each object immediately after that object (unless</span>
                <span class="hl slc">! it is a SpecialDesc-printed description)</span>

                <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden <span class="hl kwa">and</span> FORMAT <span class="hl opt">&amp;</span> LIST_F
                {
                        <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                        <span class="hl kwa">if</span> <span class="hl kwa">children</span>(obj)
                        {
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> obj.list_contents
                                {
                                        templist_count <span class="hl opt">=</span> list_count
                                        WhatsIn(obj)
                                        list_count <span class="hl opt">=</span> templist_count
                                }
                        }
                }
        }

        <span class="hl slc">! If not an itemized list, it is necessary to finish off the</span>
        <span class="hl slc">! sentence, adding any necessary words at the end.  Then, the</span>
        <span class="hl slc">! children of all previously objects listed at this level are</span>
        <span class="hl slc">! listed.</span>

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F)
        {
                <span class="hl kwa">if</span> count
                {
                        <span class="hl kwa">if</span> list_nest <span class="hl opt">=</span> <span class="hl num">1</span> <span class="hl kwa">and</span> FORMAT <span class="hl opt">&amp;</span> ISORAREHERE_F
                        {
                                <span class="hl kwa">if</span> count <span class="hl opt">+</span> pluralcount <span class="hl opt">&gt;</span> <span class="hl num">1</span>
                                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; ARE_WORD;
                                <span class="hl kwa">else</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; IS_WORD;
                                <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; HERE_WORD;
                                FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">&amp;</span> ~ISORAREHERE_F  <span class="hl slc">! clear it</span>

                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT<span class="hl opt">&amp;</span>LIST_F <span class="hl kwa">or</span> FORMAT<span class="hl opt">&amp;</span>TEMPLIST_F)
                                        override_indent <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        }

                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NORECURSE_F)
                                <span class="hl kwa">print</span> <span class="hl str">&quot;.&quot;</span>;
                }

                i <span class="hl opt">=</span> <span class="hl num">0</span>

                <span class="hl kwa">for</span> obj <span class="hl kwa">in</span> thisobj
                {
                        <span class="hl kwa">if</span> <span class="hl kwa">children</span>(obj) <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden <span class="hl kwa">and</span>
                                (obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> already_listed <span class="hl kwa">or</span>
                                        thisobj <span class="hl opt">~=</span> <span class="hl kwb">location</span>)
                        {
                                <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> TEMPLIST_F
                                {
                                        FORMAT <span class="hl opt">=</span> FORMAT <span class="hl opt">|</span> LIST_F <span class="hl opt">&amp;</span> ~TEMPLIST_F
                                        i <span class="hl opt">=</span> <span class="hl kwc">true</span>
                                        <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                                }

                                templist_count <span class="hl opt">=</span> list_count
                                WhatsIn(obj)
                                list_count <span class="hl opt">=</span> templist_count
                        }
                }
        }

        <span class="hl kwa">if</span> <span class="hl opt">--</span>list_nest <span class="hl opt">=</span> <span class="hl num">0</span>
        {
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> LIST_F) <span class="hl kwa">and</span> <span class="hl kwa">not</span> (FORMAT <span class="hl opt">&amp;</span> NORECURSE_F)
                {
                        <span class="hl kwa">print</span> <span class="hl kwa">newline</span>
                        override_indent <span class="hl opt">=</span> <span class="hl kwc">false</span>
                        need_newline <span class="hl opt">=</span> <span class="hl kwc">false</span>
                }
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! PropertyList(object, property[, article])</span>
<span class="hl slc">! lists all the objects in &lt;object&gt;.&lt;property&gt;, returning the number of</span>
<span class="hl slc">! objects printed; if &lt;article&gt; is false or omitted, the indefinite article</span>
<span class="hl slc">! is used</span>

<span class="hl kwa">routine</span> PropertyList(obj, prop, artic)
{
        <span class="hl kwa">local</span> a, b, n, total

        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#prop; a++)</span>
        {
                <span class="hl kwa">if</span> obj.prop <span class="hl ppc">#a:  total++</span>
        }

        <span class="hl kwa">for</span> (a<span class="hl opt">=</span><span class="hl num">1</span>; a<span class="hl opt">&lt;=</span>obj.<span class="hl ppc">#prop; a++)</span>
        {
                b <span class="hl opt">=</span> obj.prop <span class="hl ppc">#a</span>
                <span class="hl kwa">if</span> b
                {
                        <span class="hl kwa">if</span> artic
                                The(b)
                        <span class="hl kwa">else</span>
                                Art(b)

                        <span class="hl kwa">if</span> a <span class="hl opt">&lt;</span> total <span class="hl kwa">and</span> total <span class="hl opt">&gt;</span> <span class="hl num">2</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;, &quot;</span>;
                        <span class="hl kwa">elseif</span> a <span class="hl opt">=</span> total <span class="hl opt">-</span> <span class="hl num">1</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>;

                        <span class="hl kwa">if</span> a <span class="hl opt">=</span> total <span class="hl opt">-</span> <span class="hl num">1</span>
                                <span class="hl kwa">print</span> AND_WORD; <span class="hl str">&quot; &quot;</span>;
                        n<span class="hl opt">++</span>
                }
        }
        <span class="hl kwa">return</span> n
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! MovePlayer(location[, silent])</span>
<span class="hl slc">! moves the player to the object &lt;location&gt;, with no description if &lt;silent&gt;</span>
<span class="hl slc">! is true</span>
<span class="hl slc">!</span>
<span class="hl slc">! MovePlayer(direction[, silent[, ignore]])</span>
<span class="hl slc">! moves player in &lt;direction&gt;, where &lt;direction&gt; is a direction object.</span>
<span class="hl slc">! If &lt;ignore&gt; is true, before/after routines relating to the move are</span>
<span class="hl slc">! not checked.</span>
<span class="hl slc">!</span>
<span class="hl slc">! MovePlayer calls DarkWarning when there is no light source in the new</span>
<span class="hl slc">! location; replace it with a new DarkWarning routine for a more elaborate</span>
<span class="hl slc">! response, such as the possible demise of the player</span>

<span class="hl kwa">routine</span> MovePlayer(loc, silent, ignore)
{
        <span class="hl kwa">local</span> v, obj, xobj, act, ret

<span class="hl ppc">#ifclear NO_OBJLIB</span>
        <span class="hl kwa">if</span> loc.type <span class="hl opt">=</span> direction
        {
                <span class="hl kwa">local</span> l
                l <span class="hl opt">=</span> <span class="hl kwb">location</span>.(loc.dir_to)
                <span class="hl kwa">if</span> l <span class="hl opt">&gt;</span> <span class="hl num">1</span>                <span class="hl slc">! since a message always returns 1</span>
                        loc <span class="hl opt">=</span> l
                <span class="hl kwa">else</span>
                        <span class="hl kwa">return</span>
        }
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset USE_ATTACHABLES</span>
        <span class="hl kwa">if</span> ObjectisAttached(<span class="hl kwb">player</span>, <span class="hl kwb">location</span>, loc)
                <span class="hl kwa">return</span>
<span class="hl ppc">#endif</span>

        <span class="hl slc">! Check if there&#39;s a before routine for MovePlayer in the new</span>
        <span class="hl slc">! location.  Note that the (potential) new location and the old</span>
        <span class="hl slc">! location are stored in object and xobject, respectively.</span>
        <span class="hl slc">!</span>
        v <span class="hl opt">=</span> <span class="hl kwb">verbroutine</span>
        obj <span class="hl opt">=</span> <span class="hl kwb">object</span>
        xobj <span class="hl opt">=</span> <span class="hl kwb">xobject</span>
        act <span class="hl opt">=</span> <span class="hl kwb">actor</span>
        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>MovePlayer
        <span class="hl kwb">object</span> <span class="hl opt">=</span> loc
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> <span class="hl kwb">location</span>
        <span class="hl kwb">actor</span> <span class="hl opt">=</span> <span class="hl kwb">player</span>
        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ignore
        {
                ret <span class="hl opt">=</span> <span class="hl kwb">player</span>.<span class="hl kwb">before</span>
                <span class="hl kwa">if</span> ret:  <span class="hl kwa">jump</span> LeaveMovePlayer
                ret <span class="hl opt">=</span> <span class="hl kwb">location</span>.<span class="hl kwb">before</span>
                <span class="hl kwa">if</span> ret:  <span class="hl kwa">jump</span> LeaveMovePlayer
                ret <span class="hl opt">=</span> loc.<span class="hl kwb">before</span>
                <span class="hl kwa">if</span> ret:  <span class="hl kwa">jump</span> LeaveMovePlayer
        }

        <span class="hl kwa">move</span> <span class="hl kwb">player</span> <span class="hl kwa">to</span> loc
        old_location <span class="hl opt">=</span> <span class="hl kwb">location</span>
        <span class="hl kwa">if</span> <span class="hl kwa">parent</span>(loc) <span class="hl opt">=</span> <span class="hl num">0</span>              <span class="hl slc">! if it&#39;s likely a room object</span>
                <span class="hl kwb">location</span> <span class="hl opt">=</span> loc
        <span class="hl kwa">else</span>                            <span class="hl slc">! if it&#39;s an enterable object</span>
                <span class="hl kwb">location</span> <span class="hl opt">=</span> <span class="hl kwa">parent</span>(loc)  <span class="hl slc">! (noting that the object must be</span>
                                        <span class="hl slc">! in a room, not inside another</span>
                                        <span class="hl slc">! non-room object)</span>

<span class="hl ppc">#ifset USE_ATTACHABLES</span>
        MoveAllAttachables(<span class="hl kwb">player</span>, old_location, <span class="hl kwb">location</span>)
<span class="hl ppc">#endif</span>

        PrintStatusline

:LeaveMovePlayer

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ret
        {
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> FindLight(<span class="hl kwb">location</span>)
                        DarkWarning
                <span class="hl kwa">elseif</span> <span class="hl kwa">not</span> silent
                {
                        DescribePlace(<span class="hl kwb">location</span>)
                        event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        <span class="hl kwb">location</span> <span class="hl kwa">is</span> visited
                }

        <span class="hl slc">! Check if there&#39;s an after routine for MovePlayer in the new</span>
        <span class="hl slc">! location:</span>
        <span class="hl slc">!</span>
                <span class="hl kwa">if</span> <span class="hl kwa">not</span> ignore
                {
                        ret <span class="hl opt">=</span> <span class="hl kwb">player</span>.<span class="hl kwb">after</span>
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> ret
                                ret <span class="hl opt">=</span> <span class="hl kwb">location</span>.<span class="hl kwb">after</span>
                }
        }

        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> v
        <span class="hl kwb">object</span> <span class="hl opt">=</span> obj
        <span class="hl kwb">xobject</span> <span class="hl opt">=</span> xobj
        <span class="hl kwb">actor</span> <span class="hl opt">=</span> act

        <span class="hl kwa">return</span> ret
}

<span class="hl kwa">routine</span> DarkWarning
{
        <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); <span class="hl str">&quot; stumble&quot;</span>; MatchSubject(<span class="hl kwb">player</span>); \
                <span class="hl str">&quot; around in the dark.&quot;</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! FindLight(object)</span>
<span class="hl slc">! returns the object number of light_source if any light is visible from</span>
<span class="hl slc">! within &lt;object&gt; (where &lt;object&gt; is usually a location)</span>
<span class="hl slc">!</span>
<span class="hl slc">! ObjectisLight is called by FindLight</span>

<span class="hl kwa">routine</span> FindLight(loc)
{
        light_source <span class="hl opt">=</span> <span class="hl num">0</span>

        <span class="hl kwa">if</span> loc <span class="hl kwa">is</span> light
        {
                light_source <span class="hl opt">=</span> loc
                <span class="hl kwa">return</span> light_source
        }
        <span class="hl kwa">elseif</span> ObjectisLight(<span class="hl kwb">player</span>)
                <span class="hl kwa">return</span> light_source
        <span class="hl kwa">return</span> ObjectisLight(loc)
}

<span class="hl kwa">routine</span> ObjectisLight(obj)
{
        <span class="hl kwa">local</span> nextobj

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> light
        {
                light_source <span class="hl opt">=</span> obj
                <span class="hl kwa">return</span> light_source
        }
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> container <span class="hl kwa">or</span>
                (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> <span class="hl kwa">not</span> openable) <span class="hl kwa">or</span>
                (obj <span class="hl kwa">is</span> container <span class="hl kwa">and</span> obj <span class="hl kwa">is</span> openable <span class="hl kwa">and</span>
                        (obj <span class="hl kwa">is</span> open <span class="hl kwa">or</span> obj <span class="hl kwa">is</span> transparent))
        {
                <span class="hl kwa">for</span> nextobj <span class="hl kwa">in</span> obj
                {
                        <span class="hl kwa">if</span> ObjectisLight(nextobj)
                                <span class="hl kwa">return</span> light_source
                }
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! ObjectIs(object)</span>
<span class="hl slc">! prints a list of parenthetical attributes</span>

<span class="hl kwa">routine</span> ObjectIs(obj)
{
        <span class="hl kwa">local</span> n

        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> clothing:  n <span class="hl opt">=</span> TestObjectIs(obj, worn, <span class="hl str">&quot;being worn&quot;</span>, n)
        n <span class="hl opt">=</span> TestObjectIs(obj, light, <span class="hl str">&quot;providing light&quot;</span>, n)

        <span class="hl kwa">if</span> n:  <span class="hl kwa">print</span> <span class="hl str">&quot;)&quot;</span>;

        <span class="hl kwa">run</span> obj.desc_detail
}

<span class="hl kwa">routine</span> TestObjectIs(obj, attr, str, n)
{
        <span class="hl kwa">if</span> obj <span class="hl kwa">is</span> attr
        {
                <span class="hl kwa">if</span> n <span class="hl opt">=</span> <span class="hl num">0</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot; (&quot;</span>;
                <span class="hl kwa">else</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot; &quot;</span>; AND_WORD;
                <span class="hl kwa">print</span> str;
                n<span class="hl opt">++</span>
        }
        <span class="hl kwa">return</span> n
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Acquire(object 1, object 2)</span>
<span class="hl slc">! moves &lt;object 2&gt; to &lt;object 1&gt;; returns true if successful</span>

<span class="hl kwa">routine</span> Acquire(newparent, newchild)
{
        <span class="hl kwa">local</span> p

        CalculateHolding(newparent)

        <span class="hl kwa">if</span> newparent.holding <span class="hl opt">+</span> newchild.size <span class="hl opt">&gt;</span> newparent.capacity
                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
        <span class="hl kwa">else</span>
        {
                p <span class="hl opt">=</span> <span class="hl kwa">parent</span>(newchild)
                <span class="hl kwa">move</span> newchild <span class="hl kwa">to</span> newparent
                CalculateHolding(p)
                newchild <span class="hl kwa">is</span> moved
                newchild <span class="hl kwa">is</span> <span class="hl kwa">not</span> hidden
                newparent.holding <span class="hl opt">=</span> newparent.holding <span class="hl opt">+</span> newchild.size
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CalculateHolding(object)</span>
<span class="hl slc">! recalculates the correct holding property for an object; used before</span>
<span class="hl slc">! adding or subtracting children</span>

<span class="hl kwa">routine</span> CalculateHolding(obj)
{
        <span class="hl kwa">local</span> i

        obj.holding <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">for</span> i <span class="hl kwa">in</span> obj
        {
                <span class="hl kwa">if</span> i <span class="hl kwa">is</span> <span class="hl kwa">not</span> worn <span class="hl kwa">or</span> obj <span class="hl opt">~=</span> <span class="hl kwb">player</span>
                        obj.holding <span class="hl opt">=</span> obj.holding <span class="hl opt">+</span> i.size
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Contains(object 1, object 2)</span>
<span class="hl slc">! returns &lt;object2&gt; if &lt;object 1&gt; contains &lt;object 2&gt; (even as a grandchild)</span>

<span class="hl kwa">routine</span> Contains(obj, possible_child)
{
        <span class="hl kwa">local</span> nextobj

        <span class="hl kwa">for</span> (nextobj<span class="hl opt">=</span><span class="hl kwa">parent</span>(possible_child); nextobj; nextobj<span class="hl opt">=</span><span class="hl kwa">parent</span>(nextobj))
        {
                <span class="hl kwa">if</span> nextobj <span class="hl opt">=</span> obj
                        <span class="hl kwa">return</span> possible_child
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CheckReach(object)</span>
<span class="hl slc">! returns true if either player object&#39;s current parent has no reach</span>
<span class="hl slc">! property specified, or if &lt;object&gt; is in the list of reachable objects</span>

<span class="hl kwa">routine</span> CheckReach(obj)
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> obj <span class="hl kwa">or</span> obj <span class="hl opt">=</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>)
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>

<span class="hl ppc">#ifclear NO_VERBS</span>
        <span class="hl kwa">if</span> (<span class="hl kwb">verbroutine</span> <span class="hl opt">~=</span> <span class="hl opt">&amp;</span>DoLook, <span class="hl opt">&amp;</span>DoLookIn) <span class="hl kwa">and</span> <span class="hl kwa">parent</span>(<span class="hl kwb">object</span>) <span class="hl kwa">and</span>
                <span class="hl kwa">parent</span>(<span class="hl kwb">object</span>) <span class="hl opt">~=</span> <span class="hl kwb">player</span> <span class="hl kwa">and</span>
                <span class="hl kwa">parent</span>(<span class="hl kwb">object</span>) <span class="hl kwa">is</span> transparent <span class="hl kwa">and</span> <span class="hl kwa">parent</span>(<span class="hl kwb">object</span>) <span class="hl kwa">is</span> <span class="hl kwa">not</span> open <span class="hl kwa">and</span>
                <span class="hl kwa">parent</span>(<span class="hl kwb">object</span>) <span class="hl kwa">is</span> <span class="hl kwa">not</span> living
        {
                VMessage(<span class="hl opt">&amp;</span>DoGet, <span class="hl num">5</span>)     <span class="hl slc">! &quot;X is closed.&quot;</span>
                <span class="hl kwa">return</span> <span class="hl kwc">false</span>
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).reach <span class="hl kwa">or</span> Contains(<span class="hl kwa">parent</span>(<span class="hl kwb">player</span>), obj)
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>

<span class="hl ppc">#ifclear NO_VERBS</span>
        <span class="hl kwa">if</span> <span class="hl kwa">parent</span>(obj) <span class="hl kwa">is</span> living
        {
                <span class="hl kwa">if</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">~=</span> <span class="hl opt">&amp;</span>DoGet, <span class="hl opt">&amp;</span>DoLook

                        <span class="hl slc">! &quot;Except that X has it...&quot;</span>
                        Message(<span class="hl opt">&amp;</span>CheckReach, <span class="hl num">1</span>, obj)

                <span class="hl kwa">elseif</span> <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl opt">&amp;</span>DoGet <span class="hl kwa">and</span> <span class="hl kwa">parent</span>(obj) <span class="hl kwa">is</span> unfriendly

                        <span class="hl slc">! &quot;Except that X doesn&#39;t want to give it to you...&quot;</span>
                        Message(<span class="hl opt">&amp;</span>CheckReach, <span class="hl num">2</span>, obj)
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span><span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).<span class="hl ppc">#reach; i++)</span>
        {
                <span class="hl kwa">if</span> Contains(<span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).reach <span class="hl ppc">#i, obj) or</span>
                        obj <span class="hl opt">=</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).reach <span class="hl ppc">#i</span>
                {
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                }
        }

<span class="hl ppc">#ifset USE_ATTACHABLES</span>
        <span class="hl kwa">if</span> <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>).type <span class="hl opt">=</span> attachable
        {
                <span class="hl kwa">if</span> InList(<span class="hl kwa">parent</span>(<span class="hl kwb">player</span>), attached_to, obj)
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">if</span> obj.type <span class="hl opt">=</span> attachable
        {
                <span class="hl kwa">if</span> InList(obj, attached_to, <span class="hl kwa">parent</span>(<span class="hl kwb">player</span>))
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
<span class="hl ppc">#endif</span>

        <span class="hl slc">! &quot;You can&#39;t reach it...&quot;</span>
        Message(<span class="hl opt">&amp;</span>CheckReach, <span class="hl num">3</span>, obj)
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! GetInput</span>
<span class="hl slc">! receives input from the keyboard, parsing into the word[] array; unknown</span>
<span class="hl slc">! words--i.e. those that aren&#39;t in the dictionary--are equated to the null</span>
<span class="hl slc">! string (&quot;&quot;)</span>
<span class="hl slc">!</span>
<span class="hl slc">! GetInput(prompt)</span>
<span class="hl slc">! where the optional &lt;prompt&gt; represents a dictionary word, prints &lt;prompt&gt;</span>
<span class="hl slc">! before receiving input</span>

<span class="hl kwa">routine</span> GetInput(p)
{
        <span class="hl kwa">print</span> p;
        <span class="hl kwa">input</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! YesorNo</span>
<span class="hl slc">! returns true if word[1] is &quot;yes&quot;, false if &quot;no&quot;; prompts for a</span>
<span class="hl slc">! new input if neither</span>

<span class="hl kwa">routine</span> YesorNo
{
        <span class="hl kwa">local</span> w, count
        w <span class="hl opt">=</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>]
        <span class="hl kwa">while</span> <span class="hl kwc">true</span>
        {
                <span class="hl kwa">if</span> w <span class="hl opt">=</span> <span class="hl str">&quot;yes&quot;</span>, <span class="hl str">&quot;y&quot;</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
                <span class="hl kwa">elseif</span> w <span class="hl opt">=</span> <span class="hl str">&quot;no&quot;</span>, <span class="hl str">&quot;n&quot;</span>
                        <span class="hl kwa">return</span> <span class="hl kwc">false</span>

                <span class="hl kwa">if</span> <span class="hl opt">++</span>count <span class="hl opt">&lt;</span> <span class="hl num">10</span>
                        Message(<span class="hl opt">&amp;</span>YesorNo, <span class="hl num">1</span>)    <span class="hl slc">! ask &quot;yes&quot; or &quot;no&quot;</span>
                <span class="hl kwa">else</span>
                        Message(<span class="hl opt">&amp;</span>YesorNo, <span class="hl num">2</span>)
                GetInput
                w <span class="hl opt">=</span> <span class="hl kwa">word</span>[<span class="hl num">1</span>]
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Font(style mask)</span>
<span class="hl slc">! changes the font style based on the style(s) specified in &lt;style mask&gt;,</span>
<span class="hl slc">! which may consist of one or more font bitmask constants combined with</span>
<span class="hl slc">! the &quot;+&quot; or &quot;|&quot; operator:</span>
<span class="hl slc">!</span>
<span class="hl slc">!       Font(BOLD_ON | ITALIC_OFF | ...)</span>

<span class="hl kwa">routine</span> Font(mask)
{
<span class="hl ppc">#ifclear NO_FONTS</span>
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> BOLD_ON:        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\B</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> BOLD_OFF:       <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\b</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> ITALIC_ON:      <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\I</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> ITALIC_OFF:     <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\i</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> UNDERLINE_ON:   <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\U</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> UNDERLINE_OFF:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\u</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> PROP_ON:        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\P</span><span class="hl str">&quot;</span>;
        <span class="hl kwa">if</span> mask <span class="hl opt">&amp;</span> PROP_OFF:       <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\p</span><span class="hl str">&quot;</span>;
<span class="hl ppc">#endif</span>
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! AUXILIARY MATH ROUTINES:</span>
<span class="hl slc">!</span>
<span class="hl slc">! Function:     Returns:</span>
<span class="hl slc">!</span>
<span class="hl slc">! abs(a)        the absolute value of &lt;a&gt;</span>
<span class="hl slc">! higher(a, b)  the greater of &lt;a&gt; or &lt;b&gt;</span>
<span class="hl slc">! lower(a, b)   the lower of &lt;a&gt; or &lt;b&gt;</span>
<span class="hl slc">! mod(a, b)     the remainder of &lt;a&gt; divided by &lt;b&gt;</span>
<span class="hl slc">! pow(a, b)     &lt;a&gt; to the power of &lt;b&gt;</span>

<span class="hl ppc">#ifclear NO_AUX_MATH</span>

<span class="hl kwa">routine</span> abs(a)
{
        <span class="hl kwa">if</span> a <span class="hl opt">&lt;</span> <span class="hl num">0</span>
                <span class="hl kwa">return</span> <span class="hl opt">-</span>a
        <span class="hl kwa">return</span> a
}

<span class="hl kwa">routine</span> higher(a, b)
{
        <span class="hl kwa">if</span> a <span class="hl opt">&gt;</span> b:  <span class="hl kwa">return</span> a
        <span class="hl kwa">return</span> b
}

<span class="hl kwa">routine</span> lower(a, b)
{
        <span class="hl kwa">if</span> a <span class="hl opt">&lt;</span> b:  <span class="hl kwa">return</span> a
        <span class="hl kwa">return</span> b
}

<span class="hl kwa">routine</span> mod(a, b)
{
        <span class="hl kwa">return</span> a<span class="hl opt">-</span>(a<span class="hl opt">/</span>b<span class="hl opt">*</span>b)
}

<span class="hl kwa">routine</span> pow(a, b)
{
        <span class="hl kwa">local</span> i, n

        <span class="hl kwa">if</span> b <span class="hl opt">=</span> <span class="hl num">0</span>:  <span class="hl kwa">return</span> <span class="hl num">1</span>
        <span class="hl kwa">if</span> b <span class="hl opt">&lt;</span> <span class="hl num">0</span>:  <span class="hl kwa">return</span> <span class="hl num">0</span>
        n <span class="hl opt">=</span> a
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">2</span>; i<span class="hl opt">&lt;=</span>b; i<span class="hl opt">++</span>)
                n <span class="hl opt">=</span> n <span class="hl opt">*</span> a
        <span class="hl kwa">return</span> n
}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_AUX_MATH</span>
<span class="hl ppc"></span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! STRING ARRAY ROUTINES:</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringCompare(array1, array2)</span>
<span class="hl slc">! returns 1 if &lt;array1&gt; is lexically greater than &lt;array2&gt;, -1 if &lt;array1&gt;</span>
<span class="hl slc">! is lexically less than &lt;array2&gt;, and 0 if the two string arrays are</span>
<span class="hl slc">! identical</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringCopy(new, old)</span>
<span class="hl slc">! StringCopy(new, old, length)</span>
<span class="hl slc">! either copies the array beginning at &lt;old&gt; to &lt;new&gt;, to a maximum of</span>
<span class="hl slc">! &lt;length&gt; characters, if specified</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringDictCompare(array, dictentry)</span>
<span class="hl slc">! for comparing a string array with a dictionary entry; return values are</span>
<span class="hl slc">! as for StringCompare</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringEqual(array1, array2)</span>
<span class="hl slc">! returns true if the two strings are identical</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringLength(array)</span>
<span class="hl slc">! returns the number of characters in string &lt;array&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! StringPrint(array)</span>
<span class="hl slc">! StringPrint(array, start, end)</span>
<span class="hl slc">! either prints the string stored in &lt;array&gt;, beginning and ending with</span>
<span class="hl slc">! &lt;start&gt; and &lt;end&gt;, if specified</span>

<span class="hl ppc">#ifclear NO_STRING_ARRAYS</span>

<span class="hl ppc">#if undefined _temp_string</span>
<span class="hl kwa">array</span> _temp_string[<span class="hl num">256</span>]                 <span class="hl slc">! maximum string length is 255 char.</span>
<span class="hl ppc">#endif</span>

<span class="hl kwa">routine</span> StringCompare(a, b)
{
        <span class="hl kwa">local</span> i, alen

        alen <span class="hl opt">=</span> StringLength(a)

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">0</span>; i<span class="hl opt">&lt;</span>alen; i<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> <span class="hl kwa">array</span> a[i] <span class="hl opt">&gt;</span> <span class="hl kwa">array</span> b[i]:     <span class="hl kwa">return</span>  <span class="hl num">1</span>
                <span class="hl kwa">elseif</span> <span class="hl kwa">array</span> a[i] <span class="hl opt">&lt;</span> <span class="hl kwa">array</span> b[i]: <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span>
        }
        <span class="hl kwa">if</span> <span class="hl kwa">array</span> b[i] <span class="hl opt">~=</span> <span class="hl num">0</span>:  <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span>
}

<span class="hl kwa">routine</span> StringCopy(new, old, len)
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> len <span class="hl opt">=</span> <span class="hl num">0</span>
                len <span class="hl opt">=</span> StringLength(old)

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">0</span>; i<span class="hl opt">&lt;</span>len; i<span class="hl opt">++</span>)
                <span class="hl kwa">array</span> new[i] <span class="hl opt">=</span> <span class="hl kwa">array</span> old[i]
        <span class="hl kwa">array</span> new[len] <span class="hl opt">=</span> <span class="hl num">0</span>
}

<span class="hl kwa">routine</span> StringDictCompare(a, d)
{
        <span class="hl kwa">string</span>(_temp_string, d, <span class="hl num">255</span>)
        <span class="hl kwa">return</span> StringCompare(a, _temp_string)
}

<span class="hl kwa">routine</span> StringEqual(a, b)
{
        <span class="hl kwa">return</span> <span class="hl kwa">not</span> StringCompare(a, b)
}

<span class="hl kwa">routine</span> StringLength(arr)
{
        <span class="hl kwa">local</span> i
        i <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">while</span> <span class="hl kwa">array</span> arr[i] <span class="hl opt">~=</span> <span class="hl num">0</span>:  i<span class="hl opt">++</span>
        <span class="hl kwa">return</span> i
}

<span class="hl kwa">routine</span> StringPrint(a, <span class="hl kwa">start</span>, end)
{
        <span class="hl kwa">local</span> i

        <span class="hl kwa">if</span> end <span class="hl opt">=</span> <span class="hl num">0</span>
                end <span class="hl opt">=</span> StringLength(a)
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl kwa">start</span>; i<span class="hl opt">&lt;</span>end; i<span class="hl opt">++</span>)
        {
                <span class="hl kwa">if</span> <span class="hl kwa">array</span> a[i] <span class="hl opt">=</span> <span class="hl num">0</span>
                        <span class="hl kwa">break</span>
                <span class="hl kwa">printchar</span> <span class="hl kwa">array</span> a[i]
        }
}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_STRING_ARRAYS</span>
<span class="hl ppc"></span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Menu(number, [width][, selection]])</span>
<span class="hl slc">!</span>
<span class="hl slc">! The Menu routine expects the array menuitem[] to hold a series of</span>
<span class="hl slc">! dictionary entries representing the list of possible choices, with the</span>
<span class="hl slc">! title of the menu contained in menuitem[0].  It returns the number chosen,</span>
<span class="hl slc">! or 0 if none is selected.</span>
<span class="hl slc">!</span>
<span class="hl slc">! The argument &lt;number&gt; gives the number of menu items, and the optional</span>
<span class="hl slc">! &lt;width&gt; gives the width of the menu, in characters.  If no width is</span>
<span class="hl slc">! specified, it defaults to the greater of 20 or the longest menu choice.</span>
<span class="hl slc">! If &lt;selection&gt; is specified, it gives the starting selection in the menu.</span>

<span class="hl ppc">#ifclear NO_MENUS</span>

<span class="hl ppc">#if undefined _temp_string</span>
<span class="hl kwa">array</span> _temp_string[<span class="hl num">256</span>]
<span class="hl ppc">#endif</span>

<span class="hl kwa">constant</span> MAX_MENUITEMS <span class="hl num">16</span>               <span class="hl slc">! up to 15 items (plus title)</span>
<span class="hl kwa">array</span> menuitem[MAX_MENUITEMS]

<span class="hl kwa">global</span> MENU_TEXTCOLOR
<span class="hl kwa">global</span> MENU_BGCOLOR
<span class="hl kwa">global</span> MENU_SELECTCOLOR
<span class="hl kwa">global</span> MENU_SELECTBGCOLOR

<span class="hl kwa">routine</span> Menu(num, width, selection)
{
        <span class="hl kwa">local</span> i, column, oldselection

        Font(BOLD_OFF <span class="hl opt">|</span> ITALIC_OFF <span class="hl opt">|</span> UNDERLINE_OFF <span class="hl opt">|</span> PROP_OFF)

        <span class="hl kwa">if</span> MENU_TEXTCOLOR<span class="hl opt">=</span><span class="hl num">0</span> <span class="hl kwa">and</span> MENU_BGCOLOR<span class="hl opt">=</span><span class="hl num">0</span>  <span class="hl slc">! must not have been set</span>
        {
                MENU_TEXTCOLOR <span class="hl opt">=</span> TEXTCOLOR
                MENU_BGCOLOR <span class="hl opt">=</span> BGCOLOR
                MENU_SELECTCOLOR <span class="hl opt">=</span> SL_TEXTCOLOR
                MENU_SELECTBGCOLOR <span class="hl opt">=</span> SL_BGCOLOR
        }

        <span class="hl kwa">if</span> width <span class="hl opt">=</span> <span class="hl num">0</span>:  width <span class="hl opt">=</span> <span class="hl num">20</span>
        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>num; i<span class="hl opt">++</span>)          <span class="hl slc">! determine appropriate width</span>
<span class="hl ppc">#ifclear NO_AUX_MATH</span>
                width <span class="hl opt">=</span> higher(width, <span class="hl kwa">string</span>(_temp_string, menuitem[i]))
<span class="hl ppc">#else</span>
        {
                <span class="hl kwa">local</span> n
                n <span class="hl opt">=</span> <span class="hl kwa">string</span>(_temp_string, menuitem[i])
                <span class="hl kwa">if</span> n <span class="hl opt">&gt;</span> width:  width <span class="hl opt">=</span> n
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> width <span class="hl opt">&gt;</span> display.linelength<span class="hl opt">-</span><span class="hl num">1</span>:  width <span class="hl opt">=</span> display.linelength<span class="hl opt">-</span><span class="hl num">1</span>

        <span class="hl slc">! Default selection is 1 if not otherwise given</span>
        <span class="hl kwa">if</span> selection <span class="hl opt">=</span> <span class="hl num">0</span>:  selection <span class="hl opt">=</span> <span class="hl num">1</span>
        <span class="hl kwa">if</span> selection <span class="hl opt">&gt;</span> num:  selection <span class="hl opt">=</span> num

        column <span class="hl opt">=</span> display.linelength<span class="hl opt">/</span><span class="hl num">2</span> <span class="hl opt">-</span> width<span class="hl opt">/</span><span class="hl num">2</span>

        CenterTitle(menuitem[<span class="hl num">0</span>])        <span class="hl slc">! print title of menu</span>

        <span class="hl kwa">color</span> MENU_TEXTCOLOR, MENU_BGCOLOR
        Font(BOLD_OFF <span class="hl opt">|</span> ITALIC_OFF <span class="hl opt">|</span> UNDERLINE_OFF <span class="hl opt">|</span> PROP_OFF)
        Message(<span class="hl opt">&amp;</span>Menu, <span class="hl num">1</span>)               <span class="hl slc">! print key commands</span>

        <span class="hl kwa">for</span> (i<span class="hl opt">=</span><span class="hl num">1</span>; i<span class="hl opt">&lt;=</span>num; i<span class="hl opt">++</span>)          <span class="hl slc">! print menu choices</span>
        {
                <span class="hl kwa">color</span> MENU_TEXTCOLOR, MENU_BGCOLOR
                <span class="hl kwa">locate</span> column, (<span class="hl num">3</span><span class="hl opt">+</span>i)
                <span class="hl kwa">print</span> menuitem[i]; <span class="hl kwa">to</span> (column<span class="hl opt">+</span>width)
        }
        <span class="hl kwa">color</span> TEXTCOLOR, BGCOLOR

        <span class="hl kwa">while</span> <span class="hl kwc">true</span>                      <span class="hl slc">! continuous loop</span>
        {
                <span class="hl kwa">if</span> selection <span class="hl opt">~=</span> oldselection
                {
                        <span class="hl kwa">if</span> oldselection <span class="hl opt">~=</span> <span class="hl num">0</span>
                        {
                                <span class="hl kwa">locate</span> column, (<span class="hl num">3</span> <span class="hl opt">+</span> oldselection)
                                <span class="hl kwa">color</span> MENU_TEXTCOLOR, MENU_BGCOLOR
                                <span class="hl kwa">print</span> menuitem[oldselection]; <span class="hl kwa">to</span> (column<span class="hl opt">+</span>width)
                        }
                        <span class="hl kwa">color</span> MENU_SELECTCOLOR, MENU_SELECTBGCOLOR
                        <span class="hl kwa">locate</span> column, (<span class="hl num">3</span> <span class="hl opt">+</span> selection)
                        <span class="hl kwa">print</span> menuitem[selection]; <span class="hl kwa">to</span> (column<span class="hl opt">+</span>width)
                        <span class="hl kwa">color</span> TEXTCOLOR, BGCOLOR
                }
                <span class="hl kwa">locate</span> (column<span class="hl opt">+</span>width), (<span class="hl num">3</span> <span class="hl opt">+</span> selection)
                oldselection <span class="hl opt">=</span> selection
                <span class="hl kwa">pause</span>
                <span class="hl kwa">select</span> <span class="hl kwa">word</span>[<span class="hl num">0</span>]
                <span class="hl kwa">case</span> <span class="hl kwc">&#39;N&#39;</span>, <span class="hl kwc">&#39;n&#39;</span>, DOWN_ARROW, RIGHT_ARROW
                {
                        <span class="hl kwa">if</span> menuitem[<span class="hl opt">++</span>selection] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                                <span class="hl opt">++</span>selection
                        <span class="hl kwa">if</span> selection <span class="hl opt">&gt;</span> num:  selection <span class="hl opt">=</span> <span class="hl num">1</span>
                }
                <span class="hl kwa">case</span> <span class="hl kwc">&#39;P&#39;</span>, <span class="hl kwc">&#39;p&#39;</span>, UP_ARROW, LEFT_ARROW
                {
                        <span class="hl kwa">if</span> menuitem[<span class="hl opt">--</span>selection] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                                <span class="hl opt">--</span>selection

                        <span class="hl kwa">if</span> selection <span class="hl opt">=</span> <span class="hl num">0</span>:  selection <span class="hl opt">=</span> num
                }
                <span class="hl kwa">case</span> <span class="hl kwc">&#39;Q&#39;</span>, <span class="hl kwc">&#39;q&#39;</span>, ESCAPE_KEY
                {
                        <span class="hl kwa">window</span> <span class="hl num">1</span>:  <span class="hl kwa">cls</span>
                        Font(DEFAULT_FONT)
                        <span class="hl kwa">return</span> <span class="hl num">0</span>
                }
                <span class="hl kwa">case</span> ENTER_KEY
                {
                        <span class="hl kwa">window</span> <span class="hl num">1</span>:  <span class="hl kwa">cls</span>
                        Font(DEFAULT_FONT)
                        <span class="hl kwa">return</span> selection
                }

                <span class="hl kwa">if</span> <span class="hl kwa">word</span>[<span class="hl num">0</span>] <span class="hl opt">&gt;=</span> <span class="hl kwc">&#39;0&#39;</span> <span class="hl kwa">and</span> <span class="hl kwa">word</span>[<span class="hl num">0</span>] <span class="hl opt">&lt;=</span> <span class="hl kwc">&#39;9&#39;</span>
                {
                        i <span class="hl opt">=</span> <span class="hl kwa">word</span>[<span class="hl num">0</span>] <span class="hl opt">-</span> <span class="hl kwc">&#39;0&#39;</span>
                        <span class="hl kwa">if</span> i <span class="hl opt">=</span> <span class="hl num">0</span>:  i <span class="hl opt">=</span> <span class="hl num">10</span>

                        selection <span class="hl opt">=</span> <span class="hl num">1</span>
                        <span class="hl kwa">while</span> <span class="hl opt">--</span>i
                        {
                                selection<span class="hl opt">++</span>
                                <span class="hl kwa">if</span> menuitem[selection] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                                        selection<span class="hl opt">++</span>
                        }
                        <span class="hl kwa">if</span> selection <span class="hl opt">&gt;</span> num <span class="hl kwa">or</span> menuitem[selection] <span class="hl opt">=</span> <span class="hl str">&quot;&quot;</span>
                                selection <span class="hl opt">=</span> oldselection
                }
        }
}

<span class="hl kwa">routine</span> CenterTitle(a, lines)
{
        <span class="hl kwa">local</span> l

        <span class="hl kwa">if</span> lines <span class="hl opt">=</span> <span class="hl num">0</span>:  lines <span class="hl opt">=</span> <span class="hl num">1</span>

        <span class="hl kwa">if</span> MENU_SELECTCOLOR <span class="hl opt">=</span> <span class="hl num">0</span> <span class="hl kwa">and</span> MENU_SELECTBGCOLOR <span class="hl opt">=</span> <span class="hl num">0</span>  <span class="hl slc">! not set yet</span>
        {
                MENU_SELECTCOLOR <span class="hl opt">=</span> SL_TEXTCOLOR
                MENU_SELECTBGCOLOR <span class="hl opt">=</span> SL_BGCOLOR
        }

        Font(PROP_OFF)
        l <span class="hl opt">=</span> <span class="hl kwa">string</span>(_temp_string, a)
        <span class="hl kwa">window</span> <span class="hl num">0</span>                        <span class="hl slc">! remove previous window</span>
        <span class="hl kwa">window</span> lines
        {
                <span class="hl kwa">color</span> MENU_SELECTCOLOR, MENU_SELECTBGCOLOR
                <span class="hl kwa">cls</span>
                <span class="hl kwa">locate</span> (display.linelength<span class="hl opt">/</span><span class="hl num">2</span> <span class="hl opt">-</span> l<span class="hl opt">/</span><span class="hl num">2</span>), <span class="hl num">1</span>
                <span class="hl kwa">print</span> a;
        }
        <span class="hl kwa">color</span> TEXTCOLOR, BGCOLOR
        FONT(DEFAULT_FONT)
        <span class="hl kwa">cls</span>
        <span class="hl kwa">locate</span> <span class="hl num">1</span>, <span class="hl num">1</span>
}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_MENUS</span>
<span class="hl ppc"></span>
<span class="hl com">!\</span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com"></span>
<span class="hl com">FUSE AND DAEMON CLASSES AND ROUTINES</span>
<span class="hl com"></span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com">\!</span>

<span class="hl ppc">#ifclear NO_FUSES</span>

<span class="hl kwa">property</span> timer <span class="hl kwa">alias</span> n_to               <span class="hl slc">! for fuses only</span>
<span class="hl kwa">property</span> tick <span class="hl kwa">alias</span> ne_to               <span class="hl slc">!</span>

<span class="hl kwa">property</span> activate_event <span class="hl kwa">alias</span> when_open
<span class="hl kwa">property</span> deactivate_event <span class="hl kwa">alias</span> when_closed

<span class="hl kwa">class</span> fuse
{
        type fuse
        size <span class="hl num">0</span>
        timer <span class="hl num">0</span>
        in_scope <span class="hl num">0</span>
        tick
        {
                <span class="hl kwa">if</span> <span class="hl opt">--</span><span class="hl kwb">self</span>.timer <span class="hl opt">&lt;</span> <span class="hl num">0</span>
                        <span class="hl kwb">self</span>.timer <span class="hl opt">=</span> <span class="hl num">0</span>

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FUSES
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[Running fuse &quot;</span>; <span class="hl kwa">number</span> <span class="hl kwb">self</span>; <span class="hl str">&quot;:  timer = &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> <span class="hl kwb">self</span>.timer; <span class="hl str">&quot;]&quot;</span>
                }
<span class="hl ppc">#endif</span>

                <span class="hl kwa">if</span> <span class="hl kwb">self</span>.timer <span class="hl opt">=</span> <span class="hl num">0</span>
                        Deactivate(<span class="hl kwb">self</span>)
                <span class="hl kwa">return</span> <span class="hl kwb">self</span>.timer
        }
}

<span class="hl kwa">class</span> daemon
{
        type daemon
        size <span class="hl num">0</span>
        in_scope <span class="hl num">0</span>
}

<span class="hl kwa">routine</span> Activate(a, set)                <span class="hl slc">! &lt;set&gt; is for fuses only</span>
{
        <span class="hl kwa">local</span> err

        a.in_scope <span class="hl opt">=</span> <span class="hl kwb">player</span>
        a <span class="hl kwa">is</span> active
        <span class="hl kwa">if</span> a.type <span class="hl opt">=</span> fuse
        {
                <span class="hl kwa">if</span> set
                        a.timer <span class="hl opt">=</span> set

                <span class="hl kwa">run</span> a.activate_event
        }
        <span class="hl kwa">elseif</span> a.type <span class="hl opt">=</span> daemon
        {
                <span class="hl kwa">if</span> set <span class="hl kwa">and</span> <span class="hl kwa">not</span> a.<span class="hl ppc">#timer</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[WARNING:  Attempt to set nonexistent timer</span>
<span class="hl str">                                property on daemon (object &quot;</span>; <span class="hl kwa">number</span> a; <span class="hl str">&quot;)]&quot;</span>
                        err <span class="hl opt">=</span> <span class="hl kwc">true</span>
                }
                <span class="hl kwa">else</span>
                        a.timer <span class="hl opt">=</span> set

                <span class="hl kwa">run</span> a.activate_event
        }
        <span class="hl kwa">else</span>
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[WARNING:  Attempt to activate non-fuse/\</span>
<span class="hl str">                daemon (object &quot;</span>; <span class="hl kwa">number</span> a; <span class="hl str">&quot;)]&quot;</span>
                err <span class="hl opt">=</span> <span class="hl kwc">true</span>
        }

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FUSES <span class="hl kwa">and</span> <span class="hl kwa">not</span> err
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[Activating &quot;</span>; a.<span class="hl kwb">name</span>; <span class="hl str">&quot; &quot;</span>; <span class="hl kwa">number</span> a;
                <span class="hl kwa">if</span> a.type <span class="hl opt">=</span> fuse
                        <span class="hl kwa">print</span> <span class="hl str">&quot; (timer = &quot;</span>; <span class="hl kwa">number</span> a.timer; <span class="hl str">&quot;)&quot;</span>;
                <span class="hl kwa">print</span> <span class="hl str">&quot;]&quot;</span>
        }
<span class="hl ppc">#endif</span>

}

<span class="hl kwa">routine</span> Deactivate(a)
{
        <span class="hl kwa">local</span> err

        <span class="hl kwa">remove</span> a
        a.in_scope <span class="hl opt">=</span> <span class="hl num">0</span>
        a <span class="hl kwa">is</span> <span class="hl kwa">not</span> active

        <span class="hl kwa">if</span> a.type <span class="hl opt">~=</span> fuse <span class="hl kwa">and</span> a.type <span class="hl opt">~=</span> daemon
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[WARNING:  Attempt to deactivate non-fuse/\</span>
<span class="hl str">                        daemon (object &quot;</span>; <span class="hl kwa">number</span> a; <span class="hl str">&quot;)]&quot;</span>
                err <span class="hl opt">=</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">else</span>
        {
                <span class="hl kwa">run</span> a.deactivate_event
        }

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_FUSES <span class="hl kwa">and</span> <span class="hl kwa">not</span> err
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[Deactivating &quot;</span>; a.<span class="hl kwb">name</span>; <span class="hl str">&quot; &quot;</span>; <span class="hl kwa">number</span> a; <span class="hl str">&quot;]&quot;</span>
        }
<span class="hl ppc">#endif</span>

}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_FUSES</span>
<span class="hl ppc"></span>

<span class="hl com">!\</span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com"></span>
<span class="hl com">CHARACTER SCRIPT ROUTINES</span>
<span class="hl com"></span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com">\!</span>

<span class="hl ppc">#ifclear NO_SCRIPTS</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Script(character, number of steps)</span>
<span class="hl slc">! initializes space for the script, and returns its location in the</span>
<span class="hl slc">! setscript array; returns -1 if MAX_SCRIPTS is exceeded</span>
<span class="hl slc">!</span>
<span class="hl slc">! SYNTAX:  setscript[script(char, steps)] =  &amp;CharRoutine1, object1,</span>
<span class="hl slc">!                                            &amp;CharRoutine2, object2,</span>
<span class="hl slc">!                                            ...</span>
<span class="hl slc">!                                            (maximum of 32 steps)</span>

<span class="hl kwa">routine</span> Script(obj, steps)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">while</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">~=</span> obj <span class="hl kwa">and</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">~=</span> <span class="hl num">0</span> <span class="hl kwa">and</span>
                o <span class="hl opt">&lt;</span> MAX_SCRIPTS
        {
                o<span class="hl opt">++</span>
        }
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span> <span class="hl opt">-</span><span class="hl num">1</span>
        <span class="hl kwa">if</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">=</span> <span class="hl num">0</span>
        {
                scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">=</span> obj                <span class="hl slc">! the object</span>
                number_scripts<span class="hl opt">++</span>
        }
        scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl num">0</span>                       <span class="hl slc">! starting step</span>
        scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">=</span> steps                   <span class="hl slc">! total no. of steps</span>
        <span class="hl kwa">return</span> o <span class="hl opt">*</span> MAX_SCRIPTS <span class="hl opt">*</span> <span class="hl num">2</span>
}

<span class="hl kwa">routine</span> FindScript(obj)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">while</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">~=</span> obj <span class="hl kwa">and</span> o <span class="hl opt">&lt;</span> MAX_SCRIPTS:  o<span class="hl opt">++</span>
        <span class="hl kwa">return</span> o
}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_SCRIPTS</span>
<span class="hl ppc"></span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! RunScripts</span>
<span class="hl slc">! runs all active character scripts via:  CharRoutine(character, object)</span>

<span class="hl kwa">routine</span> RunScripts
{

<span class="hl ppc">#ifclear NO_SCRIPTS</span>

        <span class="hl kwa">local</span> a, obj, <span class="hl kwa">step</span>, total, <span class="hl kwa">routine</span>, b
        <span class="hl kwa">local</span> tempactor, tempverb, tempobject

        <span class="hl kwa">for</span> (; a<span class="hl opt">&lt;</span>number_scripts; a<span class="hl opt">++</span>)
        {
                obj <span class="hl opt">=</span> scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span>]         <span class="hl slc">! this object/character</span>
                <span class="hl kwa">step</span> <span class="hl opt">=</span> scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>]    <span class="hl slc">! current step</span>
                total <span class="hl opt">=</span> scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>]   <span class="hl slc">! total steps in script</span>

                <span class="hl kwa">if</span> obj <span class="hl kwa">and</span> total <span class="hl opt">&lt;</span> <span class="hl num">0</span>            <span class="hl slc">! if skipping this script</span>
                        scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">=</span> scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">+</span> <span class="hl num">32767</span>

                <span class="hl kwa">elseif</span> obj <span class="hl kwa">and</span> <span class="hl kwa">step</span> <span class="hl opt">&lt;</span> total <span class="hl kwa">and</span> <span class="hl kwa">step</span> <span class="hl opt">&gt;=</span> <span class="hl num">0</span>
                {
                        <span class="hl slc">! action</span>
                        <span class="hl kwa">routine</span> <span class="hl opt">=</span> setscript[a <span class="hl opt">*</span> MAX_SCRIPT_STEPS <span class="hl opt">+</span> <span class="hl kwa">step</span> <span class="hl opt">*</span> <span class="hl num">2</span>]

                        <span class="hl slc">! object being acted upon</span>
                        b <span class="hl opt">=</span> setscript[a <span class="hl opt">*</span> MAX_SCRIPT_STEPS <span class="hl opt">+</span> <span class="hl kwa">step</span> <span class="hl opt">*</span> <span class="hl num">2</span> <span class="hl opt">+</span> <span class="hl num">1</span>]

<span class="hl ppc">#ifset DEBUG</span>
                        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;[Script for obj. &quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;), step &quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl kwa">number</span> (<span class="hl kwa">step</span> <span class="hl opt">+</span> <span class="hl num">1</span>); <span class="hl str">&quot;:  $&quot;</span>; \
                                <span class="hl kwa">hex</span> <span class="hl kwa">routine</span>; <span class="hl str">&quot;, obj. &quot;</span>;
                                <span class="hl kwa">print</span> <span class="hl kwa">number</span> b; <span class="hl str">&quot; (&quot;</span>; b.<span class="hl kwb">name</span>; <span class="hl str">&quot;)]&quot;</span>
                        }
<span class="hl ppc">#endif</span>

                        scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl kwa">step</span> <span class="hl opt">+</span> <span class="hl num">1</span>
                        tempactor <span class="hl opt">=</span> <span class="hl kwb">actor</span>
                        tempverb <span class="hl opt">=</span> <span class="hl kwb">verbroutine</span>
                        tempobject <span class="hl opt">=</span> <span class="hl kwb">object</span>
                        <span class="hl kwb">actor</span> <span class="hl opt">=</span> obj
                        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> <span class="hl kwa">routine</span>
                        <span class="hl kwb">object</span> <span class="hl opt">=</span> b
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwa">parent</span>(<span class="hl kwb">actor</span>).<span class="hl kwb">before</span>
                        {
                                <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwb">actor</span>.<span class="hl kwb">before</span>
                                {
                                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> <span class="hl kwb">object</span>.<span class="hl kwb">before</span>
                                        {
                                                <span class="hl kwa">call</span> <span class="hl kwa">routine</span>(obj, b)
                                                <span class="hl kwa">run</span> <span class="hl kwb">actor</span>.<span class="hl kwb">after</span>
                                        }
                                }
                        }
                        <span class="hl kwa">if</span> <span class="hl kwb">actor</span> <span class="hl kwa">in</span> <span class="hl kwb">location</span>:  <span class="hl kwb">actor</span> <span class="hl kwa">is</span> known
                        <span class="hl kwb">actor</span> <span class="hl opt">=</span> tempactor
                        <span class="hl kwb">verbroutine</span> <span class="hl opt">=</span> tempverb
                        <span class="hl kwb">object</span> <span class="hl opt">=</span> tempobject
                }
                <span class="hl kwa">elseif</span> <span class="hl kwa">step</span> <span class="hl opt">&gt;=</span> <span class="hl num">0</span>
                {
                        scriptdata[a <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">=</span> <span class="hl num">0</span>   <span class="hl slc">! clear this object&#39;s script</span>
                        <span class="hl kwa">if</span> a <span class="hl opt">=</span> number_scripts <span class="hl opt">-</span> <span class="hl num">1</span>
                                number_scripts<span class="hl opt">--</span>
                }
        }

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_SCRIPTS</span>
<span class="hl ppc"></span>
}

<span class="hl ppc">#ifclear NO_SCRIPTS</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CancelScript(char)</span>
<span class="hl slc">! immediately halts execution of the script for &lt;char&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! PauseScript(char)</span>
<span class="hl slc">! suspends execution of the script for &lt;char&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! ResumeScript(char)</span>
<span class="hl slc">! resumes execution of a paused script</span>
<span class="hl slc">!</span>
<span class="hl slc">! SkipScript(char)</span>
<span class="hl slc">! skips &lt;char&gt;&#39;s script only for the next call to RunScripts</span>

<span class="hl kwa">routine</span> CancelScript(obj)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> FindScript(obj)
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span>
        scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">=</span> <span class="hl num">0</span>
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> number_scripts <span class="hl opt">-</span> <span class="hl num">1</span>
                number_scripts<span class="hl opt">--</span>

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[Script for obj. &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;) &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;cancelled]&quot;</span>
                }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}

<span class="hl kwa">routine</span> PauseScript(obj)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> FindScript(obj)
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span>
        <span class="hl kwa">if</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">&gt;=</span> <span class="hl num">0</span>           <span class="hl slc">! current step</span>
        {
                scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">=</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">-</span> <span class="hl num">32767</span>

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[Script for obj. &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;) &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;paused]&quot;</span>
                }
<span class="hl ppc">#endif</span>

                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
}

<span class="hl kwa">routine</span> ResumeScript(obj)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> FindScript(obj)
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span>
        <span class="hl kwa">if</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">&lt;</span> <span class="hl num">0</span>            <span class="hl slc">! current step</span>
        {
                scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">=</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">+</span> <span class="hl num">32767</span>

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[Script for obj. &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;) &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;resumed]&quot;</span>
                }
<span class="hl ppc">#endif</span>

                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
}

<span class="hl kwa">routine</span> SkipScript(obj)
{
        <span class="hl kwa">local</span> o

        o <span class="hl opt">=</span> FindScript(obj)
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span>
        <span class="hl kwa">if</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">&gt;=</span> <span class="hl num">0</span>           <span class="hl slc">! total number of steps</span>
        {
                scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">=</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">2</span>] <span class="hl opt">-</span> <span class="hl num">32767</span>

<span class="hl ppc">#ifset DEBUG</span>
                <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;[Skipping script for obj. &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;)]&quot;</span>
                }
<span class="hl ppc">#endif</span>

                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
}


<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! BASIC CHARACTER VERB ROUTINES:</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! LoopScript</span>
<span class="hl slc">! may be used in a script to repeatedly return to the starting step; the</span>
<span class="hl slc">! usage is:  &amp;LoopScript, 0</span>

<span class="hl kwa">routine</span> LoopScript(obj)
{
        <span class="hl kwa">local</span> o

        <span class="hl kwa">while</span> scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span>] <span class="hl opt">~=</span> obj <span class="hl kwa">and</span> o <span class="hl opt">&lt;</span> MAX_SCRIPTS:  o<span class="hl opt">++</span>
        <span class="hl kwa">if</span> o <span class="hl opt">=</span> MAX_SCRIPTS
                <span class="hl kwa">return</span>
        scriptdata[o <span class="hl opt">*</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl num">1</span>] <span class="hl opt">=</span> <span class="hl num">0</span>

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[Looping script for obj. &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl kwa">number</span> obj; <span class="hl str">&quot; (&quot;</span>; obj.<span class="hl kwb">name</span>; <span class="hl str">&quot;)]&quot;</span>
        }
<span class="hl ppc">#endif</span>

}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CharWait</span>
<span class="hl slc">! Script usage: &amp;CharWait, 0</span>

<span class="hl kwa">routine</span> CharWait(char)
{

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[&quot;</span>; CThe(char); IsorAre(char, <span class="hl kwc">true</span>); <span class="hl str">&quot; waiting in:  &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> <span class="hl kwa">parent</span>(char).<span class="hl kwb">name</span>; <span class="hl str">&quot;.]&quot;</span>
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CharMove</span>
<span class="hl slc">! Script usage:  &amp;CharMove, &lt;direction object&gt;</span>

<span class="hl kwa">routine</span> CharMove(char, dir)
{
<span class="hl ppc">#ifclear NO_OBJLIB</span>

        <span class="hl kwa">local</span> newroom

        general <span class="hl opt">=</span> <span class="hl num">1</span>                     <span class="hl slc">! for signalling a character move</span>
                                        <span class="hl slc">! to, for example, door.door_to</span>

        newroom <span class="hl opt">=</span> <span class="hl kwa">parent</span>(char).(dir.dir_to)

        <span class="hl kwa">if</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span> <span class="hl kwa">and</span> general <span class="hl opt">=</span> <span class="hl num">1</span>     <span class="hl slc">! door.door_to sets general</span>
                                                <span class="hl slc">! to 2 if it prints a message</span>
        {
                Message(<span class="hl opt">&amp;</span>CharMove, <span class="hl num">1</span>, char, dir)
                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">elseif</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span>
                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>

        <span class="hl kwa">move</span> char <span class="hl kwa">to</span> newroom

<span class="hl ppc">#ifset DEBUG</span>
        <span class="hl kwa">if</span> debug_flags <span class="hl opt">&amp;</span> D_SCRIPTS
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[&quot;</span>; CThe(char); IsorAre(char, <span class="hl kwc">true</span>); <span class="hl str">&quot; now in:  &quot;</span>;
                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> <span class="hl kwa">parent</span>(char).<span class="hl kwb">name</span>; <span class="hl str">&quot;.]&quot;</span>
        }
<span class="hl ppc">#endif</span>

        <span class="hl kwa">if</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span> <span class="hl kwa">and</span> general <span class="hl opt">=</span> <span class="hl num">1</span>
        {
                Message(<span class="hl opt">&amp;</span>CharMove, <span class="hl num">2</span>, char, dir)
                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">elseif</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span>
                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>

        general <span class="hl opt">=</span> <span class="hl num">0</span>                     <span class="hl slc">! always reset it</span>

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_OBJLIB</span>
<span class="hl ppc"></span>
        <span class="hl kwa">run</span> <span class="hl kwa">parent</span>(char).<span class="hl kwb">after</span>

        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CharGet</span>
<span class="hl slc">! Script usage:  &amp;CharGet, &lt;object&gt;</span>

<span class="hl kwa">routine</span> CharGet(char, obj)
{
        <span class="hl kwa">if</span> FindObject(obj, <span class="hl kwa">parent</span>(char)) <span class="hl opt">=</span> <span class="hl num">1</span>
        {
                <span class="hl kwa">if</span> Acquire(char, obj)
                {
                        <span class="hl kwa">if</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span>
                        {
                                Message(<span class="hl opt">&amp;</span>CharGet, <span class="hl num">1</span>, char, obj)
                                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
                        }
                }
                <span class="hl kwa">return</span> <span class="hl kwc">true</span>
        }
}

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! CharDrop</span>
<span class="hl slc">! Script usage:  &amp;CharDrop, &lt;object&gt;</span>

<span class="hl kwa">routine</span> CharDrop(char, obj)
{
        <span class="hl kwa">move</span> obj <span class="hl kwa">to</span> <span class="hl kwa">parent</span>(char)
        char.holding <span class="hl opt">=</span> char.holding <span class="hl opt">-</span> obj.size
        <span class="hl kwa">if</span> char <span class="hl kwa">in</span> <span class="hl kwb">location</span>
        {
                Message(<span class="hl opt">&amp;</span>CharDrop, <span class="hl num">1</span>, char, obj)
                event_flag <span class="hl opt">=</span> <span class="hl kwc">true</span>
        }
        <span class="hl kwa">return</span> <span class="hl kwc">true</span>
}

<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_SCRIPTS</span>
<span class="hl ppc"></span>

<span class="hl com">!\</span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com"></span>
<span class="hl com">LIBRARY MESSAGES</span>
<span class="hl com"></span>
<span class="hl com">Most of the text printed by the library is generated by the Message routine.</span>
<span class="hl com">To replace all of the default responses, replace the Message routine.  To</span>
<span class="hl com">replace one or more responses, replace the NewMessages routine, and return</span>
<span class="hl com">true for any replacement message that is provided; if NewMessages returns a</span>
<span class="hl com">false value, Message prints the default response.</span>
<span class="hl com"></span>
<span class="hl com">NOTE:  Other routines in HUGOLIB.H that print text independent of the</span>
<span class="hl com">Message routine are:  PrintEndGame, PrintScore, ParseError, PrintStatusLine,</span>
<span class="hl com">HoursMinutes, The, CThe, Art, CArt, IsorAre, MatchSubject, NumberWord,</span>
<span class="hl com">DigitWord, DarkWarning, ObjectIs, and various debugging messages.</span>
<span class="hl com"></span>
<span class="hl com">*****************************************************************************</span>
<span class="hl com">\!</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Message(&amp;routine, number)</span>
<span class="hl slc">! prints message &lt;number&gt; for &lt;routine&gt;</span>
<span class="hl slc">!</span>
<span class="hl slc">! Message (&amp;routine, number, var1, var2)</span>
<span class="hl slc">! where one or two variables--which may be objects or any other value--</span>
<span class="hl slc">! are used by message &lt;number&gt; for &lt;routine&gt;</span>

<span class="hl kwa">routine</span> Message(r, num, a, b)
{
        <span class="hl slc">! Check first to see if the NewMessages routine provides a</span>
        <span class="hl slc">! replacement message:</span>
        <span class="hl kwa">if</span> NewMessages(r, num, a, b):  <span class="hl kwa">return</span>

        <span class="hl kwa">select</span> r

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>EndGame
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">The game has ended.  Do you want to (R)ESTART,</span>
<span class="hl str">                                R(E)STORE a saved game, &quot;</span>;
<span class="hl ppc">#ifclear NO_UNDO</span>
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> UNDO_OFF         <span class="hl slc">! if not otherwise overridden</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;(U)NDO your last turn, &quot;</span>;
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;or (Q)UIT? &quot;</span>;
                }
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Enter (R)ESTART, R(E)STORE, &quot;</span>;
<span class="hl ppc">#ifclear NO_UNDO</span>
                        <span class="hl kwa">if</span> <span class="hl kwa">not</span> UNDO_OFF
                                <span class="hl kwa">print</span> <span class="hl str">&quot;(U)NDO, &quot;</span>;
<span class="hl ppc">#endif</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;or (Q)UIT: &quot;</span>;
                }
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>Parse
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>:  <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); \
                                MatchPlural(<span class="hl kwb">player</span>, <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                <span class="hl str">&quot; need to refer to that.&quot;</span>
                <span class="hl kwa">case</span> <span class="hl num">2</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;(assuming you mean&quot;</span>;
                <span class="hl kwa">case</span> <span class="hl num">3</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;, respectively&quot;</span>;
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>Speakto
        {
                <span class="hl kwa">if</span> a <span class="hl opt">=</span> <span class="hl num">0</span>:  a <span class="hl opt">=</span> <span class="hl kwb">object</span>   <span class="hl slc">! Speakto messages are sometimes</span>
                                        <span class="hl slc">! co-opted by verb routines</span>
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>:  <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); <span class="hl str">&quot; probably ought not to waste</span>
<span class="hl str">                                time talking to &quot;</span>; <span class="hl kwb">player</span>.pronoun <span class="hl ppc">#4;</span> <span class="hl pps">&quot;.&quot;</span><span class="hl ppc"></span>
                <span class="hl kwa">case</span> <span class="hl num">2</span>:  <span class="hl kwa">print</span> CThe(a); IsorAre(a, <span class="hl kwc">true</span>); <span class="hl str">&quot; listening.&quot;</span>
                <span class="hl kwa">case</span> <span class="hl num">3</span>:  <span class="hl kwa">print</span> CThe(a); <span class="hl str">&quot; nod&quot;</span>; MatchSubject(a); \
                                <span class="hl str">&quot; hello to &quot;</span>; The(<span class="hl kwb">player</span>, <span class="hl kwc">true</span>); <span class="hl str">&quot;.&quot;</span>
                <span class="hl kwa">case</span> <span class="hl num">4</span>:  <span class="hl kwa">print</span> CThe(a); <span class="hl str">&quot; ignore&quot;</span>; MatchSubject(a); <span class="hl str">&quot; &quot;</span>; \
                                The(<span class="hl kwb">player</span>, <span class="hl kwc">true</span>); <span class="hl str">&quot;.&quot;</span>
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>DescribePlace
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;It&#39;s too dark to see anything.&quot;</span>
                <span class="hl kwa">case</span> <span class="hl num">2</span>:  <span class="hl kwa">print</span> <span class="hl str">&quot;There&quot;</span>; IsorAre(a, <span class="hl kwc">true</span>); <span class="hl str">&quot; &quot;</span>; Art(a); \
                                <span class="hl str">&quot; here.&quot;</span>
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>WhatsIn
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>
                {
                        <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); IsorAre(<span class="hl kwb">player</span>, <span class="hl kwc">true</span>); <span class="hl str">&quot; &quot;</span>;
                        <span class="hl kwa">if</span> list_count <span class="hl opt">&lt;</span> a
                                <span class="hl kwa">print</span> <span class="hl str">&quot;also &quot;</span>;
                        <span class="hl kwa">print</span> <span class="hl str">&quot;carrying&quot;</span>;
                }
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                {
                        <span class="hl kwa">if</span> FORMAT <span class="hl opt">&amp;</span> USECHARNAMES_F
                                CThe(a)
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> a.pronoun;
                        <span class="hl kwa">if</span> list_count <span class="hl opt">&lt;</span> b
                                <span class="hl kwa">print</span> <span class="hl str">&quot; also&quot;</span>;
                        <span class="hl kwa">print</span> MatchPlural(a, <span class="hl str">&quot;has&quot;</span>, <span class="hl str">&quot;have&quot;</span>);
                }
                <span class="hl kwa">case</span> <span class="hl num">3</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Also &quot;</span>;
                        <span class="hl kwa">if</span> a.prep
                                <span class="hl kwa">print</span> a.prep; <span class="hl str">&quot; &quot;</span>;
                        <span class="hl kwa">elseif</span> a <span class="hl kwa">is</span> platform
                                <span class="hl kwa">print</span> <span class="hl str">&quot;sitting on &quot;</span>;
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;inside &quot;</span>;
                }
                <span class="hl kwa">case</span> <span class="hl num">4</span>
                {
                        <span class="hl kwa">if</span> a.prep
                                <span class="hl kwa">print</span> <span class="hl kwa">capital</span> a.prep; <span class="hl str">&quot; &quot;</span>;
                        <span class="hl kwa">elseif</span> a <span class="hl kwa">is</span> platform
                                <span class="hl kwa">print</span> <span class="hl str">&quot;Sitting on &quot;</span>;
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;Inside &quot;</span>;
                }
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>CheckReach
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Except that &quot;</span>; The(<span class="hl kwa">parent</span>(a)); \
                                MatchPlural(<span class="hl kwa">parent</span>(a), <span class="hl str">&quot;has&quot;</span>, <span class="hl str">&quot;have&quot;</span>); \
                                <span class="hl str">&quot; &quot;</span>; The(a); <span class="hl str">&quot;.&quot;</span>
                }
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Except that &quot;</span>; The(<span class="hl kwa">parent</span>(a)); \
                                MatchPlural(<span class="hl kwa">parent</span>(a), <span class="hl str">&quot;doesn&#39;t&quot;</span>, <span class="hl str">&quot;don&#39;t&quot;</span>); \
                                <span class="hl str">&quot; want to give &quot;</span>; The(<span class="hl kwb">player</span>, <span class="hl kwc">true</span>); \
                                <span class="hl str">&quot; &quot;</span>; The(a); <span class="hl str">&quot;.&quot;</span>
                }
                <span class="hl kwa">case</span> <span class="hl num">3</span>:  <span class="hl kwa">print</span> CThe(<span class="hl kwb">player</span>); <span class="hl str">&quot; can&#39;t reach &quot;</span>; The(a); \
                                <span class="hl str">&quot; from &quot;</span>; The(<span class="hl kwa">parent</span>(<span class="hl kwb">player</span>)); <span class="hl str">&quot;.&quot;</span>
        }

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>YesorNo
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;Please answer YES or NO: &quot;</span>;
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                        <span class="hl kwa">print</span> <span class="hl str">&quot;YES or NO: &quot;</span>;
        }

<span class="hl ppc">#ifclear NO_MENUS</span>
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>Menu
        {
                <span class="hl kwa">print</span> <span class="hl str">&quot;[N]ext item&quot;</span>; <span class="hl kwa">to</span> (display.linelength <span class="hl opt">-</span> <span class="hl num">11</span>); \
                        <span class="hl str">&quot;[Q]uit menu&quot;</span>
                <span class="hl kwa">print</span> <span class="hl str">&quot;[P]revious item&quot;</span>; <span class="hl kwa">to</span> (display.linelength <span class="hl opt">-</span> <span class="hl num">17</span>);
                <span class="hl kwa">print</span> <span class="hl str">&quot;[Enter] to select&quot;</span>
        }
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifclear NO_SCRIPTS</span>
<span class="hl ppc">#ifclear NO_OBJLIB</span>
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>CharMove
        {
                <span class="hl kwa">select</span> num
                <span class="hl kwa">case</span> <span class="hl num">1</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>; CThe(a); <span class="hl str">&quot; head&quot;</span>; MatchSubject(a); <span class="hl str">&quot; &quot;</span>;
                        <span class="hl kwa">if</span> b <span class="hl opt">=</span> u_obj <span class="hl kwa">or</span> b <span class="hl opt">=</span> d_obj
                                <span class="hl kwa">print</span> b.<span class="hl kwb">name</span>; <span class="hl str">&quot;ward.&quot;</span>
                        <span class="hl kwa">else</span>
                        {
                                <span class="hl kwa">print</span> <span class="hl str">&quot;off to the &quot;</span>;
                                <span class="hl kwa">print</span> b.<span class="hl kwb">name</span>; <span class="hl str">&quot;.&quot;</span>
                        }
                }
                <span class="hl kwa">case</span> <span class="hl num">2</span>
                {
                        <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>; CThe(a); <span class="hl str">&quot; arrive&quot;</span>; MatchSubject(a); \
                                <span class="hl str">&quot; from &quot;</span>;
                        <span class="hl kwa">if</span> b <span class="hl opt">~=</span> u_obj <span class="hl kwa">and</span> b <span class="hl opt">~=</span> d_obj
                                <span class="hl kwa">print</span> <span class="hl str">&quot;the &quot;</span>; (b.dir_from).<span class="hl kwb">name</span>; <span class="hl str">&quot;.&quot;</span>
                        <span class="hl kwa">elseif</span> b <span class="hl opt">=</span> u_obj
                                <span class="hl kwa">print</span> <span class="hl str">&quot;below.&quot;</span>
                        <span class="hl kwa">else</span>
                                <span class="hl kwa">print</span> <span class="hl str">&quot;above.&quot;</span>
                }
        }
<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_OBJLIB</span>
<span class="hl ppc"></span>
        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>CharGet:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>; CThe(a); <span class="hl str">&quot; pick&quot;</span>; MatchSubject(a); \
                        <span class="hl str">&quot; up &quot;</span>; The(b); <span class="hl str">&quot;.&quot;</span>

        <span class="hl kwa">case</span> <span class="hl opt">&amp;</span>CharDrop:  <span class="hl kwa">print</span> <span class="hl str">&quot;</span><span class="hl esc">\n</span><span class="hl str">&quot;</span>; CThe(a); <span class="hl str">&quot; put&quot;</span>; MatchSubject(a); \
                        <span class="hl str">&quot; down &quot;</span>; The(b); <span class="hl str">&quot;.&quot;</span>
<span class="hl ppc">#endif</span>  <span class="hl slc">! ifclear NO_SCRIPTS</span>
<span class="hl ppc"></span>}

<span class="hl kwa">routine</span> NewMessages(r, num, a, b)       <span class="hl slc">! The NewMessages routine may be</span>
{                                       <span class="hl slc">! replaced, and should return true</span>
        <span class="hl kwa">return</span> <span class="hl kwc">false</span>                    <span class="hl slc">! if a replacement message &lt;num&gt;</span>
}                                       <span class="hl slc">! exists for routine &lt;r&gt;</span>


<span class="hl ppc">#set _COMPILING_HUGOLIB</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Include verb library</span>

<span class="hl ppc">#include</span> <span class="hl pps">&quot;verblib.h&quot;</span><span class="hl ppc"></span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Include verb stub routines if specified</span>

<span class="hl ppc">#ifset VERBSTUBS</span>
<span class="hl ppc">#include</span> <span class="hl pps">&quot;verbstub.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#endif</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Include object library unless otherwise specified</span>

<span class="hl ppc">#ifclear NO_OBJLIB</span>
<span class="hl ppc">#include</span> <span class="hl pps">&quot;objlib.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#endif</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! Include debugging routines if specified</span>

<span class="hl ppc">#ifset DEBUG</span>
<span class="hl ppc">#include</span> <span class="hl pps">&quot;hugofix.h&quot;</span><span class="hl ppc"></span>
<span class="hl ppc">#endif</span>

<span class="hl ppc">#ifset DEBUG</span>
<span class="hl kwb">object</span> last_library_object
{}
<span class="hl ppc">#endif</span>

<span class="hl ppc">#clear _COMPILING_HUGOLIB</span>

<span class="hl slc">!----------------------------------------------------------------------------</span>
<span class="hl slc">! NOTE:  In addition to the flags VERBSTUBS and DEBUG which are used to</span>
<span class="hl slc">! include additional library files, a number of compiler flags can be set</span>
<span class="hl slc">! to exclude portions of HUGOLIB.H.  These are:  NO_AUX_MATH, NO_FONTS,</span>
<span class="hl slc">! NO_FUSES, NO_MENUS, NO_OBJLIB, NO_RECORDING, NO_SCRIPTS, NO_STRING_ARRAYS,</span>
<span class="hl slc">! NO_VERBS, and NO_XVERBS.</span>
<span class="hl slc">!----------------------------------------------------------------------------</span>

<span class="hl ppc">#endif</span>  <span class="hl slc">! _HUGOLIB_H</span><span class="hl ppc"></span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.54, http://www.andre-simon.de/-->
